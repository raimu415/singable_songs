<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>„Çâ„ÅÑ„ÇÄ„ÅÆÊ≠å„Åà„ÇãÊõ≤„É™„Çπ„Éà - ULTIMATE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, onValue, push, set, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD8ZxrKxhL3HXmX6yXiFEAd91kzb5YX_lw",
      authDomain: "raimu-song-list-79b52.firebaseapp.com",
      databaseURL: "https://raimu-song-list-79b52-default-rtdb.firebaseio.com",
      projectId: "raimu-song-list-79b52",
      storageBucket: "raimu-song-list-79b52.firebasestorage.app",
      messagingSenderId: "242038202194",
      appId: "1:242038202194:web:81cd18eb19e8c91084648b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    window.db = db; window.dbRef = ref; window.dbOnValue = onValue; window.dbPush = push; window.dbSet = set; window.dbRunTransaction = runTransaction;
  </script>

<style>
/* =========================================================
   CORE STYLES
========================================================= */
:root {
  --text-main: #e5e7eb; --text-sub: #9ca3af;
  --accent: #60a5fa; --neon-pink: #ec4899; --neon-blue: #60a5fa;
  --bg-color: #000;
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { margin: 0; font-family: "Segoe UI", sans-serif; color: var(--text-main); background: var(--bg-color); overflow-x: hidden; user-select: none; transition: filter 0.3s; }

/* RGB GAMING MODE */
body.rgb-mode {
  animation: rgbCycle 5s linear infinite;
}
@keyframes rgbCycle {
  0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); }
}

/* LAYERS */
#matrix-canvas, #cursor-canvas, #danmaku-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
#matrix-canvas { z-index: -10; opacity: 0.3; }
#cursor-canvas { z-index: 9990; mix-blend-mode: screen; }
#danmaku-canvas { z-index: 9995; text-shadow: 2px 2px 0 #000; }

/* REALTIME VISUALIZER */
#realtime-viz {
  position: fixed; bottom: 0; left: 0; width: 100%; height: 300px;
  z-index: -5; pointer-events: none; opacity: 0.8;
  mask-image: linear-gradient(to top, black, transparent);
}

/* UI CONTAINER */
.container { max-width: 960px; margin: 0 auto; padding: 16px 14px 100px; position: relative; z-index: 10; }

/* HEADER */
header { position: sticky; top: 0; padding: 8px 0 10px; z-index: 30; }
.header-inner { padding: 16px; background: rgba(15, 23, 42, 0.9); border-radius: 20px; border: 1px solid rgba(96, 165, 250, 0.3); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); backdrop-filter: blur(10px); }
h1 { margin: 0; font-size: 1.9rem; text-align: center; font-weight: 900; letter-spacing: 0.15em; color: #fff; text-shadow: 0 0 10px var(--neon-blue); }

/* CONTROLS */
.controls-toggle, .filter-btn, .search-box input, .sort-select { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(148, 163, 184, 0.5); color: var(--text-main); border-radius: 999px; transition: all 0.2s; }
.filter-btn.active { background: linear-gradient(135deg, var(--neon-blue), var(--neon-pink)); border-color: transparent; color: #fff; box-shadow: 0 0 15px var(--neon-blue); }
.controls { max-height: 500px; overflow: hidden; transition: 0.3s ease; }
.controls.collapsed { max-height: 0; opacity: 0; pointer-events: none; }

/* CARDS */
.song-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px; margin-top: 20px; }
.song-card { position: relative; padding: 16px 20px; border-radius: 16px; background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(96, 165, 250, 0.3); backdrop-filter: blur(5px); transform-style: preserve-3d; transition: transform 0.1s, box-shadow 0.2s; animation: fadeUp 0.5s ease forwards; opacity: 0; }
.song-card:hover { border-color: var(--neon-blue); box-shadow: 0 0 20px rgba(96, 165, 250, 0.6); }
@keyframes fadeUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
.song-title { font-size: 1.1rem; font-weight: 900; text-shadow: 0 0 10px var(--neon-blue); }
.btn-like { display: inline-flex; align-items: center; gap: 6px; background: rgba(244, 63, 94, 0.15); color: #fda4af; border: 1px solid rgba(244, 63, 94, 0.5); padding: 5px 12px; border-radius: 999px; cursor: pointer; transition: 0.2s; }
.btn-like:hover { background: rgba(244, 63, 94, 0.8); color: #fff; transform: scale(1.1); }
.btn-like.liked-done { background: #f43f5e; color: #fff; pointer-events: none; opacity: 0.8; }

/* ACTION BUTTONS */
.special-btns { display: flex; gap: 10px; justify-content: center; margin: 10px 0; flex-wrap: wrap; }
.cyber-btn { background: rgba(0,0,0,0.6); border: 1px solid var(--neon-blue); color: var(--neon-blue); padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; }
.cyber-btn:hover { background: var(--neon-blue); color: #000; box-shadow: 0 0 15px var(--neon-blue); }
.rgb-btn { border-color: var(--neon-pink); color: var(--neon-pink); }
.rgb-btn:hover { background: var(--neon-pink); color: #fff; box-shadow: 0 0 15px var(--neon-pink); }

/* DANMAKU INPUT AREA */
#danmaku-area {
  position: fixed; bottom: 20px; right: 20px; z-index: 2000;
  background: rgba(0,0,0,0.8); padding: 10px; border-radius: 12px; border: 1px solid var(--accent);
  display: flex; gap: 8px; backdrop-filter: blur(5px);
  transform: translateY(150%); transition: transform 0.3s;
}
#danmaku-area.show { transform: translateY(0); }
#danmaku-input { background: #111; border: 1px solid #555; color: #fff; padding: 6px; border-radius: 4px; width: 150px; }

/* GALAXY MODE */
#galaxy-container { position: fixed; inset: 0; background: #000; z-index: 9000; opacity: 0; pointer-events: none; transition: opacity 0.5s; }
#galaxy-container.active { opacity: 1; pointer-events: auto; z-index: 99999; }
#galaxy-ui { position: absolute; top: 20px; left: 20px; z-index: 100000; }
#star-tooltip { position: absolute; top:0; left:0; background: rgba(15, 23, 42, 0.9); border: 1px solid var(--neon-pink); padding: 10px; border-radius: 8px; color: #fff; pointer-events: none; opacity: 0; z-index: 100001; }

/* RED ALERT */
body.red-alert::before { content: "‚ö†Ô∏è EMERGENCY ‚ö†Ô∏è"; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 15vw; font-weight: 900; color: rgba(255, 0, 0, 0.2); pointer-events: none; animation: warningPulse 0.5s infinite; }
body.red-alert { filter: sepia(1) hue-rotate(-50deg) saturate(5) !important; }
@keyframes warningPulse { 0%{opacity:0.1} 100%{opacity:0.5} }

/* UTILS */
.modal-overlay { position: fixed; inset:0; background:rgba(0,0,0,0.8); z-index:100; display:flex; justify-content:center; align-items:center; opacity:0; pointer-events:none; transition:0.3s; }
.modal-overlay.show { opacity:1; pointer-events:auto; }
.modal-content { background:#1e293b; padding:30px; border-radius:20px; border:2px solid var(--neon-blue); text-align:center; box-shadow:0 0 50px var(--neon-blue); }
.toast-notification { position:fixed; bottom:80px; left:50%; transform:translate(-50%, 50px); background:var(--neon-blue); color:#fff; padding:8px 24px; border-radius:99px; opacity:0; transition:0.3s; pointer-events:none; }
.toast-notification.show { transform:translate(-50%, 0); opacity:1; }

/* SP ADJUST */
@media(max-width:768px){ 
  .song-grid{grid-template-columns:1fr 1fr; gap:8px;} 
  .header-inner{padding:10px;}
  #star-tooltip{top:60px!important;left:50%!important;transform:translateX(-50%)!important;width:80%;text-align:center;}
}
</style>
</head>
<body>

<canvas id="matrix-canvas"></canvas>
<canvas id="realtime-viz"></canvas>
<canvas id="cursor-canvas"></canvas>
<canvas id="danmaku-canvas"></canvas>

<div id="galaxy-container">
  <div id="galaxy-ui"><button id="exitGalaxyBtn" class="cyber-btn">üîô EXIT</button></div>
  <div id="star-tooltip"><div class="tt-title"></div><div class="tt-artist"></div></div>
</div>

<div class="container">
  <header>
    <div class="header-inner">
      <h1 class="glitch-effect">„Çâ„ÅÑ„ÇÄ„ÅÆÊ≠å„Åà„ÇãÊõ≤„É™„Çπ„Éà üé§</h1>
      
      <div class="special-btns">
        <button id="rouletteBtn" class="cyber-btn">üé≤ ROULETTE</button>
        <button id="enterGalaxyBtn" class="cyber-btn">üåå GALAXY</button>
        <button id="rgbBtn" class="cyber-btn rgb-btn">üåà RGB MODE</button>
        <button id="clapBtn" class="cyber-btn">üëè 8888</button>
      </div>
      
      <div class="controls-toggle-row">
        <button id="controlsToggle" class="controls-toggle">‚ñ≤ Ê§úÁ¥¢„ÇíÈñâ„Åò„Çã</button>
      </div>
      <div id="controls" class="controls">
        <div style="margin: 10px 0; display:flex; gap:10px;">
          <input type="text" id="searchInput" placeholder="üé§„ÄéÊ§úÁ¥¢„ÄÅAdo„Äè„Å®Ë©±„Åó„Åã„Åë„Å¶„Åø„Å¶ÔºÅ" style="flex:1; padding:8px;">
          <select id="sortSelect" class="sort-select"><option value="default">ÁôªÈå≤È†Ü</option><option value="likes">„ÅÑ„ÅÑ„Å≠È†Ü</option></select>
        </div>
        <div id="filterRow" style="display:flex; flex-wrap:wrap; gap:5px; justify-content:center;"></div>
      </div>
    </div>
  </header>

  <main id="songSections"></main>
  
  <div style="text-align:center; margin-top:20px;">
    <button onclick="toggleDanmakuUI()" class="cyber-btn" style="font-size:0.8rem">üí¨ „Ç≥„É°„É≥„Éà„Åô„Çã</button>
  </div>
</div>

<div id="danmaku-area">
  <input type="text" id="danmaku-input" placeholder="„Ç≥„É°„É≥„ÉàÈÄÅ‰ø°...">
  <button onclick="sendDanmaku()" class="cyber-btn">ÈÄÅ‰ø°</button>
</div>

<div id="rouletteModal" class="modal-overlay"><div class="modal-content"><h2 style="color:#fff">Target Acquired</h2><div id="rouletteResult" style="font-size:2rem;margin:20px;font-weight:bold;color:#fff"></div><button onclick="closeModal()" class="cyber-btn">CLOSE</button></div></div>
<div id="toast" class="toast-notification">COPIED!</div>

<script>
// =========================================================
// SYSTEM CORE
// =========================================================
const CATEGORY_LABELS = { all:"ALL", jpop:"J-POP", anime:"ANIME", vocaloid:"VOCALOID", other:"OTHER", ng:"NG", training:"TRAINING", acoustic:"ACOUSTIC" };
const CATEGORY_ORDER = ["jpop", "anime", "vocaloid", "other", "ng", "training", "acoustic"];
let allSongs=[], filteredCategory="all", keyword="", currentSort="default", likesData={};

// --- AUDIO & VOICE SYSTEM ---
const AudioSys = {
  ctx: null, analyser: null, source: null, dataArray: null, isMicActive: false,
  init: async function() {
    window.AudioContext = window.AudioContext || window.webkitAudioContext;
    this.ctx = new AudioContext();
    // Ëµ∑ÂãïÈü≥
    this.speak("„Ç∑„Çπ„ÉÜ„É†„ÄÅËµ∑Âãï„Åó„Åæ„Åô");
    // „Éû„Ç§„ÇØ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      this.source = this.ctx.createMediaStreamSource(stream);
      this.analyser = this.ctx.createAnalyser();
      this.analyser.fftSize = 256;
      this.source.connect(this.analyser);
      this.dataArray = new Uint8Array(this.analyser.frequencyBinCount);
      this.isMicActive = true;
      drawRealtimeViz(); // „Éì„Ç∏„É•„Ç¢„É©„Ç§„Ç∂„ÉºÈñãÂßã
    } catch(e) { console.log("Mic access denied"); }
  },
  play: function(type) {
    if(!this.ctx) return;
    const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
    osc.connect(gain); gain.connect(this.ctx.destination);
    const now = this.ctx.currentTime;
    // SFX
    if(type==="hover"){ osc.frequency.setValueAtTime(800,now); gain.gain.exponentialRampToValueAtTime(0.01,now+0.1); osc.start(now); osc.stop(now+0.1); }
    if(type==="click"){ osc.type="square"; osc.frequency.setValueAtTime(150,now); gain.gain.exponentialRampToValueAtTime(0.01,now+0.1); osc.start(now); osc.stop(now+0.1); }
    if(type==="win"){ osc.type="triangle"; osc.frequency.setValueAtTime(440,now); osc.frequency.linearRampToValueAtTime(880,now+0.5); gain.gain.linearRampToValueAtTime(0.01,now+0.5); osc.start(now); osc.stop(now+0.5); }
  },
  speak: function(text) {
    if(!window.speechSynthesis) return;
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'ja-JP'; u.rate = 1.2; u.pitch = 0.8;
    window.speechSynthesis.speak(u);
  }
};

// --- VOICE COMMAND (Èü≥Â£∞Ë™çË≠ò) ---
const VoiceCmd = {
  recognition: null,
  init: function() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SpeechRecognition) return;
    this.recognition = new SpeechRecognition();
    this.recognition.lang = 'ja-JP';
    this.recognition.continuous = true;
    this.recognition.onresult = (event) => {
      const last = event.results.length - 1;
      const text = event.results[last][0].transcript.trim();
      console.log("Voice:", text);
      this.process(text);
    };
    this.recognition.start();
  },
  process: function(text) {
    if(text.includes("Ê§úÁ¥¢")) {
      const key = text.replace("Ê§úÁ¥¢", "").trim();
      document.getElementById("searchInput").value = key;
      keyword = key; render();
      AudioSys.speak(key + "„ÇíÊ§úÁ¥¢„Åó„Åæ„Åô");
    }
    else if(text.includes("„ÇÆ„É£„É©„ÇØ„Ç∑„Éº")) { GalaxySys.open(); AudioSys.speak("„ÇÆ„É£„É©„ÇØ„Ç∑„Éº„É¢„Éº„Éâ„ÄÅÂ±ïÈñã"); }
    else if(text.includes("Êàª„Çã") || text.includes("Èñâ„Åò„Çã")) { GalaxySys.close(); closeModal(); }
    else if(text.includes("„É´„Éº„É¨„ÉÉ„Éà")) { document.getElementById("rouletteBtn").click(); AudioSys.speak("„É´„Éº„É¨„ÉÉ„Éà„Çπ„Çø„Éº„Éà"); }
  }
};

// --- REALTIME VISUALIZER ---
const vizCanvas = document.getElementById("realtime-viz");
const vizCtx = vizCanvas.getContext("2d");
function drawRealtimeViz() {
  requestAnimationFrame(drawRealtimeViz);
  if(!AudioSys.isMicActive) return;
  
  vizCanvas.width = window.innerWidth; vizCanvas.height = 300;
  AudioSys.analyser.getByteFrequencyData(AudioSys.dataArray);
  
  vizCtx.clearRect(0,0,vizCanvas.width,vizCanvas.height);
  const barWidth = (vizCanvas.width / AudioSys.dataArray.length) * 2.5;
  let x = 0;
  
  for(let i=0; i<AudioSys.dataArray.length; i++) {
    const v = AudioSys.dataArray[i];
    const barHeight = v * 1.5; // È´ò„ÅïÂ¢óÂπÖ
    vizCtx.fillStyle = `hsl(${i/2 + 200}, 100%, 50%)`; // Èùí„ÄúÁ¥´
    vizCtx.shadowBlur = 10; vizCtx.shadowColor = `hsl(${i/2 + 200}, 100%, 50%)`;
    vizCtx.fillRect(x, vizCanvas.height - barHeight, barWidth, barHeight);
    x += barWidth + 1;
  }
}

// --- DANMAKU SYSTEM ---
const dmCanvas = document.getElementById("danmaku-canvas");
const dmCtx = dmCanvas.getContext("2d");
let danmakus = [];
function initDanmaku() {
  dmCanvas.width = window.innerWidth; dmCanvas.height = window.innerHeight;
  // FirebaseÂèó‰ø°
  if(window.db) {
    const dmRef = window.dbRef(window.db, 'danmaku');
    window.dbOnValue(dmRef, (snap) => {
      const val = snap.val();
      if(val) {
        // ÊúÄÊñ∞„ÅÆ1‰ª∂„ÇíÂèñÂæó„Åó„Å¶ÊµÅ„ÅôÔºàÁ∞°ÊòìÂÆüË£ÖÔºâ
        const keys = Object.keys(val);
        const lastMsg = val[keys[keys.length-1]].text;
        // Ëá™ÂàÜ„ÅåÈÄÅ„Å£„Åü„ÇÇ„ÅÆ‰ª•Â§ñ„ÇÇÊµÅ„Åô„Åü„ÇÅ„ÅÆÁ∞°Êòì„ÉÅ„Çß„ÉÉ„ÇØ„ÅØÁúÅÁï•
        spawnDanmaku(lastMsg); 
      }
    });
  }
  animateDanmaku();
}
function spawnDanmaku(text) {
  danmakus.push({
    text: text,
    x: window.innerWidth,
    y: Math.random() * (window.innerHeight - 100) + 50,
    speed: Math.random() * 3 + 2,
    color: '#fff'
  });
}
function animateDanmaku() {
  dmCtx.clearRect(0,0,dmCanvas.width, dmCanvas.height);
  dmCtx.font = "bold 24px sans-serif";
  danmakus.forEach((d, i) => {
    d.x -= d.speed;
    dmCtx.fillStyle = d.color;
    dmCtx.fillText(d.text, d.x, d.y);
    if(d.x < -500) danmakus.splice(i, 1);
  });
  requestAnimationFrame(animateDanmaku);
}
function toggleDanmakuUI() { document.getElementById("danmaku-area").classList.toggle("show"); }
function sendDanmaku() {
  const input = document.getElementById("danmaku-input");
  const text = input.value.trim();
  if(!text || !window.db) return;
  window.dbPush(window.dbRef(window.db, 'danmaku'), { text: text, time: Date.now() });
  input.value = "";
}

// --- FIREBASE LISTENERS (ALERT & LIKES) ---
function initFirebaseListeners() {
  if(!window.db) return;
  // „ÅÑ„ÅÑ„Å≠ÂêåÊúü
  window.dbOnValue(window.dbRef(window.db, 'likes'), (snap) => {
    likesData = snap.val() || {};
    updateLikesUI();
    if(currentSort==='likes') render();
  });
  // Ë≠¶Â†±Âèó‰ø°
  window.dbOnValue(window.dbRef(window.db, 'system/alert'), (snap) => {
    if(snap.val() === true) document.body.classList.add("red-alert");
    else document.body.classList.remove("red-alert");
  });
}

// =========================================================
// STANDARD UI LOGIC
// =========================================================
function updateLikesUI() {
  document.querySelectorAll('.btn-like').forEach(btn => {
    const t = btn.dataset.title.replace(/[.#$/[\]]/g, "_");
    btn.querySelector('.count').textContent = likesData[t] || 0;
  });
}

async function loadSongs() {
  const res = await fetch("songs.json");
  allSongs = await res.json();
  buildFilters(); render(); 
  
  // „Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ
  initFirebaseListeners();
  initDanmaku();
  AudioSys.init(); // „Éû„Ç§„ÇØË®±ÂèØ„ÇíÊ±Ç„ÇÅ„Çã
  VoiceCmd.init(); // Èü≥Â£∞Ë™çË≠òÈñãÂßã
}

function render() {
  let list = allSongs.filter(s => (filteredCategory==="all" || (s.category||"other")===filteredCategory) && `${s.title} ${s.artist} ${s.memo}`.toLowerCase().includes(keyword.toLowerCase()));
  if(currentSort==="likes") list.sort((a,b) => (likesData[b.title.replace(/[.#$/[\]]/g, "_")]||0) - (likesData[a.title.replace(/[.#$/[\]]/g, "_")]||0));
  else if(currentSort!=="default") list.sort((a,b) => (a[currentSort]||"").toString().localeCompare((b[currentSort]||"").toString(),"ja"));
  
  const container = document.getElementById("songSections");
  if(!list.length) { container.innerHTML = "<p style='text-align:center'>NO DATA</p>"; return; }
  
  const groups = list.reduce((g,s)=>{ (g[s.category||"other"]||=[]).push(s); return g; }, {});
  if(currentSort==="likes") {
    container.innerHTML = `<h2 style="color:var(--neon-pink);text-align:center">‚ù§Ô∏è RANKING</h2><div class="song-grid">${list.map((s,i)=>cardHTML(s,i)).join("")}</div>`;
  } else {
    container.innerHTML = CATEGORY_ORDER.filter(c=>groups[c]).map(c => `<h2 style="color:var(--neon-blue);border-left:4px solid var(--neon-blue);padding-left:10px;margin-top:20px">${CATEGORY_LABELS[c]}</h2><div class="song-grid">${groups[c].map((s,i)=>cardHTML(s,i)).join("")}</div>`).join("");
  }
  updateLikesUI();
}

function cardHTML(s, i) {
  const safeT = s.title.replace(/[.#$/[\]]/g, "_");
  const liked = JSON.parse(localStorage.getItem('liked')||'{}')[safeT];
  return `<div class="song-card" style="--i:${i}">
    <div class="song-title">${s.title}</div><div class="song-artist">${s.artist}</div>
    <div class="card-actions">
      <button class="btn-like ${liked?'liked-done':''}" ${liked?'disabled':''} data-title="${s.title}" onclick="addLike('${safeT}',this)">‚ù§Ô∏è <span class="count">0</span></button>
      ${s.url ? `<a href="${s.url}" target="_blank" class="btn-youtube">üì∫</a>` : ""}
    </div>
  </div>`;
}

window.addLike = (t, btn) => {
  AudioSys.play("click");
  const d = JSON.parse(localStorage.getItem('liked')||'{}');
  if(d[t]) return;
  d[t]=true; localStorage.setItem('liked', JSON.stringify(d));
  btn.classList.add("liked-done"); btn.disabled=true;
  window.dbRunTransaction(window.dbRef(window.db, 'likes/'+t), c => (c||0)+1);
  // ÊãçÊâã„Éë„Éº„ÉÜ„Ç£„ÇØ„É´„ÇÇÂá∫„Åô
  spawnParticles(window.innerWidth/2, window.innerHeight);
};

// ÊãçÊâã„Éë„Éº„ÉÜ„Ç£„ÇØ„É´
document.getElementById("clapBtn").onclick = () => {
  AudioSys.play("win");
  for(let i=0; i<30; i++) spawnParticles(Math.random()*window.innerWidth, window.innerHeight);
};
function spawnParticles(x, y) {
  for(let i=0; i<10; i++) {
    const el = document.createElement("div");
    el.style.position = "fixed"; el.style.left = x+"px"; el.style.top = y+"px";
    el.style.width="10px"; el.style.height="10px"; el.style.background = `hsl(${Math.random()*360},100%,50%)`;
    el.style.borderRadius="50%"; el.style.pointerEvents="none"; el.style.zIndex="9999";
    document.body.appendChild(el);
    const angle = Math.random()*Math.PI*2; const vel = Math.random()*10;
    let dx = Math.cos(angle)*vel; let dy = Math.sin(angle)*vel - 10;
    let life = 1;
    const tick = () => {
      life -= 0.02; dy += 0.5; // gravity
      el.style.left = (parseFloat(el.style.left)+dx)+"px"; el.style.top = (parseFloat(el.style.top)+dy)+"px";
      el.style.opacity = life;
      if(life>0) requestAnimationFrame(tick); else el.remove();
    };
    tick();
  }
}

// RGB„É¢„Éº„Éâ
document.getElementById("rgbBtn").onclick = () => document.body.classList.toggle("rgb-mode");

// „Éï„Ç£„É´„Çø„Éº
function buildFilters() {
  const c = document.getElementById("filterRow"); c.innerHTML="";
  ["all",...CATEGORY_ORDER].forEach(k => {
    const b=document.createElement("button"); b.className=`filter-btn ${k===filteredCategory?'active':''}`;
    b.textContent = CATEGORY_LABELS[k];
    b.onclick = () => { filteredCategory=k; render(); window.scrollTo({top:0,behavior:'smooth'}); buildFilters(); };
    c.appendChild(b);
  });
}

// „Ç§„Éô„É≥„Éà
document.getElementById("searchInput").oninput = e => { keyword=e.target.value; render(); };
document.getElementById("sortSelect").onchange = e => { currentSort=e.target.value; render(); };
document.getElementById("controlsToggle").onclick = () => document.getElementById("controls").classList.toggle("collapsed");
window.closeModal = () => document.getElementById("rouletteModal").classList.remove("show");

// GALAXY
const GalaxySys = {
  active: false, scene: null, camera: null, renderer: null, stars: [], raycaster: new THREE.Raycaster(), mouse: new THREE.Vector2(),
  init: function() {
    this.scene = new THREE.Scene(); this.scene.fog = new THREE.FogExp2(0x000000, 0.002);
    this.camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 1, 1000); this.camera.position.z=1;
    this.renderer = new THREE.WebGLRenderer({alpha:true}); this.renderer.setSize(innerWidth, innerHeight);
    document.getElementById("galaxy-container").appendChild(this.renderer.domElement);
    this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement); this.controls.autoRotate=true;
    // „Ç§„Éô„É≥„Éà
    window.addEventListener('resize', ()=>this.resize());
    window.addEventListener('click', e => this.click(e));
    window.addEventListener('mousemove', e => this.move(e));
  },
  create: function() {
    this.stars.forEach(s=>this.scene.remove(s)); this.stars=[];
    const mat = new THREE.SpriteMaterial({color:0x60a5fa});
    allSongs.forEach(s => {
      const sp = new THREE.Sprite(mat);
      sp.position.setRandom().multiplyScalar(500); sp.scale.set(10,10,1);
      sp.userData = s; this.scene.add(sp); this.stars.push(sp);
    });
  },
  open: function() {
    if(!this.scene) this.init(); this.create();
    document.getElementById("galaxy-container").classList.add("active"); this.active=true; this.loop();
    AudioSys.speak("„ÇÆ„É£„É©„ÇØ„Ç∑„Éº„É¢„Éº„Éâ„ÄÅÂ±ïÈñã");
  },
  close: function() { document.getElementById("galaxy-container").classList.remove("active"); this.active=false; },
  loop: function() {
    if(!this.active) return; requestAnimationFrame(()=>this.loop());
    this.controls.update(); this.renderer.render(this.scene, this.camera);
  },
  resize: function() { this.camera.aspect=innerWidth/innerHeight; this.camera.updateProjectionMatrix(); this.renderer.setSize(innerWidth,innerHeight); },
  move: function(e) {
    this.mouse.x=(e.clientX/innerWidth)*2-1; this.mouse.y=-(e.clientY/innerHeight)*2+1;
    this.raycaster.setFromCamera(this.mouse, this.camera);
    const hit = this.raycaster.intersectObjects(this.stars);
    const tt = document.getElementById("star-tooltip");
    if(hit.length>0) {
      tt.style.opacity=1; tt.style.left=e.clientX+15+"px"; tt.style.top=e.clientY+"px";
      tt.querySelector(".tt-title").textContent = hit[0].object.userData.title;
    } else tt.style.opacity=0;
  },
  click: function(e) {
    if(!this.active) return;
    this.raycaster.setFromCamera(this.mouse, this.camera);
    const hit = this.raycaster.intersectObjects(this.stars);
    if(hit.length>0) {
      document.getElementById("rouletteModal").classList.add("show");
      document.getElementById("rouletteResult").textContent = hit[0].object.userData.title;
      AudioSys.speak("„Çø„Éº„Ç≤„ÉÉ„Éà„ÄÅÁ¢∫Ë™ç");
    }
  }
};
document.getElementById("enterGalaxyBtn").onclick = () => GalaxySys.open();
document.getElementById("exitGalaxyBtn").onclick = () => GalaxySys.close();

// Ëµ∑Âãï
loadSongs();

// „É´„Éº„É¨„ÉÉ„Éà
document.getElementById("rouletteBtn").onclick = () => {
  AudioSys.speak("„É´„Éº„É¨„ÉÉ„Éà„ÄÅ„Çπ„Çø„Éº„Éà");
  const list = allSongs; if(!list.length) return;
  document.getElementById("rouletteModal").classList.add("show");
  let c=0, t=setInterval(()=>{
    document.getElementById("rouletteResult").textContent = list[Math.floor(Math.random()*list.length)].title;
    if(++c>20) { clearInterval(t); AudioSys.play("win"); AudioSys.speak("Ê±∫ÂÆö„Åó„Åæ„Åó„Åü"); }
  },50);
};

// „Éû„Éà„É™„ÉÉ„ÇØ„ÇπËÉåÊôØ
const mCtx=document.getElementById("matrix-canvas").getContext("2d");
let drops=[]; function initM(){drops=Array(Math.floor(innerWidth/20)).fill(1);}
function drawM(){
  mCtx.fillStyle="rgba(0,0,0,0.05)";mCtx.fillRect(0,0,innerWidth,innerHeight);
  mCtx.fillStyle="#0f0";
  drops.forEach((y,i)=>{
    mCtx.fillText(String.fromCharCode(0x30A0+Math.random()*96),i*20,y*20);
    if(y*20>innerHeight&&Math.random()>0.975) drops[i]=0; drops[i]++;
  });
  requestAnimationFrame(drawM);
}
initM(); drawM(); window.onresize=initM;

</script>
</body>
</html>