<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚‰ã„ã‚€ã®æ­Œãˆã‚‹æ›²ãƒªã‚¹ãƒˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
/* =========================================================
   ãƒ™ãƒ¼ã‚¹ã‚«ãƒ©ãƒ¼å¤‰æ•°
========================================================= */
:root {
  --text-main: #e5e7eb;
  --text-sub: #9ca3af;
  --card-bg: rgba(15, 23, 42, 0.72);
  --card-border: rgba(56, 189, 248, 0.25);
  --accent: #60a5fa;
  --radius: 16px;
  --shadow: 0 8px 25px rgba(0, 0, 0, 0.35);
}

/* =========================================================
   ãƒ™ãƒ¼ã‚¹è¨­å®š
========================================================= */
* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: "Segoe UI", system-ui, sans-serif;
  color: var(--text-main);
  background: #000;
}

/* ã¼ã‚„ã‘èƒŒæ™¯ */
body::before {
  content: "";
  position: fixed;
  inset: 0;
  background: url("bg.jpg") center/cover no-repeat;
  filter: blur(12px) brightness(0.55);
  transform: scale(1.06);
  z-index: -2;
}

/* ãƒã‚ªãƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
body::after {
  content: "";
  position: fixed;
  inset: 0;
  background:
    radial-gradient(circle at top left, rgba(79, 70, 229, 0.65), transparent 55%),
    radial-gradient(circle at bottom right, rgba(236, 72, 153, 0.5), transparent 55%),
    linear-gradient(to bottom, rgba(15, 23, 42, 0.85), rgba(15, 23, 42, 0.95));
  mix-blend-mode: screen;
  z-index: -1;
}

/* ã‚³ãƒ³ãƒ†ãƒŠ */
.container {
  max-width: 960px;
  margin: 0 auto;
  padding: 16px 14px 40px;
}

/* =========================================================
   ãƒ˜ãƒƒãƒ€ãƒ¼
========================================================= */
header {
  position: sticky;
  top: 0;
  padding: 8px 0 10px;
  z-index: 30;
}

.header-inner {
  padding: 16px;
  background: rgba(15, 23, 42, 0.95);
  border-radius: 20px;
  border: 1px solid rgba(56, 189, 248, 0.25);
  box-shadow: var(--shadow);
}

h1 {
  margin: 0;
  font-size: 1.9rem;
  text-align: center;
  font-weight: 900;
  letter-spacing: 0.15em;
  text-shadow:
    0 0 6px rgba(75, 127, 255, 0.9),
    0 0 18px rgba(56, 189, 248, 0.9);
}

.tagline {
  text-align: center;
  font-size: 0.9rem;
  color: var(--text-sub);
  margin-top: 3px;
}

.note {
  text-align: center;
  font-size: 0.75rem;
  margin-top: 2px;
  color: var(--text-sub);
}

/* =========================================================
   æ¤œç´¢ã‚¨ãƒªã‚¢ï¼ˆé–‹é–‰å¼ï¼‰
========================================================= */

.controls-toggle-row {
  margin-top: 8px;
  text-align: right;
}

.controls-toggle {
  padding: 4px 12px;
  border-radius: 999px;
  font-size: 0.75rem;
  background: rgba(15, 23, 42, 0.9);
  border: 1px solid rgba(148, 163, 184, 0.6);
  color: var(--text-main);
  cursor: pointer;
}

.controls {
  margin-top: 12px;
  display: flex;
  flex-direction: column;
  gap: 10px;

  max-height: 500px;
  opacity: 1;
  overflow: hidden;
  transition: max-height 0.25s ease, opacity 0.2s ease;
}

/* é–‰ã˜ãŸçŠ¶æ…‹ */
.controls.collapsed {
  max-height: 0;
  opacity: 0;
  pointer-events: none;
}

/* æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ */
.search-box label {
  font-size: 0.78rem;
  margin-bottom: 4px;
  color: var(--text-sub);
}

.search-input-wrap {
  position: relative;
}

.search-box input {
  width: 100%;
  padding: 10px 12px 10px 34px;
  border-radius: 999px;
  border: 1px solid rgba(148, 163, 184, 0.7);
  background: rgba(15, 23, 42, 0.8);
  color: var(--text-main);
}

.search-icon {
  position: absolute;
  top: 50%;
  left: 10px;
  transform: translateY(-50%);
  opacity: 0.6;
}

/* ã‚½ãƒ¼ãƒˆç”¨ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
.sort-select {
  padding: 6px 12px;
  border-radius: 999px;
  border: 1px solid rgba(148, 163, 184, 0.7);
  background: rgba(15, 23, 42, 0.8);
  color: var(--text-main);
  font-size: 0.85rem;
  outline: none;
  cursor: pointer;
}
.sort-select:focus {
  border-color: var(--accent);
  box-shadow: 0 0 8px rgba(56, 189, 248, 0.5);
}

/* ãƒ•ã‚£ãƒ«ã‚¿ãƒœã‚¿ãƒ³ */
.filter-row {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  justify-content: center;
}

.filter-btn {
  padding: 5px 10px;
  border-radius: 999px;
  background: rgba(15, 23, 42, 0.9);
  border: 1px solid rgba(148, 163, 184, 0.6);
  color: var(--text-sub);
  font-size: 0.75rem;
  cursor: pointer;
}

.filter-btn.active {
  background: linear-gradient(135deg, #4f46e5, #0ea5e9);
  color: #fff;
  border-color: rgba(56, 189, 248, 0.9);
  box-shadow: 0 0 10px rgba(59, 130, 246, 0.7);
}

/* =========================================================
   ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºï¼ˆã“ã“ãŒãƒ¡ã‚¤ãƒ³ï¼ï¼‰
========================================================= */

.song-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 14px;
  margin-top: 14px;
}

/* 1æ›²ã®ã‚«ãƒ¼ãƒ‰ */
.song-card {
  position: relative;
  background: radial-gradient(circle at top left, rgba(96,165,250,0.25), transparent 55%),
              radial-gradient(circle at bottom right, rgba(236,72,153,0.25), transparent 55%),
              rgba(15, 23, 42, 0.9);
  padding: 16px 20px;
  border-radius: 22px;
  border: 1px solid rgba(56, 189, 248, 0.7);
  backdrop-filter: blur(12px);
  box-shadow:
    0 0 0 1px rgba(15,23,42,0.8),
    0 16px 35px rgba(0,0,0,0.6),
    0 0 25px rgba(59,130,246,0.35);

  overflow: hidden;
  opacity: 0;
  transform: translateY(20px) scale(0.97);
  animation: fadeUp 0.6s ease forwards;
}

/* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å€‹åˆ¥ãƒ‡ã‚£ãƒ¬ã‚¤ */
.song-card {
  animation-delay: calc(var(--i) * 0.03s);
}
/* ã‚«ãƒ¼ãƒ‰ã®å†…å´ã§ã†ã£ã™ã‚‰å…‰ãŒå‹•ã */
.song-card::before {
  content: "";
  position: absolute;
  inset: -40%;
  background: conic-gradient(
    from 180deg,
    rgba(59,130,246,0.0),
    rgba(59,130,246,0.5),
    rgba(236,72,153,0.5),
    rgba(56,189,248,0.8),
    rgba(59,130,246,0.0)
  );
  opacity: 0;
  mix-blend-mode: screen;
  filter: blur(22px);
  transform: rotate(0deg);
  transition: opacity 0.3s ease, transform 4s linear;
}

/* ãƒ›ãƒãƒ¼ã§æµ®ãä¸ŠãŒã£ã¦å…‰ã‚‹ */
.song-card:hover {
  transform: translateY(-6px) scale(1.02);
  box-shadow:
    0 0 0 1px rgba(56,189,248,0.6),
    0 22px 45px rgba(15,23,42,0.95),
    0 0 40px rgba(96,165,250,0.8);
}

.song-card:hover::before {
  opacity: 0.95;
  transform: rotate(25deg);
}


@keyframes fadeUp {
  0% { opacity: 0; transform: translateY(20px) scale(0.97); }
  60% { opacity: 1; transform: translateY(-2px) scale(1.02); }
  100% { opacity: 1; transform: translateY(0) scale(1); }
}

/* ã‚¿ã‚¤ãƒˆãƒ«ãƒ»ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ */
.song-title {
  font-size: 1.1rem;
  font-weight: 800;
  letter-spacing: 0.04em;
  text-shadow:
    0 0 10px rgba(59,130,246,0.9),
    0 0 18px rgba(56,189,248,0.9);
}

.song-artist {
  opacity: 0.9;
  margin-top: 3px;
  font-size: 0.9rem;
  color: #cbd5f5;
}

.song-pills {
  margin-top: 6px;
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
}

/* ãƒ¡ãƒ¢ãƒ”ãƒ«å…±é€š */
.memo-pill {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 9px;
  border-radius: 999px;
  font-size: 0.73rem;
  border: 1px solid rgba(255,255,255,0.35);
  background: rgba(15,23,42,0.9);
  box-shadow:
    0 0 10px rgba(148,163,184,0.4),
    0 0 18px rgba(15,23,42,0.9);
}

/* è‰²åˆ¥å¼·åŒ– */
.memo-ng {
  background: radial-gradient(circle at top left, #fecaca, #b91c1c);
  color: #fff;
  border-color: rgba(254,202,202,0.9);
  box-shadow: 0 0 12px rgba(248,113,113,0.9);
}

.memo-training {
  background: radial-gradient(circle at top left, #bfdbfe, #1d4ed8);
  color: #e0f2fe;
  border-color: rgba(191,219,254,0.9);
  box-shadow: 0 0 12px rgba(96,165,250,0.9);
}

.memo-key {
  background: radial-gradient(circle at top left, #ddd6fe, #7c3aed);
  color: #f5f3ff;
  border-color: rgba(221,214,254,0.9);
  box-shadow: 0 0 12px rgba(129,140,248,0.9);
}

/* ãƒ¡ãƒ¢æ–‡ç«  */
.memo-text {
  font-size: 0.8rem;
  margin-top: 8px;
  opacity: 0.95;
  color: #e5e7f5;
}




/* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ« */
.category-title {
  margin: 18px 0 6px;
  padding-left: 10px;
  font-size: 1.1rem;
  border-left: 3px solid var(--accent);
  text-shadow: 0 0 6px rgba(59,130,246,0.6);
}

.category-badge {
  font-size: 0.75rem;
  color: var(--text-sub);
}
.category-title {
  margin: 22px 0 8px;
  padding-left: 12px;
  font-size: 1.15rem;
  border-left: 4px solid var(--accent);
  text-shadow:
    0 0 10px rgba(59,130,246,0.9),
    0 0 22px rgba(56,189,248,0.9);
}

/* --- <style> ã®ä¸€ç•ªä¸‹ã«è¿½åŠ  --- */

/* ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆãƒœã‚¿ãƒ³ */
.roulette-btn {
  background: linear-gradient(45deg, #ff6b6b, #f06595);
  border: none;
  padding: 8px 24px;
  border-radius: 999px;
  color: #fff;
  font-weight: bold;
  font-size: 0.9rem;
  cursor: pointer;
  box-shadow: 0 4px 15px rgba(240, 101, 149, 0.4);
  transition: transform 0.2s, box-shadow 0.2s;
}
.roulette-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 20px rgba(240, 101, 149, 0.6);
}
.roulette-btn:active {
  transform: scale(0.95);
}

/* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆçµæœç”»é¢ï¼‰ */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  backdrop-filter: blur(5px);
  z-index: 100;
  display: flex;
  justify-content: center;
  align-items: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
}
.modal-overlay.show {
  opacity: 1;
  pointer-events: auto;
}

.modal-content {
  background: #1e293b;
  border: 1px solid var(--accent);
  padding: 40px;
  border-radius: 20px;
  text-align: center;
  max-width: 90%;
  width: 400px;
  box-shadow: 0 0 50px rgba(96, 165, 250, 0.5);
  transform: scale(0.8);
  transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.modal-overlay.show .modal-content {
  transform: scale(1);
}

.modal-title {
  color: var(--text-sub);
  font-size: 1rem;
  margin-bottom: 10px;
}
.modal-result {
  font-size: 1.8rem;
  font-weight: 900;
  margin: 20px 0;
  color: #fff;
  text-shadow: 0 0 15px var(--accent);
  min-height: 3rem; /* æ–‡å­—æ•°ã§ã‚¬ã‚¿ã¤ã‹ãªã„ã‚ˆã†ã« */
  display: flex;
  align-items: center;
  justify-content: center;
  line-height: 1.3;
}
.modal-close {
  background: transparent;
  border: 1px solid var(--text-sub);
  color: var(--text-main);
  padding: 8px 24px;
  border-radius: 999px;
  cursor: pointer;
  margin-top: 10px;
}
.modal-close:hover {
  background: rgba(255,255,255,0.1);
}
</style>

</head>
<body>

<div class="container">

<header>
  <div class="header-inner">
    <div style="text-align:center; font-size:0.7rem; color:var(--text-sub); margin-bottom:4px; opacity:0.8;">
      Last Update: <span id="lastUpdateTime">--/-- --:--</span>
    </div>
    <h1>ã‚‰ã„ã‚€ã®æ­Œãˆã‚‹æ›²ãƒªã‚¹ãƒˆ ğŸ¤</h1>
    <div class="tagline">é…ä¿¡ã§æ­Œãˆã‚‹ï¼ˆæ­Œã„ãŸã„ï¼‰æ›²ã‚’ã¾ã¨ã‚ãŸãƒšãƒ¼ã‚¸</div>
    <div class="note">æ›²åãƒ»ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆãƒ»ãƒ¡ãƒ¢ã§æ¤œç´¢ã§ãã¾ã™</div>
    <div style="text-align:center; margin: 10px 0;">
      <button id="rouletteBtn" class="roulette-btn">
        ğŸ² ãŠã¾ã‹ã›é¸æ›²ï¼
      </button>
    </div>

    <div id="rouletteModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-title">ğŸµ æ¬¡ã®æ›²ã¯...</div>
        <div id="rouletteResult" class="modal-result">???</div>
        <button id="closeModal" class="modal-close">é–‰ã˜ã‚‹</button>
      </div>
    </div>
    

    <!-- é–‹é–‰ãƒœã‚¿ãƒ³ -->
    <div class="controls-toggle-row">
      <button id="controlsToggle" class="controls-toggle">
        <span id="toggleIcon">â–²</span> <span id="toggleLabel">æ¤œç´¢ã‚’é–‰ã˜ã‚‹</span>
      </button>
    </div>

    <!-- æ¤œç´¢ãƒ‘ãƒãƒ« -->
    <div class="search-box">
      <label for="searchInput">æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
      <div class="search-input-wrap">
        <span class="search-icon">ğŸ”</span>
        <input type="text" id="searchInput" placeholder="ä¾‹ï¼šAdo / ç·´ç¿’ä¸­ ãªã©">
      </div>
  
      <div style="margin-top: 10px; display: flex; align-items: center; justify-content: flex-end; gap: 8px;">
        <label for="sortSelect" style="font-size:0.75rem; color:var(--text-sub); margin:0;">ä¸¦ã³æ›¿ãˆ:</label>
        <select id="sortSelect" class="sort-select">
          <option value="default">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆç™»éŒ²é †ï¼‰</option>
          <option value="artist">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆé † (ã‚ã„ã†ãˆãŠ)</option>
          <option value="title">æ›²åé † (ã‚ã„ã†ãˆãŠ)</option>
        </select>
      </div>
    </div>

    <div class="filter-row" id="filterRow" style="margin-top: 12px;"></div>
    </div>
</header>

<main id="songSections"></main>

<footer style="text-align:center;margin-top:40px;color:#9ca3af;font-size:0.75rem;">
  æ›´æ–°æ—¥: <span id="updatedDate"></span>
</footer>

</div>
<script>
/* =========================================================
   1. å®šæ•°ãƒ»å¤‰æ•°ã®å®šç¾©
   ========================================================= */

// ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®è¡¨ç¤ºåï¼ˆçµµæ–‡å­—ä»˜ãï¼‰
const CATEGORY_LABELS = {
  all: "ã™ã¹ã¦",
  jpop: "J-POP / ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ",
  anime: "ã‚¢ãƒ‹ã‚½ãƒ³ / ã‚²ãƒ¼ã‚½ãƒ³",
  vocaloid: "ãƒœã‚«ãƒ­",
  other: "ãã®ä»–",
  ng: "ğŸ™… NGï¼ˆæ­Œã„ãŸããªã„ï¼‰",
  training: "ğŸ”° ç·´ç¿’ä¸­",
  acoustic: "ğŸ¸ å¼¾ãèªã‚Š"
};

// è¡¨ç¤ºã™ã‚‹é †ç•ª
const CATEGORY_ORDER = ["jpop", "anime", "vocaloid", "other", "ng", "training", "acoustic"];

// ãƒ‡ãƒ¼ã‚¿ã®å…¥ã‚Œç‰©ï¼ˆçŠ¶æ…‹ç®¡ç†ï¼‰
let allSongs = [];           // å…¨æ›²ãƒ‡ãƒ¼ã‚¿
let filteredCategory = "all"; // ç¾åœ¨é¸ã°ã‚Œã¦ã„ã‚‹ã‚«ãƒ†ã‚´ãƒª
let keyword = "";            // æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã®æ–‡å­—
let currentSort = "default"; // ç¾åœ¨ã®ä¸¦ã³é †

// HTMLã®è¦ç´ ã‚’å–å¾—ï¼ˆæ“ä½œã™ã‚‹ãŸã‚ã«å¿…è¦ï¼‰
const sectionsContainer = document.getElementById("songSections");
const searchInput = document.getElementById("searchInput");
const filterRow = document.getElementById("filterRow");
const controls = document.getElementById("controls"); // æ¤œç´¢ã‚¨ãƒªã‚¢å…¨ä½“
const toggle = document.getElementById("controlsToggle"); // é–‹é–‰ãƒœã‚¿ãƒ³
const toggleIcon = document.getElementById("toggleIcon");
const toggleLabel = document.getElementById("toggleLabel");
const sortSelect = document.getElementById("sortSelect"); // ä¸¦ã³æ›¿ãˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³

// ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆç”¨ã®è¦ç´ 
const rouletteBtn = document.getElementById("rouletteBtn");
const modal = document.getElementById("rouletteModal");
const modalResult = document.getElementById("rouletteResult");
const closeModal = document.getElementById("closeModal");


/* =========================================================
   2. åˆæœŸåŒ–ãƒ»ä¾¿åˆ©æ©Ÿèƒ½
   ========================================================= */

// æ¤œç´¢ã‚¨ãƒªã‚¢ã®é–‹é–‰ãƒœã‚¿ãƒ³ã®å‹•ä½œ
toggle.addEventListener("click", () => {
  const collapsed = controls.classList.toggle("collapsed");
  toggleIcon.textContent = collapsed ? "â–¼" : "â–²";
  toggleLabel.textContent = collapsed ? "æ¤œç´¢ã‚’é–‹ã" : "æ¤œç´¢ã‚’é–‰ã˜ã‚‹";
});

// HTMLã‚¿ã‚°ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹é–¢æ•°ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ï¼šæ–‡å­—ã¨ã—ã¦è¡¨ç¤ºã•ã›ã‚‹ï¼‰
function escape(str) {
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;");
}

// ãƒ‡ãƒ¼ã‚¿ã®æ•´å½¢ï¼ˆãƒ¡ãƒ¢ã«ã€Œå¼¾ãèªã‚Šã€ãŒã‚ã£ãŸã‚‰ã‚«ãƒ†ã‚´ãƒªã‚’è‡ªå‹•å¤‰æ›´ã™ã‚‹ãªã©ï¼‰
function normalizeSongs(songs) {
  return songs.map(song => {
    // ã™ã§ã« acoustic ãªã‚‰ãã®ã¾ã¾
    if (song.category === "acoustic") return song;
    // ãƒ¡ãƒ¢ã«ã€Œå¼¾ãèªã‚Šã€ãŒå«ã¾ã‚Œã¦ã„ãŸã‚‰ã‚«ãƒ†ã‚´ãƒªã‚’å¤‰æ›´
    if (song.memo && song.memo.includes("å¼¾ãèªã‚Š")) {
      return { ...song, category: "acoustic" };
    }
    return song;
  });
}

// â˜…æ›´æ–°æ—¥æ™‚ã®è¡¨ç¤ºæ©Ÿèƒ½ï¼ˆå³æ™‚å®Ÿè¡Œé–¢æ•°ï¼‰
// ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€çµ‚ä¿å­˜æ—¥æ™‚ã‚’å–å¾—ã—ã¦ãƒ˜ãƒƒãƒ€ãƒ¼ã«è¡¨ç¤ºã—ã¾ã™
(function(){
  const d = new Date(document.lastModified); // ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜æ—¥æ™‚
  
  // è¦‹ã‚„ã™ã„å½¢å¼ (ä¾‹: 2023/10/27 12:40) ã«å¤‰æ›
  const year = d.getFullYear();
  const month = (d.getMonth() + 1).toString().padStart(2, '0');
  const date = d.getDate().toString().padStart(2, '0');
  const hours = d.getHours().toString().padStart(2, '0');
  const min = d.getMinutes().toString().padStart(2, '0');
  const timeString = `${year}/${month}/${date} ${hours}:${min}`;

  // ãƒ˜ãƒƒãƒ€ãƒ¼ã«æ›¸ãè¾¼ã¿
  const headerDate = document.getElementById("lastUpdateTime");
  if(headerDate) headerDate.textContent = timeString;

  // ãƒ•ãƒƒã‚¿ãƒ¼ã«æ›¸ãè¾¼ã¿
  const footerDate = document.getElementById("updatedDate");
  if(footerDate) footerDate.textContent = timeString;
})();


/* =========================================================
   3. ãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼šæ›²ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
   ========================================================= */

async function loadSongs() {
  try {
    console.log("èª­ã¿è¾¼ã¿é–‹å§‹: songs.json ã‚’æ¢ã—ã¦ã„ã¾ã™...");
    
    // 1. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–ã‚Šã«è¡Œã
    const res = await fetch("songs.json", { cache: "no-store" });
    
    // 2. ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã£ãŸã‹ç¢ºèª
    if (!res.ok) {
      throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (Status: ${res.status})`);
    }

    // 3. JSONã¨ã—ã¦è§£èª­ã™ã‚‹
    const data = await res.json();
    console.log("èª­ã¿è¾¼ã¿æˆåŠŸï¼ãƒ‡ãƒ¼ã‚¿æ•°:", data.length);

    // 4. ãƒ‡ãƒ¼ã‚¿ã‚’æ•´å½¢ã—ã¦ä¿å­˜
    allSongs = normalizeSongs(data);

    // 5. ç”»é¢ã‚’ä½œã‚‹
    buildFilterButtons(); // ã‚«ãƒ†ã‚´ãƒªãƒœã‚¿ãƒ³ä½œæˆ
    render();             // ãƒªã‚¹ãƒˆè¡¨ç¤º

  } catch (e) {
    // ã‚¨ãƒ©ãƒ¼ãŒèµ·ããŸã‚‰ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã¨ç”»é¢ã«è¡¨ç¤º
    console.error("ã€é‡å¤§ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿã€‘:", e); 
    sectionsContainer.innerHTML = `
      <div style='text-align:center; margin-top:20px;'>
        <p>æ›²ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸğŸ˜¢</p>
        <p style='color:#f87171; font-size:0.8rem;'>${e.message}</p>
      </div>
    `;
  }
}


/* =========================================================
   4. ç”»é¢è¡¨ç¤ºï¼ˆãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼‰é–¢é€£
   ========================================================= */

// ã‚«ãƒ†ã‚´ãƒªãƒœã‚¿ãƒ³ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒœã‚¿ãƒ³ï¼‰ã‚’ä½œã‚‹é–¢æ•°
function buildFilterButtons() {
  if (!filterRow) return; // ã‚¨ãƒ©ãƒ¼å›é¿

  // å„ã‚«ãƒ†ã‚´ãƒªã«ä½•æ›²ã‚ã‚‹ã‹æ•°ãˆã‚‹
  const counts = allSongs.reduce((a,s)=>{
    const c = s.category || "other";
    a.all++;
    a[c] = (a[c]||0)+1;
    return a;
  },{all:0});

  filterRow.innerHTML = "";

  // ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆã—ã¦é…ç½®
  ["all",...CATEGORY_ORDER].forEach(cat=>{
    const btn = document.createElement("button");
    btn.className = "filter-btn"+(cat===filteredCategory?" active":"");
    btn.innerHTML = `${CATEGORY_LABELS[cat]} <span class="count">(${counts[cat]||0})</span>`;
    
    // ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‹•ä½œ
    btn.onclick = ()=>{
      filteredCategory = cat;
      // ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®ã‚’åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll(".filter-btn").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      // ãƒªã‚¹ãƒˆå†æç”»
      render();
    };
    filterRow.appendChild(btn);
  });
}

// â˜…ãƒ¡ã‚¤ãƒ³ã®æç”»é–¢æ•°ï¼ˆãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã™ã‚‹ï¼‰
function render() {
  // 1. ã¾ãšå…¨æ›²ãƒªã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼
  let list = allSongs.slice();

  // 2. ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿
  if (filteredCategory !== "all") {
    list = list.filter(s => (s.category || "other") === filteredCategory);
  }

  // 3. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢
  const kw = keyword.toLowerCase();
  if (kw) {
    list = list.filter(s =>
      `${s.title||""} ${s.artist||""} ${s.memo||""}`.toLowerCase().includes(kw)
    );
  }

  // 4. ä¸¦ã³æ›¿ãˆå‡¦ç†
  if (currentSort === "artist") {
    list.sort((a, b) => {
      const artA = (a.artist || "ä¸æ˜").toString();
      const artB = (b.artist || "ä¸æ˜").toString();
      return artA.localeCompare(artB, "ja"); // ã‚ã„ã†ãˆãŠé †æ¯”è¼ƒ
    });
  } else if (currentSort === "title") {
    list.sort((a, b) => {
      const titleA = (a.title || "").toString();
      const titleB = (b.title || "").toString();
      return titleA.localeCompare(titleB, "ja");
    });
  }

  // è©²å½“ãªã—ã®å ´åˆ
  if (!list.length) {
    sectionsContainer.innerHTML = "<p style='text-align:center;margin-top:20px;'>è©²å½“ã™ã‚‹æ›²ãŒã‚ã‚Šã¾ã›ã‚“</p>";
    return;
  }

  // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘ã™ã‚‹
  const groups = {};
  list.forEach(s => {
    const c = s.category || "other";
    if (!groups[c]) groups[c] = [];
    groups[c].push(s);
  });

  // ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«HTMLã‚’ä½œã£ã¦çµåˆ
  const html = CATEGORY_ORDER
    .filter(c => groups[c]) // æ›²ãŒã‚ã‚‹ã‚«ãƒ†ã‚´ãƒªã ã‘
    .map(cat => renderCategorySection(cat, groups[cat]))
    .join("");

  sectionsContainer.innerHTML = html;
}

// ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚«ãƒ†ã‚´ãƒªã”ã¨ã®å¡Šï¼‰ã®HTMLã‚’ä½œã‚‹
function renderCategorySection(cat, list) {
  return `
    <h2 class="category-title">${CATEGORY_LABELS[cat]}</h2>
    <div class="song-grid">
      ${list.map((s,i)=>renderCard(s,i)).join("")}
    </div>
  `;
}

// ã‚«ãƒ¼ãƒ‰1æšã®HTMLã‚’ä½œã‚‹
function renderCard(s, i) {
  const title = escape(s.title);
  const artist = escape(s.artist || "");
  const memo = s.memo || "";

  // ãƒ¡ãƒ¢ã‹ã‚‰ã‚­ãƒ¼æƒ…å ±ï¼ˆ+3, -2ãªã©ï¼‰ã‚’æŠœãå‡ºã™
  const keyMatch = memo.match(/[-+]\d+/);

  // ãƒ”ãƒ«ï¼ˆãƒãƒƒã‚¸ï¼‰ã‚’ä½œã‚‹
  const pills = [];
  if (/äºŒåº¦ã¨æ­Œã„ãŸããªã„/.test(memo)) {
    pills.push(`<span class="memo-pill memo-ng">NG</span>`);
  }
  if (/ç·´ç¿’ä¸­/.test(memo)) {
    pills.push(`<span class="memo-pill memo-training">ç·´ç¿’ä¸­</span>`);
  }
  if (keyMatch) {
    pills.push(`<span class="memo-pill memo-key">ã‚­ãƒ¼ ${escape(keyMatch[0])}</span>`);
  }

  // è¡¨ç¤ºç”¨ã«ãƒ¡ãƒ¢ã‹ã‚‰ã‚­ãƒ¼æƒ…å ±ã‚’æ¶ˆã™
  let memoForView = memo;
  if (keyMatch) {
    memoForView = memoForView.replace(keyMatch[0], "").trim();
    memoForView = memoForView.replace(/[\/ï½œ|ãƒ»:ï¼šã€ã€‚-]+$/,"").trim();
  }

  const memoText = memoForView
    ? `<div class="memo-text">${escape(memoForView)}</div>`
    : "";

  return `
    <div class="song-card" style="--i:${i}">
      <div class="song-title">${title}</div>
      <div class="song-artist">${artist}</div>
      <div class="song-pills">${pills.join(" ")}</div>
      ${memoText}
    </div>
  `;
}


/* =========================================================
   5. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆæ“ä½œã‚’å—ã‘ä»˜ã‘ã‚‹ï¼‰
   ========================================================= */

// æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã«å…¥åŠ›ã—ãŸã¨ã
searchInput.addEventListener("input", (e)=>{
  keyword = e.target.value;
  render();
});

// ä¸¦ã³æ›¿ãˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’å¤‰ãˆãŸã¨ã
sortSelect.addEventListener("change", (e) => {
  currentSort = e.target.value;
  render();
});


/* =========================================================
   6. ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆæ©Ÿèƒ½
   ========================================================= */

// ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãƒªã‚¹ãƒˆï¼ˆçµã‚Šè¾¼ã¿å¾Œï¼‰ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
function getCurrentList() {
  let list = allSongs.slice();
  if (filteredCategory !== "all") {
    list = list.filter(s => (s.category || "other") === filteredCategory);
  }
  const kw = keyword.toLowerCase();
  if (kw) {
    list = list.filter(s =>
      `${s.title||""} ${s.artist||""} ${s.memo||""}`.toLowerCase().includes(kw)
    );
  }
  return list;
}

// ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚
if (rouletteBtn) {
  rouletteBtn.addEventListener("click", () => {
    const list = getCurrentList();
    
    if (list.length === 0) {
      alert("é¸ã¹ã‚‹æ›²ãŒã‚ã‚Šã¾ã›ã‚“ï¼");
      return;
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    modal.classList.add("show");
    modalResult.textContent = "æŠ½é¸ä¸­...";

    // ãƒ‰ãƒ©ãƒ ãƒ­ãƒ¼ãƒ«æ¼”å‡º
    let count = 0;
    const maxCount = 20; // ãƒ‘ãƒ©ãƒ‘ãƒ©ã™ã‚‹å›æ•°
    const interval = setInterval(() => {
      // ãƒ©ãƒ³ãƒ€ãƒ ã«ä»®è¡¨ç¤º
      const randomTemp = list[Math.floor(Math.random() * list.length)];
      modalResult.textContent = randomTemp.title;
      count++;

      if (count >= maxCount) {
        clearInterval(interval);
        // â˜…æœ€çµ‚æ±ºå®šâ˜…
        const winner = list[Math.floor(Math.random() * list.length)];
        modalResult.innerHTML = `
          <div style="font-size:0.8em; opacity:0.8;">${winner.artist}</div>
          <div>${winner.title}</div>
        `;
      }
    }, 80); // 0.08ç§’ã”ã¨ã«åˆ‡ã‚Šæ›¿ãˆ
  });
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
if (closeModal) {
  closeModal.addEventListener("click", () => {
    modal.classList.remove("show");
  });
}


/* =========================================================
   7. æœ€å¾Œã«å®Ÿè¡Œ
   ========================================================= */
loadSongs(); // èµ·å‹•ï¼

</script>
</body>
</html>