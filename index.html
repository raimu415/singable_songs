<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>„Çâ„ÅÑ„ÇÄ„ÅÆÊ≠å„Åà„ÇãÊõ≤„É™„Çπ„Éà - GALAXY SYSTEM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    // ‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº
    // „Åì„Åì„Å´„ÅÇ„Å™„Åü„ÅÆ„ÄåfirebaseConfig„Äç„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑÔºÅ
    const firebaseConfig = {
      apiKey: "AIzaSyD...", 
      authDomain: "...",
      databaseURL: "https://...",
      projectId: "...",
      storageBucket: "...",
      messagingSenderId: "...",
      appId: "..."
    };
    // ‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    window.db = db;
    window.dbRef = ref;
    window.dbOnValue = onValue;
    window.dbRunTransaction = runTransaction;
  </script>

<style>
/* „Éô„Éº„ÇπË®≠ÂÆö */
:root {
  --text-main: #e5e7eb; --text-sub: #9ca3af;
  --accent: #60a5fa; --neon-pink: #ec4899; --neon-blue: #60a5fa; --like-color: #f43f5e;
}
* { box-sizing: border-box; }
body { margin: 0; font-family: "Segoe UI", sans-serif; color: var(--text-main); background: #000; overflow-x: hidden; }

/* ÂÆáÂÆôÁ©∫Èñì„Ç≥„É≥„ÉÜ„Éä */
#galaxy-container {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: #000; z-index: 9000; opacity: 0; pointer-events: none; transition: opacity 0.5s;
}
#galaxy-container.active { opacity: 1; pointer-events: auto; z-index: 99999; }
#galaxy-ui { position: absolute; top: 20px; left: 20px; pointer-events: none; z-index: 100000; }
.galaxy-btn {
  pointer-events: auto; background: rgba(0,0,0,0.7); border: 1px solid var(--neon-blue); color: var(--neon-blue);
  padding: 10px 20px; border-radius: 999px; cursor: pointer; font-family: monospace; font-weight: bold;
  text-shadow: 0 0 5px var(--neon-blue); transition: 0.3s;
}
.galaxy-btn:hover { background: var(--neon-blue); color: #000; box-shadow: 0 0 20px var(--neon-blue); }

/* Êòü„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó */
#star-tooltip {
  position: absolute; top: 0; left: 0; background: rgba(15, 23, 42, 0.9); border: 1px solid var(--neon-pink);
  padding: 10px 15px; border-radius: 8px; color: #fff; pointer-events: none; opacity: 0; transition: opacity 0.2s;
  transform: translate(15px, 15px); box-shadow: 0 0 15px var(--neon-pink); z-index: 100001;
}
#star-tooltip .tt-title { font-weight: bold; font-size: 1rem; }
#star-tooltip .tt-artist { font-size: 0.8rem; color: #ccc; }

/* „Ç≥„É≥„ÉÜ„Éä */
.container { max-width: 960px; margin: 0 auto; padding: 16px 14px 40px; position: relative; z-index: 10; }

/* ËÉåÊôØ„Éª„Ç®„Éï„Çß„ÇØ„Éà */
#matrix-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -10; opacity: 0.4; }
.visualizer-container { position: fixed; bottom: 0; left: 0; width: 100%; height: 50vh; display: flex; align-items: flex-end; justify-content: space-around; z-index: -5; pointer-events: none; opacity: 0.5; mask-image: linear-gradient(to top, black, transparent 80%); }
.viz-bar { width: 8px; margin: 0 2px; background: linear-gradient(to top, var(--neon-blue), var(--neon-pink)); box-shadow: 0 0 10px var(--neon-blue); animation: bounceBar infinite ease-in-out alternate; }
@keyframes bounceBar { 0% { height: 2%; opacity: 0.3; } 100% { height: 80%; opacity: 1; filter: brightness(1.5); } }
#cursor-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9990; mix-blend-mode: screen; }

/* Ëµ∑ÂãïÁîªÈù¢ */
#boot-screen { position: fixed; inset: 0; background: #000; z-index: 99999; display: flex; flex-direction: column; justify-content: flex-end; padding: 40px; font-family: "Courier New", monospace; color: #0f0; font-size: 1rem; line-height: 1.4; transition: opacity 0.5s ease; }
#boot-screen.fadeout { opacity: 0; pointer-events: none; }
.boot-log { animation: swiftUp 0.2s ease-out forwards; }
@keyframes swiftUp { from { opacity:0; transform: translateY(20px); } to { opacity:1; transform:translateY(0); } }

/* UI */
header { position: sticky; top: 0; padding: 8px 0 10px; z-index: 30; }
.header-inner { padding: 16px; background: rgba(15, 23, 42, 0.9); border-radius: 20px; border: 1px solid rgba(96, 165, 250, 0.3); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); backdrop-filter: blur(10px); }
h1 { margin: 0; font-size: 1.9rem; text-align: center; font-weight: 900; letter-spacing: 0.15em; color: #fff; text-shadow: 0 0 5px var(--neon-blue), 0 0 10px var(--neon-blue), 0 0 20px var(--neon-pink); }
h1.glitch-effect { position: relative; animation: textGlitch 3s infinite alternate; }
@keyframes textGlitch { 0%, 100% { transform: translate(0); opacity: 1; } 94% { transform: translate(-3px, 2px) skew(10deg); opacity: 0.8; text-shadow: -2px 0 red, 2px 0 blue; } 96% { transform: translate(3px, -2px) skew(-10deg); opacity: 0.8; text-shadow: 2px 0 red, -2px 0 blue; } 98% { transform: translate(0); opacity: 1; } }
.tagline, .note { text-align: center; color: var(--text-sub); font-size: 0.8rem; }

.controls-toggle-row { margin-top: 8px; text-align: right; }
.controls-toggle, .filter-btn, .sort-select, .search-box input { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(148, 163, 184, 0.5); color: var(--text-main); border-radius: 999px; transition: all 0.2s; }
.filter-btn.active { background: linear-gradient(135deg, var(--neon-blue), var(--neon-pink)); border-color: transparent; color: #fff; box-shadow: 0 0 15px var(--neon-blue); }
.controls { max-height: 500px; overflow: hidden; transition: 0.3s ease; }
.controls.collapsed { max-height: 0; opacity: 0; pointer-events: none; }

.song-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px; margin-top: 20px; }
.song-card { position: relative; padding: 16px 20px; border-radius: 16px; background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(96, 165, 250, 0.3); box-shadow: 0 4px 15px rgba(0,0,0,0.3); backdrop-filter: blur(5px); overflow: hidden; perspective: 1000px; transform-style: preserve-3d; transition: transform 0.1s ease-out, box-shadow 0.2s, border-color 0.2s; animation: fadeUp 0.5s ease forwards; animation-delay: calc(var(--i) * 0.03s); opacity: 0; }
@keyframes fadeUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
.song-card > * { transform: translateZ(20px); position: relative; z-index: 2; }
.song-card:hover { border-color: var(--neon-blue); box-shadow: 0 0 20px rgba(96, 165, 250, 0.6), inset 0 0 10px rgba(96, 165, 250, 0.3); }
.song-card::after { content: ""; position: absolute; top: -50%; left: 0; width: 100%; height: 20px; background: linear-gradient(to bottom, transparent, var(--neon-blue), transparent); opacity: 0; z-index: 1; pointer-events: none; filter: blur(4px) brightness(2); }
.song-card:hover::after { opacity: 1; animation: scanline 1.2s ease-in-out infinite; }
@keyframes scanline { 0% { top: -20%; opacity: 0; } 10% { opacity: 1; } 100% { top: 120%; opacity: 0; } }
.song-title { font-size: 1.1rem; font-weight: 900; text-shadow: 0 0 10px var(--neon-blue); }
.song-artist { font-size: 0.9rem; color: #cbd5f5; opacity: 0.9; }

.memo-pill { font-size: 0.7rem; padding: 2px 8px; border-radius: 999px; background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.3); box-shadow: 0 0 5px rgba(255,255,255,0.2); }
.memo-ng { border-color: #f87171; color: #f87171; box-shadow: 0 0 5px #f87171; }
.memo-training { border-color: var(--neon-blue); color: var(--neon-blue); box-shadow: 0 0 5px var(--neon-blue); }
.memo-key { border-color: var(--neon-pink); color: var(--neon-pink); box-shadow: 0 0 5px var(--neon-pink); }

.card-actions { margin-top: 12px; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
.btn-like { display: inline-flex; align-items: center; gap: 6px; background: rgba(244, 63, 94, 0.15); color: #fda4af; border: 1px solid rgba(244, 63, 94, 0.5); padding: 5px 12px; border-radius: 999px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; }
.btn-like:hover { background: rgba(244, 63, 94, 0.8); color: #fff; box-shadow: 0 0 15px var(--like-color); transform: scale(1.05); }
.btn-like:active { transform: scale(0.95); }
.btn-like.liked { animation: popHeart 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
@keyframes popHeart { 0%{ transform:scale(1); } 50%{ transform:scale(1.4); } 100%{ transform:scale(1); } }
.btn-youtube { display: inline-flex; align-items: center; gap: 4px; background: rgba(220, 38, 38, 0.2); color: #fca5a5; border: 1px solid rgba(220, 38, 38, 0.5); padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; text-decoration: none; transition: 0.2s; }
.btn-youtube:hover { background: rgba(220, 38, 38, 0.8); color: #fff; }
.btn-copy { background: transparent; border: 1px solid rgba(148, 163, 184, 0.4); color: var(--text-sub); padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; cursor: pointer; transition: 0.2s; }
.btn-copy:hover { border-color: var(--accent); color: var(--accent); background: rgba(56, 189, 248, 0.1); }

.roulette-btn { background: linear-gradient(45deg, var(--neon-pink), var(--neon-blue)); border: none; padding: 10px 30px; border-radius: 999px; color: #fff; font-weight: bold; cursor: pointer; box-shadow: 0 0 20px var(--neon-pink); transition: 0.2s; }
.roulette-btn:hover { transform: scale(1.05); box-shadow: 0 0 40px var(--neon-pink); filter: brightness(1.2); }

.modal-overlay { position: fixed; inset:0; background: rgba(0,0,0,0.8); z-index: 100; display:flex; justify-content:center; align-items:center; opacity:0; pointer-events:none; transition:0.3s; backdrop-filter:blur(5px); }
.modal-overlay.show { opacity:1; pointer-events:auto; }
.modal-content { background: #1e293b; border: 2px solid var(--neon-blue); padding: 30px; border-radius: 20px; text-align:center; width:90%; max-width:400px; box-shadow: 0 0 50px var(--neon-blue); transform: scale(0.8); transition: 0.3s; }
.modal-overlay.show .modal-content { transform: scale(1); }
.modal-result { font-size: 2rem; font-weight:900; margin: 20px 0; text-shadow: 0 0 20px var(--neon-blue); }

.toast-notification { position:fixed; bottom:30px; left:50%; transform:translate(-50%, 50px); background: var(--neon-blue); color:#fff; padding:8px 24px; border-radius:999px; box-shadow: 0 0 20px var(--neon-blue); opacity:0; transition:0.3s; z-index:200; }
.toast-notification.show { transform:translate(-50%, 0); opacity:1; }

.mute-btn { position: fixed; top: 15px; right: 15px; z-index: 10000; background: rgba(15, 23, 42, 0.8); border: 1px solid var(--text-sub); color: var(--text-sub); padding: 6px 12px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; transition: 0.2s; font-family: monospace; }
.mute-btn:hover { border-color: var(--accent); color: var(--accent); }
.mute-btn.active { color: var(--neon-blue); border-color: var(--neon-blue); text-shadow: 0 0 5px var(--neon-blue); }

/* Èö†„ÅóË¶ÅÁ¥†ÔºöRED ALERT */
body.red-alert { animation: none; }
body.red-alert::before { content: "‚ö†Ô∏è SYSTEM CORRUPTED ‚ö†Ô∏è"; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 5rem; font-weight: 900; color: rgba(255, 0, 0, 0.2); white-space: nowrap; pointer-events: none; z-index: 0; animation: warningPulse 0.5s infinite alternate; }
body.red-alert::after { content: ""; position: fixed; inset: 0; background: red; mix-blend-mode: overlay; animation: alertFlash 0.5s infinite; z-index: 9999; pointer-events: none; }
body.red-alert * { --neon-blue: #ff0000 !important; --neon-pink: #ff4444 !important; --text-main: #ffcccc !important; text-shadow: 0 0 5px red !important; border-color: red !important; }
@keyframes alertFlash { 0% { opacity: 0; } 50% { opacity: 0.3; } 100% { opacity: 0; } }
@keyframes warningPulse { from { transform: translate(-50%, -50%) scale(1); opacity: 0.1; } to { transform: translate(-50%, -50%) scale(1.2); opacity: 0.4; } }

@media screen and (max-width: 768px) {
  .container { padding: 10px 10px 80px; }
  .header-inner { padding: 12px; }
  h1 { font-size: 1.3rem; letter-spacing: 0.05em; }
  .tagline, .note { display: none; }
  .controls-toggle-row { margin-top: 4px; }
  .controls { gap: 6px; }
  .search-box input, .sort-select { padding: 8px 12px; font-size: 0.8rem; }
  .filter-btn { padding: 4px 8px; font-size: 0.65rem; }
  .song-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
  .song-card { padding: 10px; border-radius: 12px; transform: none !important; perspective: none; }
  .song-title { font-size: 0.85rem; }
  .song-artist { font-size: 0.7rem; }
  .memo-text { font-size: 0.65rem; line-height: 1.2; }
  .memo-pill { font-size: 0.6rem; padding: 1px 6px; }
  .btn-copy, .btn-youtube, .btn-like { font-size: 0.6rem; padding: 3px 6px; }
  .card-actions { flex-wrap: wrap; }
  .roulette-btn { padding: 6px 16px; font-size: 0.8rem; }
  #boot-screen { padding: 20px; font-size: 0.8rem; }
}
</style>
</head>
<body>

<div id="boot-screen"></div>
<canvas id="matrix-canvas"></canvas>
<canvas id="cursor-canvas"></canvas>
<div class="visualizer-container" id="visualizer"></div>
<button id="muteBtn" class="mute-btn">üîá MUTE</button>

<div id="galaxy-container">
  <div id="galaxy-ui">
    <button id="exitGalaxyBtn" class="galaxy-btn">üîô EXIT GALAXY</button>
  </div>
  <div id="star-tooltip">
    <div class="tt-title">Title</div>
    <div class="tt-artist">Artist</div>
  </div>
</div>

<div class="container">
  <header>
    <div class="header-inner">
      <div style="text-align:center; font-size:0.7rem; color:var(--text-sub); opacity:0.8;">Last Update: <span id="lastUpdateTime">--</span></div>
      <h1 class="glitch-effect" data-text="„Çâ„ÅÑ„ÇÄ„ÅÆÊ≠å„Åà„ÇãÊõ≤„É™„Çπ„Éà üé§">„Çâ„ÅÑ„ÇÄ„ÅÆÊ≠å„Åà„ÇãÊõ≤„É™„Çπ„Éà üé§</h1>
      <div class="tagline">ÈÖç‰ø°„ÅßÊ≠å„Åà„ÇãÔºàÊ≠å„ÅÑ„Åü„ÅÑÔºâÊõ≤„Çí„Åæ„Å®„ÇÅ„Åü„Éö„Éº„Ç∏</div>
      
      <div style="text-align:center; margin: 15px 0;">
        <button id="rouletteBtn" class="roulette-btn">üé≤ „Çµ„Ç§„Éê„Éº„Åä„Åæ„Åã„ÅõÈÅ∏Êõ≤</button>
      </div>
      <div style="text-align:center; margin-bottom: 10px;">
        <button id="enterGalaxyBtn" class="galaxy-btn" style="border-color:var(--neon-pink); color:var(--neon-pink);">üåå GALAXY MODE</button>
      </div>

      <div class="controls-toggle-row">
        <button id="controlsToggle" class="controls-toggle">‚ñ≤ Ê§úÁ¥¢„ÇíÈñâ„Åò„Çã</button>
      </div>
      <div id="controls" class="controls">
        <div style="margin: 10px 0; display:flex; gap:10px; flex-wrap:wrap;">
          <input type="text" id="searchInput" placeholder="üîç Ê§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ..." style="flex:1; padding:8px 16px;">
          <select id="sortSelect" class="sort-select">
            <option value="default">ÁôªÈå≤È†Ü</option>
            <option value="artist">„Ç¢„Éº„ÉÜ„Ç£„Çπ„ÉàÈ†Ü</option>
            <option value="title">Êõ≤ÂêçÈ†Ü</option>
            <option value="likes">„ÅÑ„ÅÑ„Å≠È†Ü ‚ù§Ô∏è</option>
          </select>
        </div>
        <div class="filter-row" id="filterRow"></div>
      </div>
    </div>
  </header>

  <main id="songSections"></main>

  <footer style="text-align:center; margin-top:40px; color:var(--text-sub); font-size:0.75rem;">
    Êõ¥Êñ∞Êó•: <span id="updatedDate"></span>
  </footer>
</div>

<div id="rouletteModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-title">Target Acquired:</div>
    <div id="rouletteResult" class="modal-result">???</div>
    <button id="closeModal" class="filter-btn" style="margin-top:20px;">Èñâ„Åò„Çã</button>
  </div>
</div>
<div id="toast" class="toast-notification">DATA COPIED TO CLIPBOARD</div>

<script>
// =========================================================
// JS: Âü∫Êú¨Â§âÊï∞
// =========================================================
const CATEGORY_LABELS = { all:"ALL", jpop:"J-POP", anime:"ANIME/GAME", vocaloid:"VOCALOID", other:"OTHER", ng:"NG", training:"TRAINING", acoustic:"ACOUSTIC" };
const CATEGORY_ORDER = ["jpop", "anime", "vocaloid", "other", "ng", "training", "acoustic"];
let allSongs=[], filteredCategory="all", keyword="", currentSort="default";
let likesData = {};

const els = {
  sections: document.getElementById("songSections"), search: document.getElementById("searchInput"),
  filter: document.getElementById("filterRow"), controls: document.getElementById("controls"),
  toggle: document.getElementById("controlsToggle"), sort: document.getElementById("sortSelect"),
  roulette: document.getElementById("rouletteBtn"), modal: document.getElementById("rouletteModal"),
  result: document.getElementById("rouletteResult"), close: document.getElementById("closeModal"),
  toast: document.getElementById("toast")
};

// =========================================================
// Audio System
// =========================================================
const AudioSys = {
  ctx: null, isMuted: true,
  init: function() {
    window.AudioContext = window.AudioContext || window.webkitAudioContext;
    this.ctx = new AudioContext();
    this.setupEvents();
  },
  toggle: function() {
    this.isMuted = !this.isMuted;
    const btn = document.getElementById("muteBtn");
    if (this.isMuted) { btn.textContent = "üîá MUTE"; btn.classList.remove("active"); }
    else { if (this.ctx.state === 'suspended') this.ctx.resume(); btn.textContent = "üîä SOUND ON"; btn.classList.add("active"); this.play("active"); }
  },
  play: function(type) {
    if (this.isMuted || !this.ctx) return;
    const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
    osc.connect(gain); gain.connect(this.ctx.destination);
    const now = this.ctx.currentTime;
    if (type === "hover") { osc.type = "sine"; osc.frequency.setValueAtTime(800, now); osc.frequency.exponentialRampToValueAtTime(1200, now + 0.05); gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.05); osc.start(now); osc.stop(now + 0.05); } 
    else if (type === "click") { osc.type = "square"; osc.frequency.setValueAtTime(200, now); osc.frequency.exponentialRampToValueAtTime(50, now + 0.1); gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1); osc.start(now); osc.stop(now + 0.1); }
    else if (type === "like") { osc.type = "triangle"; osc.frequency.setValueAtTime(1000, now); osc.frequency.linearRampToValueAtTime(2000, now + 0.1); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0.001, now + 0.3); osc.start(now); osc.stop(now + 0.3); }
    else if (type === "roulette") { osc.type = "sawtooth"; osc.frequency.setValueAtTime(100, now); gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.05); osc.start(now); osc.stop(now + 0.05); }
    else if (type === "win") { this.playTone(440, "triangle", 0.5); this.playTone(554, "triangle", 0.5); this.playTone(659, "triangle", 0.5); }
    else if (type === "active") { osc.type = "sine"; osc.frequency.setValueAtTime(100, now); osc.frequency.exponentialRampToValueAtTime(600, now + 0.3); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0.001, now + 0.5); osc.start(now); osc.stop(now + 0.5); }
  },
  playTone: function(freq, type, dur) { const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain(); osc.connect(gain); gain.connect(this.ctx.destination); osc.type = type; osc.frequency.setValueAtTime(freq, this.ctx.currentTime); gain.gain.setValueAtTime(0.1, this.ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + dur); osc.start(); osc.stop(this.ctx.currentTime + dur); },
  setupEvents: function() {
    document.body.addEventListener("mouseover", (e) => { if (e.target.closest("button, a, .song-card")) this.play("hover"); });
    document.body.addEventListener("mousedown", (e) => { if (e.target.closest("button, a, .song-card")) this.play("click"); });
  }
};
AudioSys.init();
document.getElementById("muteBtn").onclick = () => AudioSys.toggle();

// =========================================================
// Main Logic
// =========================================================
if(els.toggle) els.toggle.onclick = () => els.controls.classList.toggle("collapsed");
if(els.search) els.search.oninput = e => { keyword=e.target.value; render(); };
if(els.sort) els.sort.onchange = e => { currentSort=e.target.value; render(); window.scrollTo({top:0, behavior:'smooth'}); };
if(els.close) els.close.onclick = () => els.modal.classList.remove("show");

const escape = s => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
const normalize = songs => songs.map(s => (s.memo&&s.memo.includes("Âºæ„ÅçË™û„Çä")&&s.category!=="acoustic") ? {...s, category:"acoustic"} : s);

(function(){
  const d=new Date(document.lastModified), t=`${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
  ["lastUpdateTime","updatedDate"].forEach(id=>{ const e=document.getElementById(id); if(e)e.textContent=t; });
})();

// Firebase Sync
function startLikesSync() {
  if (!window.db) return;
  const likesRef = window.dbRef(window.db, 'likes');
  window.dbOnValue(likesRef, (snapshot) => {
    likesData = snapshot.val() || {};
    updateAllLikeCounts();
    if (currentSort === 'likes') render();
  });
}
function updateAllLikeCounts() {
  document.querySelectorAll('.btn-like').forEach(btn => {
    const title = btn.dataset.title;
    const safeTitle = title.replace(/[.#$/[\]]/g, "_");
    btn.querySelector('.count').textContent = likesData[safeTitle] || 0;
  });
}

// Load & Render
async function loadSongs() {
  try {
    const res = await fetch("songs.json", { cache:"no-store" }); if(!res.ok) throw new Error(res.status);
    allSongs = normalize(await res.json());
    buildFilters(); render(); startLikesSync();
  } catch(e) { els.sections.innerHTML = `<p style='text-align:center;margin-top:20px;color:red;'>SYSTEM ERROR: ${e.message}</p>`; }
}

function buildFilters() {
  if(!els.filter) return;
  const counts = allSongs.reduce((a,s)=>{ a.all++; a[s.category||"other"]=(a[s.category||"other"]||0)+1; return a; },{all:0});
  els.filter.innerHTML = ["all",...CATEGORY_ORDER].map(cat => 
    `<button class="filter-btn ${cat===filteredCategory?'active':''}" onclick="setCat('${cat}')">${CATEGORY_LABELS[cat]} (${counts[cat]||0})</button>`
  ).join("");
}
window.setCat = cat => { filteredCategory=cat; buildFilters(); render(); window.scrollTo({top:0, behavior:'smooth'}); };

function render() {
  let list = allSongs.filter(s => (filteredCategory==="all" || (s.category||"other")===filteredCategory) && `${s.title} ${s.artist} ${s.memo}`.toLowerCase().includes(keyword.toLowerCase()));
  if(currentSort === "likes") {
    list.sort((a,b) => (likesData[b.title.replace(/[.#$/[\]]/g, "_")]||0) - (likesData[a.title.replace(/[.#$/[\]]/g, "_")]||0));
  } else if(currentSort!=="default") {
    list.sort((a,b) => (a[currentSort]||"").toString().localeCompare((b[currentSort]||"").toString(),"ja"));
  }
  
  if(!list.length) { els.sections.innerHTML = "<p style='text-align:center;opacity:0.6;'>NO DATA FOUND</p>"; return; }
  
  const groups = list.reduce((g,s)=>{ (g[s.category||"other"]||=[]).push(s); return g; }, {});
  if (currentSort === "likes") {
     els.sections.innerHTML = `<h2 style="color:var(--neon-pink); text-align:center; margin-bottom:20px;">‚ù§Ô∏è „ÅÑ„ÅÑ„Å≠„É©„É≥„Ç≠„É≥„Ç∞</h2>
     <div class="song-grid">${list.map((s,i)=>renderCard(s,i)).join("")}</div>`;
  } else {
    els.sections.innerHTML = CATEGORY_ORDER.filter(c=>groups[c]).map(cat => `
      <h2 style="color:var(--neon-blue); border-left:4px solid var(--neon-blue); padding-left:10px; margin:20px 0 10px;">${CATEGORY_LABELS[cat]}</h2>
      <div class="song-grid">${groups[cat].map((s,i)=>renderCard(s,i)).join("")}</div>
    `).join("");
  }
  updateAllLikeCounts();
}

function renderCard(s, i) {
  const key = s.memo ? (s.memo.match(/[-+]\d+/) || [""])[0] : "";
  const memoView = s.memo ? escape(s.memo.replace(key,"").trim().replace(/[\/ÔΩú|„Éª:Ôºö„ÄÅ„ÄÇ-]+$/,"")) : "";
  const copyText = escape(`${s.title} / ${s.artist||""}`);
  const safeTitle = s.title.replace(/[.#$/[\]]/g, "_");
  
  let pills = [];
  if(/ng/i.test(s.memo)) pills.push(`<span class="memo-pill memo-ng">NG</span>`);
  if(/Á∑¥Áøí‰∏≠/.test(s.memo)) pills.push(`<span class="memo-pill memo-training">TRAINING</span>`);
  if(key) pills.push(`<span class="memo-pill memo-key">KEY ${key}</span>`);

  return `<div class="song-card" style="--i:${i}">
    <div class="song-title">${escape(s.title)}</div>
    <div class="song-artist">${escape(s.artist||"")}</div>
    <div style="margin-top:8px; display:flex; gap:4px; flex-wrap:wrap;">${pills.join("")}</div>
    ${memoView ? `<div style="margin-top:8px; font-size:0.8rem; opacity:0.8;">${memoView}</div>` : ""}
    <div class="card-actions">
      <button class="btn-like" data-title="${escape(s.title)}" onclick="addLike('${escape(safeTitle)}', this)">‚ù§Ô∏è <span class="count">0</span></button>
      <button class="btn-copy" onclick="doCopy('${copyText}')">üìã COPY</button>
      ${s.url ? `<a href="${escape(s.url)}" target="_blank" class="btn-youtube">‚ñ∂ YOUTUBE</a>` : ""}
    </div>
  </div>`;
}

window.addLike = (safeTitle, btn) => {
  if (!window.db) { alert("FirebaseÊú™Ë®≠ÂÆö"); return; }
  AudioSys.play("like");
  btn.classList.add('liked'); setTimeout(()=>btn.classList.remove('liked'), 300);
  const likeRef = window.dbRef(window.db, 'likes/' + safeTitle);
  window.dbRunTransaction(likeRef, (currentLikes) => (currentLikes || 0) + 1);
};
window.doCopy = t => navigator.clipboard.writeText(t).then(()=>{ els.toast.classList.add("show"); setTimeout(()=>els.toast.classList.remove("show"),2000); });

if(els.roulette) els.roulette.addEventListener("click", () => {
  let list = allSongs.filter(s => (filteredCategory==="all" || (s.category||"other")===filteredCategory) && `${s.title} ${s.artist}`.toLowerCase().includes(keyword.toLowerCase()));
  if(!list.length) return alert("NO DATA");
  els.modal.classList.add("show"); els.result.innerHTML = "SCANNING...";
  let c=0;
  const interval = setInterval(() => {
    AudioSys.play("roulette");
    els.result.textContent = list[Math.floor(Math.random()*list.length)].title;
    if(++c>=20) { clearInterval(interval); AudioSys.play("win"); const w=list[Math.floor(Math.random()*list.length)]; els.result.innerHTML=`<div style="font-size:0.8em;opacity:0.7">${w.artist}</div><div>${w.title}</div>`; }
  }, 70);
});

// =========================================================
// 3D GALAXY SYSTEM
// =========================================================
const GalaxySys = {
  active: false, scene: null, camera: null, renderer: null, controls: null, stars: [], raycaster: null, mouse: null, container: document.getElementById('galaxy-container'), tooltip: document.getElementById('star-tooltip'), animationId: null,
  init: function() {
    this.scene = new THREE.Scene(); this.scene.fog = new THREE.FogExp2(0x000000, 0.002);
    this.camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 1000); this.camera.position.z = 1; this.camera.rotation.x = Math.PI/2;
    this.renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true }); this.renderer.setPixelRatio(window.devicePixelRatio); this.renderer.setSize(window.innerWidth, window.innerHeight); this.container.appendChild(this.renderer.domElement);
    this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement); this.controls.enableDamping = true; this.controls.dampingFactor = 0.05; this.controls.autoRotate = true; this.controls.autoRotateSpeed = 0.5;
    this.raycaster = new THREE.Raycaster(); this.mouse = new THREE.Vector2();
    window.addEventListener('resize', () => this.onResize()); this.container.addEventListener('mousemove', (e) => this.onMouseMove(e)); this.container.addEventListener('click', () => this.onClick());
  },
  createStars: function() {
    // „Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂâç„Å™„ÇâÂæÖÊ©ü
    if(!allSongs.length) return;
    // „É™„Çª„ÉÉ„Éà
    this.stars.forEach(s=>this.scene.remove(s)); this.stars=[];
    
    const getStarMaterial = (color) => {
      const canvas = document.createElement('canvas'); canvas.width = 32; canvas.height = 32; const ctx = canvas.getContext('2d');
      const grad = ctx.createRadialGradient(16,16,0, 16,16,16); grad.addColorStop(0, 'rgba(255,255,255,1)'); grad.addColorStop(0.2, color); grad.addColorStop(0.5, 'rgba(0,0,0,1)'); grad.addColorStop(1, 'rgba(0,0,0,0)');
      ctx.fillStyle = grad; ctx.fillRect(0,0,32,32); return new THREE.SpriteMaterial({ map: new THREE.CanvasTexture(canvas), transparent: true, blending: THREE.AdditiveBlending });
    };
    const matBlue = getStarMaterial('rgba(96, 165, 250, 1)'); const matPink = getStarMaterial('rgba(236, 72, 153, 1)');
    allSongs.forEach((song, i) => {
      const sprite = new THREE.Sprite((i % 2 === 0) ? matBlue : matPink);
      const r = 200 + Math.random() * 300; const theta = Math.random() * Math.PI * 2; const phi = Math.acos((Math.random() * 2) - 1);
      sprite.position.set(r * Math.sin(phi) * Math.cos(theta), r * Math.sin(phi) * Math.sin(theta), r * Math.cos(phi));
      sprite.scale.set(8, 8, 1); sprite.userData = { song: song };
      this.scene.add(sprite); this.stars.push(sprite);
    });
    // ËÉåÊôØÊòü
    const geo = new THREE.BufferGeometry(); const vert = [];
    for (let i = 0; i < 1000; i++) vert.push((Math.random()-0.5)*2000, (Math.random()-0.5)*2000, (Math.random()-0.5)*2000);
    geo.setAttribute('position', new THREE.Float32BufferAttribute(vert, 3)); this.scene.add(new THREE.Points(geo, new THREE.PointsMaterial({ color: 0x888888, size: 2 })));
  },
  animate: function() {
    if (!this.active) return;
    this.animationId = requestAnimationFrame(() => this.animate()); this.controls.update();
    this.raycaster.setFromCamera(this.mouse, this.camera); const intersects = this.raycaster.intersectObjects(this.stars);
    if (intersects.length > 0) {
      const target = intersects[0].object; const song = target.userData.song;
      this.tooltip.style.opacity = 1; this.tooltip.querySelector('.tt-title').textContent = song.title; this.tooltip.querySelector('.tt-artist').textContent = song.artist;
      document.body.style.cursor = 'pointer'; target.scale.set(15, 15, 1);
    } else { this.tooltip.style.opacity = 0; document.body.style.cursor = 'default'; this.stars.forEach(s => s.scale.set(8, 8, 1)); }
    this.renderer.render(this.scene, this.camera);
  },
  onResize: function() { if (!this.camera) return; this.camera.aspect = window.innerWidth / window.innerHeight; this.camera.updateProjectionMatrix(); this.renderer.setSize(window.innerWidth, window.innerHeight); },
  onMouseMove: function(event) { this.mouse.x = (event.clientX / window.innerWidth) * 2 - 1; this.mouse.y = -(event.clientY / window.innerHeight) * 2 + 1; this.tooltip.style.left = (event.clientX + 15) + 'px'; this.tooltip.style.top = (event.clientY + 15) + 'px'; },
  onClick: function() {
    this.raycaster.setFromCamera(this.mouse, this.camera); const intersects = this.raycaster.intersectObjects(this.stars);
    if (intersects.length > 0) {
      const song = intersects[0].object.userData.song;
      AudioSys.play("like");
      const modal = document.getElementById("rouletteModal"); const result = document.getElementById("rouletteResult");
      modal.classList.add("show"); result.innerHTML = `<div style="font-size:0.8em;opacity:0.7">${song.artist}</div><div>${song.title}</div>`;
    }
  },
  open: function() {
    this.active = true; this.container.classList.add('active');
    if (!this.scene) this.init();
    this.createStars(); // Èñã„Åè„Åü„Å≥„Å´ÊúÄÊñ∞„ÅÆÊõ≤„É™„Çπ„Éà„ÅßÂÜçÁîüÊàê
    this.animate(); AudioSys.play("active");
  },
  close: function() { this.active = false; this.container.classList.remove('active'); cancelAnimationFrame(this.animationId); }
};
document.getElementById('enterGalaxyBtn').addEventListener('click', () => GalaxySys.open());
document.getElementById('exitGalaxyBtn').addEventListener('click', () => GalaxySys.close());

// Effects & Hidden Features
const secretCode = ['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','b','a']; let inputSequence = [];
document.addEventListener('keydown', (e) => {
  inputSequence.push(e.key); if (inputSequence.length > secretCode.length) inputSequence.shift();
  if (JSON.stringify(inputSequence) === JSON.stringify(secretCode)) activateRedAlert();
});
function activateRedAlert() {
  const body = document.body;
  if (body.classList.contains('red-alert')) { body.classList.remove('red-alert'); alert("SYSTEM RESTORED."); }
  else { body.classList.add('red-alert'); if(!AudioSys.isMuted) playSiren(); }
}
function playSiren() {
  if (!AudioSys.ctx) return; const osc = AudioSys.ctx.createOscillator(); const gain = AudioSys.ctx.createGain(); osc.connect(gain); gain.connect(AudioSys.ctx.destination); osc.type = 'sawtooth'; gain.gain.value = 0.1; const now = AudioSys.ctx.currentTime;
  osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(800, now + 0.5); osc.frequency.linearRampToValueAtTime(400, now + 1.0); osc.frequency.linearRampToValueAtTime(800, now + 1.5); osc.frequency.linearRampToValueAtTime(400, now + 2.0); gain.gain.linearRampToValueAtTime(0.01, now + 2.0); osc.start(now); osc.stop(now + 2.0);
}
const mCanvas=document.getElementById("matrix-canvas"), mCtx=mCanvas.getContext("2d"); let mCols, mDrops;
function initMatrix(){ mCanvas.width=innerWidth; mCanvas.height=innerHeight; mCols=Math.floor(innerWidth/20); mDrops=Array(mCols).fill(1); }
function drawMatrix(){ mCtx.fillStyle="rgba(0,0,0,0.05)"; mCtx.fillRect(0,0,innerWidth,innerHeight); mCtx.fillStyle="#0f0"; mCtx.font="15px monospace"; for(let i=0; i<mDrops.length; i++){ mCtx.fillText(String.fromCharCode(0x30A0+Math.random()*96), i*20, mDrops[i]*20); if(mDrops[i]*20>innerHeight && Math.random()>0.975) mDrops[i]=0; mDrops[i]++; } requestAnimationFrame(drawMatrix); }
window.onresize=initMatrix; initMatrix(); drawMatrix();
const cCanvas=document.getElementById("cursor-canvas"), cCtx=cCanvas.getContext("2d"); let particles=[];
window.addEventListener("resize", ()=>{ cCanvas.width=innerWidth; cCanvas.height=innerHeight; }); window.dispatchEvent(new Event("resize"));
window.onmousemove = e => { for(let i=0;i<4;i++) particles.push({x:e.clientX, y:e.clientY, vx:(Math.random()-0.5)*4, vy:(Math.random()-0.5)*4, life:1, color:`hsl(${Math.random()*60+180},100%,70%)`}); };
function animateParticles(){ cCtx.clearRect(0,0,innerWidth,innerHeight); particles.forEach((p,i)=>{ p.x+=p.vx; p.y+=p.vy; p.life-=0.02; cCtx.fillStyle=p.color; cCtx.globalAlpha=p.life; cCtx.beginPath(); cCtx.arc(p.x,p.y,Math.random()*3+1,0,Math.PI*2); cCtx.fill(); if(p.life<=0) particles.splice(i,1); }); requestAnimationFrame(animateParticles); }
animateParticles();
const viz=document.getElementById("visualizer"); for(let i=0;i<40;i++){ const b=document.createElement("div"); b.className="viz-bar"; b.style.animationDuration=(0.4+Math.random()*0.6)+"s"; viz.appendChild(b); }
const boot=document.getElementById("boot-screen"), logs=["INITIALIZING KERNEL...", "LOADING NEON_INTERFACE_V4...", "CONNECTING TO CYBER_SONG_DB...", "BYPASSING SECURITY...", "SYSTEM READY."];
window.onload = async () => { for(const log of logs) { const p=document.createElement("div"); p.textContent="> "+log; boot.appendChild(p); await new Promise(r=>setTimeout(r, 250+Math.random()*300)); } boot.style.opacity=0; setTimeout(()=>{ boot.style.display="none"; loadSongs(); }, 500); };
</script>
</body>
</html>