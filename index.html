<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>„Çâ„ÅÑ„ÇÄ„ÅÆÊ≠å„Åà„ÇãÊõ≤„É™„Çπ„Éà - LIVE SYSTEM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD8ZxrKxhL3HXmX6yXiFEAd91kzb5YX_lw",
      authDomain: "raimu-song-list-79b52.firebaseapp.com",
      databaseURL: "https://raimu-song-list-79b52-default-rtdb.firebaseio.com",
      projectId: "raimu-song-list-79b52",
      storageBucket: "raimu-song-list-79b52.firebasestorage.app",
      messagingSenderId: "242038202194",
      appId: "1:242038202194:web:81cd18eb19e8c91084648b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    window.db = db;
    window.dbRef = ref;
    window.dbOnValue = onValue;
    window.dbRunTransaction = runTransaction;
  </script>

<style>
/* =========================================================
   „Éô„Éº„Çπ„Ç´„É©„Éº & Ë®≠ÂÆö
========================================================= */
:root {
  --text-main: #e5e7eb;
  --text-sub: #9ca3af;
  --accent: #60a5fa;
  --neon-pink: #ec4899;
  --neon-blue: #60a5fa;
  --like-color: #f43f5e;
}

body {
  margin: 0;
  font-family: "Segoe UI", "Roboto", system-ui, sans-serif;
  color: var(--text-main);
  background: #000;
  overflow-x: hidden;
}

/* ========== „Åì„Åì„Åã„ÇâËøΩÂä† ========== */

/* Three.js Áî®„ÅÆÂÆáÂÆôÁ©∫Èñì */
#galaxy-container {
  position: fixed;
  inset: 0;
  width: 100%;
  height: 100%;
  background: #000;
  opacity: 0;
  pointer-events: none;
  transition: 0.5s;
  z-index: 9000;
}
#galaxy-container.active {
  opacity: 1;
  pointer-events: auto;
  z-index: 99999;
}

/* „Éõ„Éê„ÉºÊôÇ„ÅÆ„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó */
#star-tooltip {
  position: fixed;
  background: rgba(15,23,42,0.9);
  border: 1px solid var(--neon-pink);
  padding: 10px 15px;
  border-radius: 8px;
  color: #fff;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.2s;
  transform: translate(15px, 15px);
  box-shadow: 0 0 15px var(--neon-pink);
  z-index: 100000;
}
#star-tooltip .tt-title {
  font-weight: bold;
  font-size: 1rem;
  margin-bottom: 2px;
}
#star-tooltip .tt-artist {
  font-size: 0.8rem;
  color: #ccc;
}

/* ÂÆáÂÆô„É¢„Éº„Éâ ON „Éú„Çø„É≥ÔºàÂè≥‰∏ãÂõ∫ÂÆöÔºâ */
#enterGalaxyBtn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 120000;
  padding: 12px 20px;
  border-radius: 999px;
  font-family: monospace;
  font-weight: bold;
  cursor: pointer;
  border: 1px solid var(--neon-blue);
  color: var(--neon-blue);
  background: rgba(0,0,0,0.6);
  box-shadow: 0 0 10px var(--neon-blue);
}
#enterGalaxyBtn:hover {
  background: var(--neon-blue);
  color: #000;
  box-shadow: 0 0 30px var(--neon-blue);
}

/* ÂÆáÂÆô„É¢„Éº„Éâ EXIT „Éú„Çø„É≥ */
#exitGalaxyBtn {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 120000;
  padding: 10px 18px;
  border-radius: 999px;
  font-family: monospace;
  font-weight: bold;
  cursor: pointer;
  border: 1px solid var(--neon-pink);
  color: var(--neon-pink);
  background: rgba(0,0,0,0.6);
  box-shadow: 0 0 10px var(--neon-pink);
  display: none;
}
#exitGalaxyBtn:hover {
  background: var(--neon-pink);
  color: #000;
  box-shadow: 0 0 30px var(--neon-pink);
}

* { box-sizing: border-box; }

.container {
  max-width: 960px; margin: 0 auto; padding: 16px 14px 40px;
  position: relative; z-index: 10;
}

#matrix-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -10; opacity: 0.4; }
.visualizer-container {
  position: fixed; bottom: 0; left: 0; width: 100%; height: 50vh;
  display: flex; align-items: flex-end; justify-content: space-around;
  z-index: -5; pointer-events: none; opacity: 0.5;
  mask-image: linear-gradient(to top, black, transparent 80%);
}
.viz-bar {
  width: 8px; margin: 0 2px;
  background: linear-gradient(to top, var(--neon-blue), var(--neon-pink));
  box-shadow: 0 0 10px var(--neon-blue);
  animation: bounceBar infinite ease-in-out alternate;
}
@keyframes bounceBar {
  0% { height: 2%; opacity: 0.3; }
  100% { height: 80%; opacity: 1; filter: brightness(1.5); }
}

#cursor-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9990; mix-blend-mode: screen; }

#boot-screen {
  position: fixed; inset: 0; background: #000; z-index: 99999;
  display: flex; flex-direction: column; justify-content: flex-end;
  padding: 40px; font-family: "Courier New", monospace; color: #0f0;
  font-size: 1rem; line-height: 1.4; transition: opacity 0.5s ease;
}
#boot-screen.fadeout { opacity: 0; pointer-events: none; }
.boot-log { animation: swiftUp 0.2s ease-out forwards; }
@keyframes swiftUp { from { opacity:0; transform: translateY(20px); } to { opacity:1; transform:translateY(0); } }

header { position: sticky; top: 0; padding: 8px 0 10px; z-index: 30; }
.header-inner {
  padding: 16px; background: rgba(15, 23, 42, 0.9);
  border-radius: 20px; border: 1px solid rgba(96, 165, 250, 0.3);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); backdrop-filter: blur(10px);
}

h1 {
  margin: 0; font-size: 1.9rem; text-align: center; font-weight: 900;
  letter-spacing: 0.15em; color: #fff;
  text-shadow: 0 0 5px var(--neon-blue), 0 0 10px var(--neon-blue), 0 0 20px var(--neon-pink);
}
h1.glitch-effect { position: relative; animation: textGlitch 3s infinite alternate; }
@keyframes textGlitch {
  0%, 100% { transform: translate(0); opacity: 1; }
  94% { transform: translate(-3px, 2px) skew(10deg); opacity: 0.8; text-shadow: -2px 0 red, 2px 0 blue; }
  96% { transform: translate(3px, -2px) skew(-10deg); opacity: 0.8; text-shadow: 2px 0 red, -2px 0 blue; }
  98% { transform: translate(0); opacity: 1; }
}

.tagline, .note { text-align: center; color: var(--text-sub); font-size: 0.8rem; }

.controls-toggle-row { margin-top: 8px; text-align: right; }
.controls-toggle, .filter-btn, .sort-select, .search-box input {
  background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(148, 163, 184, 0.5);
  color: var(--text-main); border-radius: 999px; transition: all 0.2s;
}
.filter-btn.active {
  background: linear-gradient(135deg, var(--neon-blue), var(--neon-pink));
  border-color: transparent; color: #fff; box-shadow: 0 0 15px var(--neon-blue);
}
.controls { max-height: 500px; overflow: hidden; transition: 0.3s ease; }
.controls.collapsed { max-height: 0; opacity: 0; pointer-events: none; }

.song-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px; margin-top: 20px; }

.song-card {
  position: relative; padding: 16px 20px; border-radius: 16px;
  background: rgba(15, 23, 42, 0.6);
  border: 1px solid rgba(96, 165, 250, 0.3);
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  backdrop-filter: blur(5px); overflow: hidden;
  perspective: 1000px; transform-style: preserve-3d;
  transition: transform 0.1s ease-out, box-shadow 0.2s, border-color 0.2s;
  animation: fadeUp 0.5s ease forwards;
  animation-delay: calc(var(--i) * 0.03s); opacity: 0;
}
@keyframes fadeUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }

.song-title { font-size: 1.1rem; font-weight: 900; text-shadow: 0 0 10px var(--neon-blue); }
.song-artist { font-size: 0.9rem; color: #cbd5f5; opacity: 0.9; }

.memo-pill {
  font-size: 0.7rem; padding: 2px 8px; border-radius: 999px;
  background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.3);
  box-shadow: 0 0 5px rgba(255,255,255,0.2);
}
.memo-ng { border-color: #f87171; color: #f87171; box-shadow: 0 0 5px #f87171; }
.memo-training { border-color: var(--neon-blue); color: var(--neon-blue); box-shadow: 0 0 5px var(--neon-blue); }
.memo-key { border-color: var(--neon-pink); color: var(--neon-pink); box-shadow: 0 0 5px var(--neon-pink); }

.card-actions { margin-top: 12px; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }

.btn-like {
  display: inline-flex; align-items: center; gap: 6px;
  background: rgba(244, 63, 94, 0.15); color: #fda4af;
  border: 1px solid rgba(244, 63, 94, 0.5);
  padding: 5px 12px; border-radius: 999px; font-size: 0.8rem;
  cursor: pointer; transition: all 0.2s;
}
.btn-like:hover {
  background: rgba(244, 63, 94, 0.8); color: #fff;
  box-shadow: 0 0 15px var(--like-color); transform: scale(1.05);
}
.btn-like.liked { animation: popHeart 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
@keyframes popHeart {
  0%{ transform:scale(1); } 50%{ transform:scale(1.4); } 100%{ transform:scale(1); }
}

.btn-youtube {
  display: inline-flex; align-items: center; gap: 4px; background: rgba(220, 38, 38, 0.2);
  color: #fca5a5; border: 1px solid rgba(220, 38, 38, 0.5);
  padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; text-decoration: none;
  transition: 0.2s;
}
.btn-youtube:hover { background: rgba(220, 38, 38, 0.8); color: #fff; }

.btn-copy {
  background: transparent; border: 1px solid rgba(148, 163, 184, 0.4); color: var(--text-sub);
  padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; cursor: pointer; transition: 0.2s;
}
.btn-copy:hover { border-color: var(--accent); color: var(--accent); background: rgba(56, 189, 248, 0.1); }

</style>

</head>

<script>
// =========================================================
// JS: Âü∫Êú¨Ë®≠ÂÆöÔºÜ„Éá„Éº„ÇøÁÆ°ÁêÜ
// =========================================================
const CATEGORY_LABELS = {
  all:"ALL", jpop:"J-POP", anime:"ANIME/GAME",
  vocaloid:"VOCALOID", other:"OTHER",
  ng:"NG", training:"TRAINING", acoustic:"ACOUSTIC"
};
const CATEGORY_ORDER = ["jpop","anime","vocaloid","other","ng","training","acoustic"];

let allSongs = [];
let filteredCategory = "all";
let keyword = "";
let currentSort = "default";
let likesData = {};

// DOM ÂèñÂæó
const els = {
  sections: document.getElementById("songSections"),
  search: document.getElementById("searchInput"),
  filter: document.getElementById("filterRow"),
  controls: document.getElementById("controls"),
  toggle: document.getElementById("controlsToggle"),
  sort: document.getElementById("sortSelect"),
  roulette: document.getElementById("rouletteBtn"),
  modal: document.getElementById("rouletteModal"),
  result: document.getElementById("rouletteResult"),
  close: document.getElementById("closeModal"),
  toast: document.getElementById("toast")
};

// „Ç§„Éô„É≥„Éà
if(els.toggle) els.toggle.onclick = () => els.controls.classList.toggle("collapsed");
if(els.search) els.search.oninput = e => { keyword=e.target.value; render(); };
if(els.sort) els.sort.onchange = e => { currentSort = e.target.value; render(); window.scrollTo({ top:0, behavior:'smooth' }); };
if(els.close) els.close.onclick = () => els.modal.classList.remove("show");

const escape = s => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
const normalize = songs => songs.map(s =>
  (s.memo && s.memo.includes("Âºæ„ÅçË™û„Çä") && s.category!=="acoustic")
    ? {...s, category:"acoustic"}
    : s
);

// Êó•‰ªòË°®Á§∫
(function(){
  const d = new Date(document.lastModified);
  const t = `${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
  ["lastUpdateTime","updatedDate"].forEach(id=>{
    const e=document.getElementById(id); if(e) e.textContent=t;
  });
})();

// Firebase likes ÂêåÊúü
function startLikesSync() {
  if (!window.db) return;
  const likesRef = window.dbRef(window.db, 'likes');
  window.dbOnValue(likesRef, (snapshot) => {
    likesData = snapshot.val() || {};
    updateAllLikeCounts();
    if (currentSort === 'likes') render();
  });
}

function updateAllLikeCounts() {
  document.querySelectorAll('.btn-like').forEach(btn => {
    const title = btn.dataset.title;
    const safeTitle = title.replace(/[.#$/[\]]/g, "_");
    btn.querySelector('.count').textContent = likesData[safeTitle] || 0;
  });
}

// ‚òÖ‚òÖ loadSongsÔºàÊõ≤Ë™≠„ÅøËæº„ÅøÂÆå‰∫ÜÂæå„Å´ GalaxySys „ÇíÂàùÊúüÂåñ„Åß„Åç„Çã„Çà„ÅÜ„Éï„É©„Ç∞‰ªò„ÅëÔºâ
let songsLoaded = false;

async function loadSongs() {
  try {
    const res = await fetch("songs.json", { cache:"no-store" }); 
    if(!res.ok) throw new Error(res.status);

    allSongs = normalize(await res.json());
    songsLoaded = true;

    buildFilters();
    render();
    startLikesSync();

    // ‚òÖ GalaxySys „Å´Êõ≤„ÇíÊ∏°„Åõ„Çã„Çà„ÅÜ„Ç§„Éô„É≥„ÉàÁô∫ÁÅ´
    document.dispatchEvent(new Event("songs-ready"));

  } catch(e) {
    els.sections.innerHTML = `<p style='text-align:center;margin-top:20px;color:red;'>SYSTEM ERROR: ${e.message}</p>`;
  }
}

function buildFilters() {
  if(!els.filter) return;
  const counts = allSongs.reduce((a,s)=>{
    a.all++; a[s.category||"other"]=(a[s.category||"other"]||0)+1;
    return a;
  },{all:0});

  els.filter.innerHTML = ["all",...CATEGORY_ORDER].map(cat =>
    `<button class="filter-btn ${cat===filteredCategory?'active':''}"
      onclick="setCat('${cat}')">${CATEGORY_LABELS[cat]} (${counts[cat]||0})</button>`
  ).join("");
}

window.setCat = cat => {
  filteredCategory = cat;
  buildFilters();
  render();
  window.scrollTo({ top:0, behavior:'smooth' });
};

function render() {
  let list = allSongs.filter(s =>
    (filteredCategory==="all" || (s.category||"other")===filteredCategory) &&
    `${s.title} ${s.artist} ${s.memo}`.toLowerCase().includes(keyword.toLowerCase())
  );

  // „ÇΩ„Éº„Éà
  if(currentSort === "likes") {
    list.sort((a,b)=>{
      const A = likesData[a.title.replace(/[.#$/[\]]/g,"_")] || 0;
      const B = likesData[b.title.replace(/[.#$/[\]]/g,"_")] || 0;
      return B - A;
    });
  } else if(currentSort!=="default") {
    list.sort((a,b)=> (a[currentSort]||"").localeCompare((b[currentSort]||""),"ja"));
  }

  if(!list.length){
    els.sections.innerHTML = "<p style='text-align:center;opacity:0.6;'>NO DATA FOUND</p>";
    return;
  }

  const groups = list.reduce((g,s)=>{
    (g[s.category||"other"]||=[]).push(s);
    return g;
  },{});

  if(currentSort === "likes"){
    els.sections.innerHTML =
      `<h2 style="color:var(--neon-pink);text-align:center;margin-bottom:20px;">‚ù§Ô∏è „ÅÑ„ÅÑ„Å≠„É©„É≥„Ç≠„É≥„Ç∞</h2>
       <div class="song-grid">${list.map((s,i)=>renderCard(s,i)).join("")}</div>`;
  } else {
    els.sections.innerHTML =
      CATEGORY_ORDER.filter(c=>groups[c]).map(cat =>
        `<h2 style="color:var(--neon-blue);border-left:4px solid var(--neon-blue);padding-left:10px;margin:20px 0 10px;">
          ${CATEGORY_LABELS[cat]}
         </h2>
         <div class="song-grid">${groups[cat].map((s,i)=>renderCard(s,i)).join("")}</div>`
      ).join("");
  }
  updateAllLikeCounts();
}

function renderCard(s, i) {
  const key = s.memo ? (s.memo.match(/[-+]\d+/)||[""])[0] : "";
  const memoView = s.memo ? escape(s.memo.replace(key,"").trim().replace(/[\/ÔΩú|„Éª:Ôºö„ÄÅ„ÄÇ-]+$/,"")) : "";
  const copyText = escape(`${s.title} / ${s.artist||""}`);
  const safeTitle = s.title.replace(/[.#$/[\]]/g, "_");

  let pills=[];
  if(/ng/i.test(s.memo)) pills.push(`<span class="memo-pill memo-ng">NG</span>`);
  if(/Á∑¥Áøí‰∏≠/.test(s.memo)) pills.push(`<span class="memo-pill memo-training">TRAINING</span>`);
  if(key) pills.push(`<span class="memo-pill memo-key">KEY ${key}</span>`);

  return `
    <div class="song-card" style="--i:${i}">
      <div class="song-title">${escape(s.title)}</div>
      <div class="song-artist">${escape(s.artist||"")}</div>
      <div style="margin-top:8px;display:flex;gap:4px;flex-wrap:wrap;">${pills.join("")}</div>
      ${memoView ? `<div style="margin-top:8px;font-size:0.8rem;opacity:0.8;">${memoView}</div>` : ""}
      <div class="card-actions">
        <button class="btn-like" data-title="${escape(s.title)}"
          onclick="addLike('${safeTitle}', this)">‚ù§Ô∏è <span class="count">0</span></button>
        <button class="btn-copy" onclick="doCopy('${copyText}')">üìã COPY</button>
        ${s.url ? `<a href="${escape(s.url)}" target="_blank" class="btn-youtube">‚ñ∂ YOUTUBE</a>` : ""}
      </div>
    </div>
  `;
}

// ‚òÖ„ÅÑ„ÅÑ„Å≠ËøΩÂä†Âá¶ÁêÜ
window.addLike = (safeTitle, btn) => {
  if (!window.db) { alert("Firebase„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì"); return; }

  // „Ç¢„Éã„É°
  btn.classList.add("liked");
  setTimeout(()=>btn.classList.remove("liked"),300);

  // „Éà„É©„É≥„Ç∂„ÇØ„Ç∑„Éß„É≥„ÅßÂÆâÂÖ®„Å´„Ç§„É≥„ÇØ„É™„É°„É≥„Éà
  const likeRef = window.dbRef(window.db, 'likes/' + safeTitle);
  window.dbRunTransaction(likeRef, (currentLikes)=>{
    return (currentLikes || 0) + 1;
  });

  // „ÅÑ„ÅÑ„Å≠Èü≥
  AudioSys.play("like");
};

// „Ç≥„Éî„Éº
window.doCopy = t =>
  navigator.clipboard.writeText(t).then(()=>{
    els.toast.classList.add("show");
    setTimeout(()=>els.toast.classList.remove("show"),2000);
  });

// „É´„Éº„É¨„ÉÉ„Éà
if(els.roulette) els.roulette.onclick = () => {
  let list = allSongs.filter(s =>
    (filteredCategory==="all" || (s.category||"other")===filteredCategory) &&
    `${s.title} ${s.artist}`.toLowerCase().includes(keyword.toLowerCase())
  );
  if(!list.length) return alert("NO DATA FOR ROULETTE");

  els.modal.classList.add("show");
  els.result.innerHTML = "SCANNING...";

  let c=0;
  const interval = setInterval(()=>{
    els.result.textContent = list[Math.floor(Math.random()*list.length)].title;
    if(++c>20){
      clearInterval(interval);
      const w = list[Math.floor(Math.random()*list.length)];
      els.result.innerHTML = `<div style="font-size:0.8em;opacity:0.7">${w.artist}</div><div>${w.title}</div>`;
      AudioSys.play("win");
    } else {
      AudioSys.play("roulette");
    }
  }, 70);
};

// ============ 3D Tilt Effect ============
if(window.innerWidth > 768){
  document.addEventListener('mousemove', e => {
    document.querySelectorAll('.song-card').forEach(c=>{
      const r = c.getBoundingClientRect();
      if(r.top > innerHeight || r.bottom < 0) return;
      c.style.transform =
        `perspective(1000px)
        rotateX(${(e.clientY-(r.top+r.height/2)) * -0.04}deg)
        rotateY(${(e.clientX-(r.left+r.width/2)) * 0.04}deg)
        scale(1.02)`;
    });
  });
  document.addEventListener('mouseleave', () => {
    document.querySelectorAll('.song-card').forEach(c=>{
      c.style.transform='perspective(1000px) rotateX(0) rotateY(0) scale(1)';
    });
  });
}

// ============ Boot Animation ============
const boot = document.getElementById("boot-screen");
const logs = [
  "INITIALIZING KERNEL...",
  "LOADING NEON_INTERFACE_V4...",
  "CONNECTING TO CYBER_SONG_DB...",
  "BYPASSING SECURITY...",
  "SYSTEM READY."
];

window.onload = async () => {
  for(const log of logs){
    const p = document.createElement("div");
    p.textContent = "> " + log;
    boot.appendChild(p);
    await new Promise(r=>setTimeout(r,250+Math.random()*300));
  }
  boot.style.opacity = 0;
  setTimeout(()=>{
    boot.style.display="none";
    loadSongs();
  },500);
};

// ============ Matrix Rain =============
const mCanvas = document.getElementById("matrix-canvas");
const mCtx = mCanvas.getContext("2d");
let mCols, mDrops;

function initMatrix(){
  mCanvas.width = innerWidth;
  mCanvas.height = innerHeight;
  mCols = Math.floor(innerWidth / 20);
  mDrops = Array(mCols).fill(1);
}
function drawMatrix(){
  mCtx.fillStyle = "rgba(0,0,0,0.05)";
  mCtx.fillRect(0,0,innerWidth,innerHeight);
  mCtx.fillStyle = "#0f0";
  mCtx.font = "15px monospace";

  for(let i=0; i<mDrops.length; i++){
    mCtx.fillText(
      String.fromCharCode(0x30A0 + Math.random()*96),
      i*20,
      mDrops[i]*20
    );
    if(mDrops[i]*20 > innerHeight && Math.random()>0.975)
      mDrops[i]=0;
    mDrops[i]++;
  }
  requestAnimationFrame(drawMatrix);
}
window.onresize = initMatrix;
initMatrix();
drawMatrix();

// ============ Cursor Particles ============
const cCanvas = document.getElementById("cursor-canvas");
const cCtx = cCanvas.getContext("2d");
let particles = [];

function resizeCursorCanvas(){
  cCanvas.width = innerWidth;
  cCanvas.height = innerHeight;
}
window.addEventListener("resize", resizeCursorCanvas);
resizeCursorCanvas();

window.onmousemove = e => {
  for(let i=0;i<4;i++){
    particles.push({
      x:e.clientX, y:e.clientY,
      vx:(Math.random()-0.5)*4,
      vy:(Math.random()-0.5)*4,
      life:1,
      color:`hsl(${Math.random()*60+180},100%,70%)`
    });
  }
};

function animateParticles(){
  cCtx.clearRect(0,0,innerWidth,innerHeight);
  particles.forEach((p,i)=>{
    p.x+=p.vx; p.y+=p.vy; p.life-=0.02;
    cCtx.fillStyle=p.color;
    cCtx.globalAlpha=p.life;
    cCtx.beginPath();
    cCtx.arc(p.x,p.y,Math.random()*3+1,0,Math.PI*2);
    cCtx.fill();
    if(p.life<=0) particles.splice(i,1);
  });
  requestAnimationFrame(animateParticles);
}
animateParticles();

// ============ Audio System ============
const AudioSys = {
  ctx:null,
  isMuted:true,

  init:function(){
    window.AudioContext = window.AudioContext || window.webkitAudioContext;
    this.ctx = new AudioContext();
    this.setupEvents();
  },

  toggle:function(){
    this.isMuted = !this.isMuted;
    const btn = document.getElementById("muteBtn");
    if(this.isMuted){
      btn.textContent = "üîá MUTE";
      btn.classList.remove("active");
    } else {
      if(this.ctx.state==='suspended') this.ctx.resume();
      btn.textContent = "üîä SOUND ON";
      btn.classList.add("active");
      this.play("active");
    }
  },

  play:function(type){
    if(this.isMuted || !this.ctx) return;

    const osc = this.ctx.createOscillator();
    const gain = this.ctx.createGain();
    osc.connect(gain); gain.connect(this.ctx.destination);

    const now = this.ctx.currentTime;

    // ÂêÑÁ®ÆÈü≥
    if(type==="hover"){
      osc.type="sine";
      osc.frequency.setValueAtTime(800,now);
      osc.frequency.exponentialRampToValueAtTime(1200,now+0.05);
      gain.gain.setValueAtTime(0.05,now);
      gain.gain.exponentialRampToValueAtTime(0.001,now+0.05);
      osc.start(now); osc.stop(now+0.05);
    }
    else if(type==="click"){
      osc.type="square";
      osc.frequency.setValueAtTime(200,now);
      osc.frequency.exponentialRampToValueAtTime(50,now+0.1);
      gain.gain.setValueAtTime(0.1,now);
      gain.gain.exponentialRampToValueAtTime(0.001,now+0.1);
      osc.start(now); osc.stop(now+0.1);
    }
    else if(type==="like"){
      osc.type="triangle";
      osc.frequency.setValueAtTime(1000,now);
      osc.frequency.linearRampToValueAtTime(2000,now+0.1);
      gain.gain.setValueAtTime(0.1,now);
      gain.gain.linearRampToValueAtTime(0.001,now+0.3);
      osc.start(now); osc.stop(now+0.3);
    }
    else if(type==="roulette"){
      osc.type="sawtooth";
      osc.frequency.setValueAtTime(100,now);
      gain.gain.setValueAtTime(0.05,now);
      gain.gain.exponentialRampToValueAtTime(0.001,now+0.05);
      osc.start(now); osc.stop(now+0.05);
    }
    else if(type==="win"){
      this.playTone(440,"triangle",0.5);
      this.playTone(554,"triangle",0.5);
      this.playTone(659,"triangle",0.5);
    }
    else if(type==="active"){
      osc.type="sine";
      osc.frequency.setValueAtTime(100,now);
      osc.frequency.exponentialRampToValueAtTime(600,now+0.3);
      gain.gain.setValueAtTime(0.1,now);
      gain.gain.linearRampToValueAtTime(0.001,now+0.5);
      osc.start(now); osc.stop(now+0.5);
    }
  },

  playTone:function(freq,type,dur){
    const osc = this.ctx.createOscillator();
    const gain = this.ctx.createGain();
    osc.connect(gain); gain.connect(this.ctx.destination);
    osc.type=type;
    osc.frequency.setValueAtTime(freq,this.ctx.currentTime);
    gain.gain.setValueAtTime(0.1,this.ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001,this.ctx.currentTime+dur);
    osc.start(); osc.stop(this.ctx.currentTime+dur);
  },

  setupEvents:function(){
    document.body.addEventListener("mouseover", e=>{
      if(e.target.closest("button,a,.song-card"))
        this.play("hover");
    });
    document.body.addEventListener("mousedown", e=>{
      if(e.target.closest("button,a,.song-card"))
        this.play("click");
    });
  }
};

AudioSys.init();
document.getElementById("muteBtn").onclick = ()=>AudioSys.toggle();
// =========================================================
// ‚òÖ 3D GALAXY SYSTEM (Three.js) ÂÆåÂÖ®‰øÆÊ≠£Áâà
// =========================================================

const GalaxySys = {
  active: false,
  scene: null,
  camera: null,
  renderer: null,
  controls: null,
  stars: [],
  starField: null,
  raycaster: null,
  mouse: new THREE.Vector2(),
  lastMouseEvent: null,

  container: document.getElementById('galaxy-container'),
  tooltip: document.getElementById('star-tooltip'),
  animationId: null,

  init: function() {
    if (this.scene) return; // 2ÂõûÁõÆ‰ª•Èôç„ÅØÂàùÊúüÂåñ„Åó„Å™„ÅÑ

    // 1. „Ç∑„Éº„É≥
    this.scene = new THREE.Scene();
    this.scene.fog = new THREE.FogExp2(0x000000, 0.002);

    // 2. „Ç´„É°„É©
    this.camera = new THREE.PerspectiveCamera(
      60, window.innerWidth / window.innerHeight, 1, 2000
    );
    this.camera.position.z = 500;

    // 3. „É¨„É≥„ÉÄ„É©„Éº
    this.renderer = new THREE.WebGLRenderer({
      alpha: true, antialias: true
    });
    this.renderer.setPixelRatio(window.devicePixelRatio);
    this.renderer.setSize(window.innerWidth, window.innerHeight);
    this.container.appendChild(this.renderer.domElement);

    // 4. „Ç≥„É≥„Éà„É≠„Éº„É´
    this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
    this.controls.enableDamping = true;
    this.controls.dampingFactor = 0.05;
    this.controls.autoRotate = true;
    this.controls.autoRotateSpeed = 0.5;

    // 5. ÂΩì„Åü„ÇäÂà§ÂÆö
    this.raycaster = new THREE.Raycaster();

    // 6. „Ç§„Éô„É≥„Éà
    window.addEventListener("resize", () => this.onResize());
    this.container.addEventListener("mousemove", e => this.onMouseMove(e));
    this.container.addEventListener("click", e => this.onClick(e));

    // 7. Êõ≤„Éá„Éº„Çø„Åã„ÇâÊòü„ÇíÁîüÊàê
    this.createStars();

    // 8. ÊèèÁîªÈñãÂßã
    this.animate();
  },

  // ‚òÖ Êòü„ÇíÁîüÊàê
  createStars: function() {
    if (!allSongs.length) return;

    const createStarTexture = (color) => {
      const canvas = document.createElement("canvas");
      canvas.width = 32;
      canvas.height = 32;
      const ctx = canvas.getContext("2d");

      const grd = ctx.createRadialGradient(16, 16, 0, 16, 16, 16);
      grd.addColorStop(0, "rgba(255,255,255,1)");
      grd.addColorStop(0.2, color);
      grd.addColorStop(1, "rgba(0,0,0,0)");

      ctx.fillStyle = grd;
      ctx.fillRect(0, 0, 32, 32);

      return new THREE.CanvasTexture(canvas);
    };

    const matBlue = new THREE.SpriteMaterial({
      map: createStarTexture("rgba(96,165,250,1)"),
      transparent: true,
      blending: THREE.AdditiveBlending
    });

    const matPink = new THREE.SpriteMaterial({
      map: createStarTexture("rgba(236,72,153,1)"),
      transparent: true,
      blending: THREE.AdditiveBlending
    });

    // ‚òÖ ÂÖ®Êõ≤„Çí„É©„É≥„ÉÄ„É†ÁêÉÁä∂„Å´ÈÖçÁΩÆ
    allSongs.forEach((song, i) => {
      const material = (i % 2 === 0 ? matBlue : matPink);
      const sprite = new THREE.Sprite(material);

      const r = 200 + Math.random()*600;
      const theta = Math.random() * Math.PI * 2;
      const phi = Math.acos((Math.random()*2)-1);

      sprite.position.set(
        r * Math.sin(phi) * Math.cos(theta),
        r * Math.sin(phi) * Math.sin(theta),
        r * Math.cos(phi)
      );

      sprite.scale.set(12, 12, 1);

      sprite.userData = { song, id:i };

      this.scene.add(sprite);
      this.stars.push(sprite);
    });

    // ‚òÖ ËÉåÊôØÊòüÂ±ë
    const geo = new THREE.BufferGeometry();
    const vertices = [];
    for (let i=0;i<2000;i++){
      vertices.push(
        (Math.random()-0.5)*4000,
        (Math.random()-0.5)*4000,
        (Math.random()-0.5)*4000
      );
    }
    geo.setAttribute("position", new THREE.Float32BufferAttribute(vertices, 3));
    this.starField = new THREE.Points(
      geo,
      new THREE.PointsMaterial({ color:0x888888, size:2 })
    );
    this.scene.add(this.starField);
  },

  animate: function() {
    if (!this.active) return;
    this.animationId = requestAnimationFrame(() => this.animate());

    this.controls.update();

    // ‚òÖ „É¨„Ç§„Ç≠„É£„Çπ„ÉàÔºà„Éõ„Éê„ÉºÂà§ÂÆöÔºâ
    this.raycaster.setFromCamera(this.mouse, this.camera);
    const hits = this.raycaster.intersectObjects(this.stars);

    if (hits.length > 0) {
      const star = hits[0].object;
      const song = star.userData.song;

      if (this.lastMouseEvent) {
        this.tooltip.style.opacity = 1;
        this.tooltip.style.left = (this.lastMouseEvent.clientX + 15) + "px";
        this.tooltip.style.top = (this.lastMouseEvent.clientY + 15) + "px";
      }

      this.tooltip.querySelector(".tt-title").textContent = song.title;
      this.tooltip.querySelector(".tt-artist").textContent = song.artist;

      star.scale.set(20,20,1);

      document.body.style.cursor = "pointer";
    } else {
      this.tooltip.style.opacity = 0;
      this.stars.forEach(s => s.scale.set(12,12,1));
      document.body.style.cursor = "default";
    }

    this.renderer.render(this.scene, this.camera);
  },

  onResize: function() {
    if (!this.camera) return;
    this.camera.aspect = window.innerWidth / window.innerHeight;
    this.camera.updateProjectionMatrix();
    this.renderer.setSize(window.innerWidth, window.innerHeight);
  },

  onMouseMove: function(e) {
    this.lastMouseEvent = e;
    this.mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
    this.mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
  },

  onClick: function(e) {
    this.raycaster.setFromCamera(this.mouse, this.camera);
    const hits = this.raycaster.intersectObjects(this.stars);
    if (hits.length > 0) {
      const song = hits[0].object.userData.song;

      // Êó¢Â≠ò„ÅÆ„É´„Éº„É¨„ÉÉ„Éà„É¢„Éº„ÉÄ„É´„ÇíÊµÅÁî®
      const modal = document.getElementById("rouletteModal");
      const result = document.getElementById("rouletteResult");
      modal.classList.add("show");
      result.innerHTML =
        `<div style="font-size:0.8em;opacity:0.7">${song.artist}</div>
         <div>${song.title}</div>`;

      AudioSys.play("like");
    }
  },

  open: function() {
    if (!songsLoaded) {
      alert("Êõ≤„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠„Åß„Åô„ÄÇÂ∞ë„ÅóÂæÖ„Å£„Å¶„Åè„Å†„Åï„ÅÑÔºÅ");
      return;
    }

    this.active = true;
    this.container.classList.add("active");
    document.getElementById("exitGalaxyBtn").style.display = "block";
    document.getElementById("enterGalaxyBtn").style.display = "none";

    // ÂàùÂõû„ÅÆ„Åø init() „Åô„Çã
    if (!this.scene) this.init();
    else this.animate();

    AudioSys.play("active");
  },

  close: function() {
    this.active = false;
    this.container.classList.remove("active");
    cancelAnimationFrame(this.animationId);
    this.tooltip.style.opacity = 0;

    document.getElementById("exitGalaxyBtn").style.display = "none";
    document.getElementById("enterGalaxyBtn").style.display = "block";
  }
};

// ‚òÖ Êõ≤Ë™≠„ÅøËæº„ÅøÂæå„Å´ÂàùÊúüÂåñÂèØËÉΩ„Å´„Å™„Çã
document.addEventListener("songs-ready", ()=>{
  console.log("Songs loaded: GalaxySys ready.");
});

// ‚òÖ ÂÆáÂÆô„É¢„Éº„Éâ„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà
document.getElementById("enterGalaxyBtn").onclick = () => GalaxySys.open();
document.getElementById("exitGalaxyBtn").onclick = () => GalaxySys.close();

</script>
<!-- ‚òÖ Âè≥‰∏ãÂõ∫ÂÆö„Éú„Çø„É≥ -->
<button id="enterGalaxyBtn">üåå ÂÆáÂÆô„É¢„Éº„Éâ</button>
<button id="exitGalaxyBtn">‚úñ EXIT</button>

<!-- ‚òÖ Galaxy canvas / tooltip -->
<div id="galaxy-container"></div>

<div id="star-tooltip">
  <div class="tt-title"></div>
  <div class="tt-artist"></div>
</div>

<!-- Three.js Ë™≠„ÅøËæº„Åø -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

</body>
</html>


