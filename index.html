<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚‰ã„ã‚€ã®æ­Œãˆã‚‹æ›²ãƒªã‚¹ãƒˆ - LIVE SYSTEM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    // â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
    // ã“ã“ã«ã•ã£ãã‚³ãƒ”ãƒ¼ã—ãŸã€ŒfirebaseConfigã€ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼
    // ï¼ˆå…ƒã®è¨˜è¿°ã‚’æ¶ˆã—ã¦ä¸Šæ›¸ãã—ã¦ãã ã•ã„ï¼‰
    const firebaseConfig = {
      apiKey: "AIzaSyD...", 
      authDomain: "...",
      databaseURL: "https://...",
      projectId: "...",
      storageBucket: "...",
      messagingSenderId: "...",
      appId: "..."
    };
    // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

    // FirebaseåˆæœŸåŒ–
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦ä½¿ãˆã‚‹ã‚ˆã†ã«windowã«ç™»éŒ²
    window.db = db;
    window.dbRef = ref;
    window.dbOnValue = onValue;
    window.dbRunTransaction = runTransaction;
  </script>

<style>
/* =========================================================
   ãƒ™ãƒ¼ã‚¹ã‚«ãƒ©ãƒ¼ & è¨­å®š
========================================================= */
:root {
  --text-main: #e5e7eb;
  --text-sub: #9ca3af;
  --accent: #60a5fa;
  --neon-pink: #ec4899;
  --neon-blue: #60a5fa;
  --like-color: #f43f5e;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: "Segoe UI", "Roboto", system-ui, sans-serif;
  color: var(--text-main);
  background: #000;
  overflow-x: hidden;
}

/* ã‚³ãƒ³ãƒ†ãƒŠ */
.container {
  max-width: 960px; margin: 0 auto; padding: 16px 14px 40px;
  position: relative; z-index: 10;
}

/* èƒŒæ™¯ãƒ»ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
#matrix-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -10; opacity: 0.4; }
.visualizer-container {
  position: fixed; bottom: 0; left: 0; width: 100%; height: 50vh;
  display: flex; align-items: flex-end; justify-content: space-around;
  z-index: -5; pointer-events: none; opacity: 0.5;
  mask-image: linear-gradient(to top, black, transparent 80%);
}
.viz-bar {
  width: 8px; margin: 0 2px;
  background: linear-gradient(to top, var(--neon-blue), var(--neon-pink));
  box-shadow: 0 0 10px var(--neon-blue);
  animation: bounceBar infinite ease-in-out alternate;
}
@keyframes bounceBar {
  0% { height: 2%; opacity: 0.3; }
  100% { height: 80%; opacity: 1; filter: brightness(1.5); }
}

#cursor-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9990; mix-blend-mode: screen; }

/* èµ·å‹•ç”»é¢ */
#boot-screen {
  position: fixed; inset: 0; background: #000; z-index: 99999;
  display: flex; flex-direction: column; justify-content: flex-end;
  padding: 40px; font-family: "Courier New", monospace; color: #0f0;
  font-size: 1rem; line-height: 1.4; transition: opacity 0.5s ease;
}
#boot-screen.fadeout { opacity: 0; pointer-events: none; }
.boot-log { animation: swiftUp 0.2s ease-out forwards; }
@keyframes swiftUp { from { opacity:0; transform: translateY(20px); } to { opacity:1; transform:translateY(0); } }

/* UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ */
header { position: sticky; top: 0; padding: 8px 0 10px; z-index: 30; }
.header-inner {
  padding: 16px; background: rgba(15, 23, 42, 0.9);
  border-radius: 20px; border: 1px solid rgba(96, 165, 250, 0.3);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); backdrop-filter: blur(10px);
}

h1 {
  margin: 0; font-size: 1.9rem; text-align: center; font-weight: 900;
  letter-spacing: 0.15em; color: #fff;
  text-shadow: 0 0 5px var(--neon-blue), 0 0 10px var(--neon-blue), 0 0 20px var(--neon-pink);
}
h1.glitch-effect { position: relative; animation: textGlitch 3s infinite alternate; }
@keyframes textGlitch {
  0%, 100% { transform: translate(0); opacity: 1; }
  94% { transform: translate(-3px, 2px) skew(10deg); opacity: 0.8; text-shadow: -2px 0 red, 2px 0 blue; }
  96% { transform: translate(3px, -2px) skew(-10deg); opacity: 0.8; text-shadow: 2px 0 red, -2px 0 blue; }
  98% { transform: translate(0); opacity: 1; }
}

.tagline, .note { text-align: center; color: var(--text-sub); font-size: 0.8rem; }

/* æ¤œç´¢ãƒ»ãƒœã‚¿ãƒ³é¡ */
.controls-toggle-row { margin-top: 8px; text-align: right; }
.controls-toggle, .filter-btn, .sort-select, .search-box input {
  background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(148, 163, 184, 0.5);
  color: var(--text-main); border-radius: 999px; transition: all 0.2s;
}
.filter-btn.active {
  background: linear-gradient(135deg, var(--neon-blue), var(--neon-pink));
  border-color: transparent; color: #fff; box-shadow: 0 0 15px var(--neon-blue);
}
.controls { max-height: 500px; overflow: hidden; transition: 0.3s ease; }
.controls.collapsed { max-height: 0; opacity: 0; pointer-events: none; }

/* ã‚«ãƒ¼ãƒ‰ */
.song-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px; margin-top: 20px; }

.song-card {
  position: relative; padding: 16px 20px; border-radius: 16px;
  background: rgba(15, 23, 42, 0.6);
  border: 1px solid rgba(96, 165, 250, 0.3);
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  backdrop-filter: blur(5px); overflow: hidden;
  perspective: 1000px; transform-style: preserve-3d;
  transition: transform 0.1s ease-out, box-shadow 0.2s, border-color 0.2s;
  animation: fadeUp 0.5s ease forwards;
  animation-delay: calc(var(--i) * 0.03s); opacity: 0;
}
@keyframes fadeUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }

.song-card > * { transform: translateZ(20px); position: relative; z-index: 2; }

/* ãƒ›ãƒãƒ¼æ™‚ã®ã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
.song-card:hover {
  border-color: var(--neon-blue);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.6), inset 0 0 10px rgba(96, 165, 250, 0.3);
}
.song-card::after {
  content: ""; position: absolute; top: -50%; left: 0; width: 100%; height: 20px;
  background: linear-gradient(to bottom, transparent, var(--neon-blue), transparent);
  opacity: 0; z-index: 1; pointer-events: none; filter: blur(4px) brightness(2);
}
.song-card:hover::after { opacity: 1; animation: scanline 1.2s ease-in-out infinite; }
@keyframes scanline { 0% { top: -20%; opacity: 0; } 10% { opacity: 1; } 100% { top: 120%; opacity: 0; } }

.song-title { font-size: 1.1rem; font-weight: 900; text-shadow: 0 0 10px var(--neon-blue); }
.song-artist { font-size: 0.9rem; color: #cbd5f5; opacity: 0.9; }

.memo-pill {
  font-size: 0.7rem; padding: 2px 8px; border-radius: 999px;
  background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.3);
  box-shadow: 0 0 5px rgba(255,255,255,0.2);
}
.memo-ng { border-color: #f87171; color: #f87171; box-shadow: 0 0 5px #f87171; }
.memo-training { border-color: var(--neon-blue); color: var(--neon-blue); box-shadow: 0 0 5px var(--neon-blue); }
.memo-key { border-color: var(--neon-pink); color: var(--neon-pink); box-shadow: 0 0 5px var(--neon-pink); }

/* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ï¼ˆã„ã„ã­ãƒœã‚¿ãƒ³è¿½åŠ ï¼‰ */
.card-actions { margin-top: 12px; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }

.btn-like {
  display: inline-flex; align-items: center; gap: 6px;
  background: rgba(244, 63, 94, 0.15); color: #fda4af;
  border: 1px solid rgba(244, 63, 94, 0.5);
  padding: 5px 12px; border-radius: 999px; font-size: 0.8rem;
  cursor: pointer; transition: all 0.2s;
}
.btn-like:hover {
  background: rgba(244, 63, 94, 0.8); color: #fff;
  box-shadow: 0 0 15px var(--like-color); transform: scale(1.05);
}
.btn-like:active { transform: scale(0.95); }
.like-count { font-weight: bold; font-family: monospace; }
/* æŠ¼ã—ãŸã¨ãã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
.btn-like.liked { animation: popHeart 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
@keyframes popHeart { 0%{ transform:scale(1); } 50%{ transform:scale(1.4); } 100%{ transform:scale(1); } }

.btn-youtube { display: inline-flex; align-items: center; gap: 4px; background: rgba(220, 38, 38, 0.2); color: #fca5a5; border: 1px solid rgba(220, 38, 38, 0.5); padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; text-decoration: none; transition: 0.2s; }
.btn-youtube:hover { background: rgba(220, 38, 38, 0.8); color: #fff; }
.btn-copy { background: transparent; border: 1px solid rgba(148, 163, 184, 0.4); color: var(--text-sub); padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; cursor: pointer; transition: 0.2s; }
.btn-copy:hover { border-color: var(--accent); color: var(--accent); background: rgba(56, 189, 248, 0.1); }

/* é€šçŸ¥ãªã© */
.roulette-btn {
  background: linear-gradient(45deg, var(--neon-pink), var(--neon-blue)); border: none;
  padding: 10px 30px; border-radius: 999px; color: #fff; font-weight: bold; cursor: pointer;
  box-shadow: 0 0 20px var(--neon-pink); transition: 0.2s;
}
.roulette-btn:hover { transform: scale(1.05); box-shadow: 0 0 40px var(--neon-pink); filter: brightness(1.2); }

.modal-overlay { position: fixed; inset:0; background: rgba(0,0,0,0.8); z-index: 100; display:flex; justify-content:center; align-items:center; opacity:0; pointer-events:none; transition:0.3s; backdrop-filter:blur(5px); }
.modal-overlay.show { opacity:1; pointer-events:auto; }
.modal-content { background: #1e293b; border: 2px solid var(--neon-blue); padding: 30px; border-radius: 20px; text-align:center; width:90%; max-width:400px; box-shadow: 0 0 50px var(--neon-blue); transform: scale(0.8); transition: 0.3s; }
.modal-overlay.show .modal-content { transform: scale(1); }
.modal-result { font-size: 2rem; font-weight:900; margin: 20px 0; text-shadow: 0 0 20px var(--neon-blue); }

.toast-notification { position:fixed; bottom:30px; left:50%; transform:translate(-50%, 50px); background: var(--neon-blue); color:#fff; padding:8px 24px; border-radius:999px; box-shadow: 0 0 20px var(--neon-blue); opacity:0; transition:0.3s; z-index:200; }
.toast-notification.show { transform:translate(-50%, 0); opacity:1; }

/* ã‚¹ãƒãƒ›å¯¾å¿œ */
@media screen and (max-width: 768px) {
  .container { padding: 10px 10px 80px; }
  .header-inner { padding: 12px; }
  h1 { font-size: 1.3rem; letter-spacing: 0.05em; }
  .tagline, .note { display: none; }
  .controls-toggle-row { margin-top: 4px; }
  .controls { gap: 6px; }
  .search-box input, .sort-select { padding: 8px 12px; font-size: 0.8rem; }
  .filter-btn { padding: 4px 8px; font-size: 0.65rem; }
  .song-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
  .song-card { padding: 10px; border-radius: 12px; transform: none !important; perspective: none; }
  .song-title { font-size: 0.85rem; }
  .song-artist { font-size: 0.7rem; }
  .memo-text { font-size: 0.65rem; line-height: 1.2; }
  .memo-pill { font-size: 0.6rem; padding: 1px 6px; }
  .btn-copy, .btn-youtube, .btn-like { font-size: 0.6rem; padding: 3px 6px; }
  .card-actions { flex-wrap: wrap; }
  .roulette-btn { padding: 6px 16px; font-size: 0.8rem; }
  #boot-screen { padding: 20px; font-size: 0.8rem; }
}

</style>
</head>
<body>

<div id="boot-screen"></div>
<canvas id="matrix-canvas"></canvas>
<canvas id="cursor-canvas"></canvas>
<div class="visualizer-container" id="visualizer"></div>

<div class="container">
  <header>
    <div class="header-inner">
      <div style="text-align:center; font-size:0.7rem; color:var(--text-sub); opacity:0.8;">Last Update: <span id="lastUpdateTime">--</span></div>
      <h1 class="glitch-effect" data-text="ã‚‰ã„ã‚€ã®æ­Œãˆã‚‹æ›²ãƒªã‚¹ãƒˆ ğŸ¤">ã‚‰ã„ã‚€ã®æ­Œãˆã‚‹æ›²ãƒªã‚¹ãƒˆ ğŸ¤</h1>
      <div class="tagline">é…ä¿¡ã§æ­Œãˆã‚‹ï¼ˆæ­Œã„ãŸã„ï¼‰æ›²ã‚’ã¾ã¨ã‚ãŸãƒšãƒ¼ã‚¸</div>
      
      <div style="text-align:center; margin: 15px 0;">
        <button id="rouletteBtn" class="roulette-btn">ğŸ² ã‚µã‚¤ãƒãƒ¼ãŠã¾ã‹ã›é¸æ›²</button>
      </div>

      <div class="controls-toggle-row">
        <button id="controlsToggle" class="controls-toggle">â–² æ¤œç´¢ã‚’é–‰ã˜ã‚‹</button>
      </div>
      <div id="controls" class="controls">
        <div style="margin: 10px 0; display:flex; gap:10px; flex-wrap:wrap;">
          <input type="text" id="searchInput" placeholder="ğŸ” æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰..." style="flex:1; padding:8px 16px;">
          <select id="sortSelect" class="sort-select">
            <option value="default">ç™»éŒ²é †</option>
            <option value="artist">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆé †</option>
            <option value="title">æ›²åé †</option>
            <option value="likes">ã„ã„ã­é † â¤ï¸</option>
          </select>
        </div>
        <div class="filter-row" id="filterRow"></div>
      </div>
    </div>
  </header>

  <main id="songSections"></main>

  <footer style="text-align:center; margin-top:40px; color:var(--text-sub); font-size:0.75rem;">
    æ›´æ–°æ—¥: <span id="updatedDate"></span>
  </footer>
</div>

<div id="rouletteModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-title">Target Acquired:</div>
    <div id="rouletteResult" class="modal-result">???</div>
    <button id="closeModal" class="filter-btn" style="margin-top:20px;">é–‰ã˜ã‚‹</button>
  </div>
</div>
<div id="toast" class="toast-notification">DATA COPIED TO CLIPBOARD</div>

<script>
// =========================================================
// JS: åŸºæœ¬è¨­å®šï¼†ãƒ‡ãƒ¼ã‚¿ç®¡ç†
// =========================================================
const CATEGORY_LABELS = { all:"ALL", jpop:"J-POP", anime:"ANIME/GAME", vocaloid:"VOCALOID", other:"OTHER", ng:"NG", training:"TRAINING", acoustic:"ACOUSTIC" };
const CATEGORY_ORDER = ["jpop", "anime", "vocaloid", "other", "ng", "training", "acoustic"];
let allSongs=[], filteredCategory="all", keyword="", currentSort="default";
// ã„ã„ã­ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
let likesData = {};

// è¦ç´ å–å¾—
const els = {
  sections: document.getElementById("songSections"), search: document.getElementById("searchInput"),
  filter: document.getElementById("filterRow"), controls: document.getElementById("controls"),
  toggle: document.getElementById("controlsToggle"), sort: document.getElementById("sortSelect"),
  roulette: document.getElementById("rouletteBtn"), modal: document.getElementById("rouletteModal"),
  result: document.getElementById("rouletteResult"), close: document.getElementById("closeModal"),
  toast: document.getElementById("toast")
};

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
if(els.toggle) els.toggle.onclick = () => els.controls.classList.toggle("collapsed");
if(els.search) els.search.oninput = e => { keyword=e.target.value; render(); };
if(els.sort) els.sort.onchange = e => { currentSort=e.target.value; render(); };
if(els.close) els.close.onclick = () => els.modal.classList.remove("show");

const escape = s => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
const normalize = songs => songs.map(s => (s.memo&&s.memo.includes("å¼¾ãèªã‚Š")&&s.category!=="acoustic") ? {...s, category:"acoustic"} : s);

(function(){
  const d=new Date(document.lastModified), t=`${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
  ["lastUpdateTime","updatedDate"].forEach(id=>{ const e=document.getElementById(id); if(e)e.textContent=t; });
})();

// â˜…Firebase: ã„ã„ã­ãƒ‡ãƒ¼ã‚¿ã®åŒæœŸé–‹å§‹
function startLikesSync() {
  if (!window.db) return; // FirebaseãŒç„¡åŠ¹ãªã‚‰ä½•ã‚‚ã—ãªã„
  const likesRef = window.dbRef(window.db, 'likes');
  
  // ãƒ‡ãƒ¼ã‚¿ãŒå¤‰æ›´ã•ã‚Œã‚‹ãŸã³ã«å®Ÿè¡Œ
  window.dbOnValue(likesRef, (snapshot) => {
    likesData = snapshot.val() || {};
    // ã™ã§ã«æç”»ã•ã‚Œã¦ã„ã‚‹ã‚«ãƒ¼ãƒ‰ã®æ•°å­—ã ã‘æ›´æ–°ã™ã‚‹ï¼ˆç”»é¢å…¨ä½“ã®å†æç”»ã¯ã—ãªã„ï¼‰
    updateAllLikeCounts();
    // ã‚‚ã—ã€Œã„ã„ã­é †ã€ã§ã‚½ãƒ¼ãƒˆä¸­ãªã‚‰ã€é †ç•ªãŒå¤‰ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§å†æç”»
    if (currentSort === 'likes') {
      render();
    }
  });
}

function updateAllLikeCounts() {
  const btns = document.querySelectorAll('.btn-like');
  btns.forEach(btn => {
    const title = btn.dataset.title;
    // ã‚¿ã‚¤ãƒˆãƒ«ã®ã€Œ.ã€ãªã©ã¯Firebaseã®ã‚­ãƒ¼ã«ä½¿ãˆãªã„ã®ã§ç½®æ›ã•ã‚Œã¦ã„ã‚‹å‰æã§å–å¾—
    const safeTitle = title.replace(/[.#$/[\]]/g, "_");
    const count = likesData[safeTitle] || 0;
    btn.querySelector('.count').textContent = count;
  });
}

// èª­ã¿è¾¼ã¿ï¼†æç”»
async function loadSongs() {
  try {
    const res = await fetch("songs.json", { cache:"no-store" }); if(!res.ok) throw new Error(res.status);
    allSongs = normalize(await res.json());
    buildFilters();
    render();
    // æ›²ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«ã„ã„ã­åŒæœŸé–‹å§‹
    startLikesSync();
  } catch(e) { els.sections.innerHTML = `<p style='text-align:center;margin-top:20px;color:red;'>SYSTEM ERROR: ${e.message}</p>`; }
}

function buildFilters() {
  if(!els.filter) return;
  const counts = allSongs.reduce((a,s)=>{ a.all++; a[s.category||"other"]=(a[s.category||"other"]||0)+1; return a; },{all:0});
  els.filter.innerHTML = ["all",...CATEGORY_ORDER].map(cat => 
    `<button class="filter-btn ${cat===filteredCategory?'active':''}" onclick="setCat('${cat}')">${CATEGORY_LABELS[cat]} (${counts[cat]||0})</button>`
  ).join("");
}
window.setCat = cat => { filteredCategory=cat; buildFilters(); render(); };

function render() {
  let list = allSongs.filter(s => (filteredCategory==="all" || (s.category||"other")===filteredCategory) && `${s.title} ${s.artist} ${s.memo}`.toLowerCase().includes(keyword.toLowerCase()));
  
  // ã‚½ãƒ¼ãƒˆå‡¦ç†
  if(currentSort === "likes") {
    // ã„ã„ã­æ•°é †
    list.sort((a,b) => {
      const countA = likesData[a.title.replace(/[.#$/[\]]/g, "_")] || 0;
      const countB = likesData[b.title.replace(/[.#$/[\]]/g, "_")] || 0;
      return countB - countA; // å¤šã„é †
    });
  } else if(currentSort!=="default") {
    list.sort((a,b) => (a[currentSort]||"").toString().localeCompare((b[currentSort]||"").toString(),"ja"));
  }
  
  if(!list.length) { els.sections.innerHTML = "<p style='text-align:center;opacity:0.6;'>NO DATA FOUND</p>"; return; }
  
  const groups = list.reduce((g,s)=>{ (g[s.category||"other"]||=[]).push(s); return g; }, {});
  // ã€Œã„ã„ã­é †ã€ã®ã¨ãã¯ã‚«ãƒ†ã‚´ãƒªåˆ†ã‘ã›ãšã«ã‚ºãƒ©ãƒƒã¨å‡ºã™
  if (currentSort === "likes") {
     els.sections.innerHTML = `<h2 style="color:var(--neon-pink); text-align:center; margin-bottom:20px;">â¤ï¸ ã„ã„ã­ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
     <div class="song-grid">${list.map((s,i)=>renderCard(s,i)).join("")}</div>`;
  } else {
    els.sections.innerHTML = CATEGORY_ORDER.filter(c=>groups[c]).map(cat => `
      <h2 style="color:var(--neon-blue); border-left:4px solid var(--neon-blue); padding-left:10px; margin:20px 0 10px;">${CATEGORY_LABELS[cat]}</h2>
      <div class="song-grid">${groups[cat].map((s,i)=>renderCard(s,i)).join("")}</div>
    `).join("");
  }
  // æç”»å¾Œã«ã‚«ã‚¦ãƒ³ãƒˆã‚’åæ˜ 
  updateAllLikeCounts();
}

function renderCard(s, i) {
  const key = s.memo ? (s.memo.match(/[-+]\d+/) || [""])[0] : "";
  const memoView = s.memo ? escape(s.memo.replace(key,"").trim().replace(/[\/ï½œ|ãƒ»:ï¼šã€ã€‚-]+$/,"")) : "";
  const copyText = escape(`${s.title} / ${s.artist||""}`);
  // Firebaseã®ã‚­ãƒ¼ã«ä½¿ãˆãªã„æ–‡å­—ã‚’ç½®æ›
  const safeTitle = s.title.replace(/[.#$/[\]]/g, "_");
  
  let pills = [];
  if(/ng/i.test(s.memo)) pills.push(`<span class="memo-pill memo-ng">NG</span>`);
  if(/ç·´ç¿’ä¸­/.test(s.memo)) pills.push(`<span class="memo-pill memo-training">TRAINING</span>`);
  if(key) pills.push(`<span class="memo-pill memo-key">KEY ${key}</span>`);

  return `<div class="song-card" style="--i:${i}">
    <div class="song-title">${escape(s.title)}</div>
    <div class="song-artist">${escape(s.artist||"")}</div>
    <div style="margin-top:8px; display:flex; gap:4px; flex-wrap:wrap;">${pills.join("")}</div>
    ${memoView ? `<div style="margin-top:8px; font-size:0.8rem; opacity:0.8;">${memoView}</div>` : ""}
    <div class="card-actions">
      <button class="btn-like" data-title="${escape(s.title)}" onclick="addLike('${escape(safeTitle)}', this)">
        â¤ï¸ <span class="count">0</span>
      </button>
      <button class="btn-copy" onclick="doCopy('${copyText}')">ğŸ“‹ COPY</button>
      ${s.url ? `<a href="${escape(s.url)}" target="_blank" class="btn-youtube">â–¶ YOUTUBE</a>` : ""}
    </div>
  </div>`;
}

// â˜…ã„ã„ã­ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
window.addLike = (safeTitle, btn) => {
  if (!window.db) { alert("FirebaseãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"); return; }
  
  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚¯ãƒ©ã‚¹ä»˜ä¸
  btn.classList.add('liked');
  setTimeout(()=>btn.classList.remove('liked'), 300);

  // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§å®‰å…¨ã«ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—
  const likeRef = window.dbRef(window.db, 'likes/' + safeTitle);
  window.dbRunTransaction(likeRef, (currentLikes) => {
    return (currentLikes || 0) + 1;
  });
};

window.doCopy = t => navigator.clipboard.writeText(t).then(()=>{ els.toast.classList.add("show"); setTimeout(()=>els.toast.classList.remove("show"),2000); });

// ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ
if(els.roulette) els.roulette.onclick = () => {
  let list = allSongs.filter(s => (filteredCategory==="all" || (s.category||"other")===filteredCategory) && `${s.title} ${s.artist}`.toLowerCase().includes(keyword.toLowerCase()));
  if(!list.length) return alert("NO DATA FOR ROULETTE");
  els.modal.classList.add("show"); els.result.innerHTML = "SCANNING...";
  let c=0, interval=setInterval(()=>{
    els.result.textContent = list[Math.floor(Math.random()*list.length)].title;
    if(++c>20) { clearInterval(interval); const w=list[Math.floor(Math.random()*list.length)]; els.result.innerHTML=`<div style="font-size:0.8em;opacity:0.7">${w.artist}</div><div>${w.title}</div>`; }
  }, 70);
};

// 3D Tilt Effect
if(window.innerWidth > 768) { // ã‚¹ãƒãƒ›ä»¥å¤–ã®ã¿
  document.addEventListener('mousemove', e => {
    document.querySelectorAll('.song-card').forEach(c => {
      const r = c.getBoundingClientRect(); if(r.top>innerHeight||r.bottom<0)return;
      c.style.transform = `perspective(1000px) rotateX(${(e.clientY-(r.top+r.height/2))*-0.04}deg) rotateY(${(e.clientX-(r.left+r.width/2))*0.04}deg) scale(1.02)`;
    });
  });
  document.addEventListener('mouseleave', () => document.querySelectorAll('.song-card').forEach(c=>c.style.transform='perspective(1000px) rotateX(0) rotateY(0) scale(1)'));
}


// ã‚¨ãƒ•ã‚§ã‚¯ãƒˆé›†
const boot=document.getElementById("boot-screen"), logs=["INITIALIZING KERNEL...", "LOADING NEON_INTERFACE_V4...", "CONNECTING TO CYBER_SONG_DB...", "BYPASSING SECURITY...", "SYSTEM READY."];
window.onload = async () => {
  for(const log of logs) {
    const p=document.createElement("div"); p.textContent="> "+log; boot.appendChild(p);
    await new Promise(r=>setTimeout(r, 250+Math.random()*300));
  }
  boot.style.opacity=0; setTimeout(()=>{ boot.style.display="none"; loadSongs(); }, 500);
};

const mCanvas=document.getElementById("matrix-canvas"), mCtx=mCanvas.getContext("2d");
let mCols, mDrops;
function initMatrix(){ mCanvas.width=innerWidth; mCanvas.height=innerHeight; mCols=Math.floor(innerWidth/20); mDrops=Array(mCols).fill(1); }
function drawMatrix(){
  mCtx.fillStyle="rgba(0,0,0,0.05)"; mCtx.fillRect(0,0,innerWidth,innerHeight); mCtx.fillStyle="#0f0"; mCtx.font="15px monospace";
  for(let i=0; i<mDrops.length; i++){ mCtx.fillText(String.fromCharCode(0x30A0+Math.random()*96), i*20, mDrops[i]*20); if(mDrops[i]*20>innerHeight && Math.random()>0.975) mDrops[i]=0; mDrops[i]++; }
  requestAnimationFrame(drawMatrix);
}
window.onresize=initMatrix; initMatrix(); drawMatrix();

const cCanvas=document.getElementById("cursor-canvas"), cCtx=cCanvas.getContext("2d");
let particles=[];
window.addEventListener("resize", ()=>{ cCanvas.width=innerWidth; cCanvas.height=innerHeight; });
window.dispatchEvent(new Event("resize"));
window.onmousemove = e => { for(let i=0;i<4;i++) particles.push({x:e.clientX, y:e.clientY, vx:(Math.random()-0.5)*4, vy:(Math.random()-0.5)*4, life:1, color:`hsl(${Math.random()*60+180},100%,70%)`}); };
function animateParticles(){
  cCtx.clearRect(0,0,innerWidth,innerHeight);
  particles.forEach((p,i)=>{
    p.x+=p.vx; p.y+=p.vy; p.life-=0.02; cCtx.fillStyle=p.color; cCtx.globalAlpha=p.life; cCtx.beginPath(); cCtx.arc(p.x,p.y,Math.random()*3+1,0,Math.PI*2); cCtx.fill();
    if(p.life<=0) particles.splice(i,1);
  });
  requestAnimationFrame(animateParticles);
}
animateParticles();

const viz=document.getElementById("visualizer"); for(let i=0;i<40;i++){ const b=document.createElement("div"); b.className="viz-bar"; b.style.animationDuration=(0.4+Math.random()*0.6)+"s"; viz.appendChild(b); }

</script>
</body>
</html>