<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>らいむ管理画面 - 歌える曲リスト</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }

    h1 {
      font-size: 1.5rem;
      margin: 0 0 8px;
    }

    .note {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 12px;
    }

    .card {
      background: #0b1120;
      border-radius: 12px;
      padding: 12px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      margin-bottom: 16px;
    }

    label {
      font-size: 0.8rem;
      display: block;
      margin: 4px 0 2px;
    }

    input[type="text"],
    input[type="password"],
    select,
    textarea {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: #020617;
      color: #e5e7eb;
      font-size: 0.9rem;
      box-sizing: border-box;
    }

    textarea {
      min-height: 50px;
      resize: vertical;
    }

    button {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: #111827;
      color: #e5e7eb;
      font-size: 0.85rem;
      cursor: pointer;
    }

    button.primary {
      background: linear-gradient(135deg,#4f46e5,#0ea5e9);
      border-color: #22d3ee;
      color: #f9fafb;
    }

    button.danger {
      background: #7f1d1d;
      border-color: #f97373;
    }

    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .row > div {
      flex: 1;
      min-width: 120px;
    }

    .status {
      font-size: 0.8rem;
      margin-top: 6px;
    }

    .status.ok { color: #22c55e; }
    .status.err { color: #f97373; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      margin-top: 8px;
    }

    th, td {
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      padding: 4px 6px;
      vertical-align: top;
    }

    th {
      background: #020617;
      position: sticky;
      top: 0;
      z-index: 5;
    }

    .small-input {
      width: 100%;
      font-size: 0.8rem;
      padding: 3px 5px;
    }

    .checkbox-center {
      text-align: center;
    }

  </style>
</head>
<body>

<div class="container">
  <h1>らいむ管理画面（songs.json 編集）</h1>
  <div class="note">
    GitHub の <code>songs.json</code> を直接読み込み・編集します。  
    トークンはブラウザに保存されません。
  </div>

  <!-- GitHub設定 -->
  <div class="card">
    <h2 style="font-size:1rem;margin:0 0 6px;">1. GitHub設定</h2>
    <div class="row">
      <div>
        <label>GitHubユーザー名</label>
        <input type="text" id="ghUser" value="raimu415" />
      </div>
      <div>
        <label>リポジトリ名</label>
        <input type="text" id="ghRepo" value="singable_songs" />
      </div>
      <div>
        <label>ブランチ</label>
        <input type="text" id="ghBranch" value="main" />
      </div>
    </div>
    <div style="margin-top:8px;">
      <label>Personal Access Token（PAT）</label>
      <input type="password" id="ghToken" placeholder="ghp_..." />
    </div>
  </div>

  <!-- 曲追加 -->
  <div class="card">
    <h2 style="font-size:1rem;margin:0 0 6px;">2. 曲を追加</h2>
    <div class="row">
      <div>
        <label>曲名</label>
        <input type="text" id="newTitle" />
      </div>
      <div>
        <label>アーティスト</label>
        <input type="text" id="newArtist" />
      </div>
      <div>
        <label>カテゴリ</label>
        <select id="newCategory">
          <option value="jpop">jpop</option>
          <option value="anime">anime</option>
          <option value="vocaloid">vocaloid</option>
          <option value="other">other</option>
          <option value="ng">ng</option>
          <option value="training">training</option>
          <option value="acoustic">acoustic</option>
        </select>
      </div>
    </div>

    <label>メモ</label>
    <textarea id="newMemo"></textarea>

    <button class="primary" id="btnAdd" style="margin-top:8px;">追加</button>
    <div id="addStatus" class="status"></div>
  </div>


  <!-- 曲一覧 -->
  <div class="card">
    <div class="flex-between">
      <h2 style="font-size:1rem;margin:0;">3. 曲一覧</h2>
      <button id="btnReload">再読み込み</button>
    </div>

    <label style="margin-top:6px;">曲一覧検索（リアルタイム）</label>
    <input type="text" id="tableSearch" placeholder="Ado / 練習中 / -2 など" />

    <div id="listStatus" class="status"></div>

    <div style="margin-top:8px;overflow:auto;max-height:60vh;">
      <table id="songsTable">
        <thead>
          <tr>
            <th>曲名</th>
            <th>アーティスト</th>
            <th>カテゴリ</th>
            <th>メモ</th>
            <th>削除</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="flex-between" style="margin-top:10px;">
      <span style="font-size:0.8rem;">変更後は「保存」を押す</span>
      <button class="primary" id="btnSaveAll">変更を保存</button>
    </div>

    <div id="saveStatus" class="status"></div>
  </div>
</div>


<script>
  const ghUserInput = document.getElementById("ghUser");
  const ghRepoInput = document.getElementById("ghRepo");
  const ghBranchInput = document.getElementById("ghBranch");
  const ghTokenInput = document.getElementById("ghToken");

  const btnReload = document.getElementById("btnReload");
  const btnSaveAll = document.getElementById("btnSaveAll");
  const btnAdd = document.getElementById("btnAdd");

  const songsTableBody = document.querySelector("#songsTable tbody");
  const tableSearchInput = document.getElementById("tableSearch");

  const listStatus = document.getElementById("listStatus");
  const saveStatus = document.getElementById("saveStatus");
  const addStatus = document.getElementById("addStatus");

  const newTitle = document.getElementById("newTitle");
  const newArtist = document.getElementById("newArtist");
  const newCategory = document.getElementById("newCategory");
  const newMemo = document.getElementById("newMemo");

  let songsData = [];
  let currentSha = null;
  let tableSearchKeyword = "";


  /* GitHub API設定 */
  function getConfig() {
    return {
      user: ghUserInput.value.trim(),
      repo: ghRepoInput.value.trim(),
      branch: ghBranchInput.value.trim(),
      token: ghTokenInput.value.trim()
    };
  }

  function b64encodeUnicode(str) {
    return btoa(unescape(encodeURIComponent(str)));
  }
  function b64decodeUnicode(str) {
    return decodeURIComponent(escape(atob(str)));
  }


  /* songs.json を取得 */
  async function fetchSongsJson() {
    const { user, repo, branch } = getConfig();
    listStatus.textContent = "読み込み中...";
    songsTableBody.innerHTML = "";

    try {
      const res = await fetch(
        `https://api.github.com/repos/${user}/${repo}/contents/songs.json?ref=${branch}`
      );
      if (!res.ok) throw new Error("HTTP " + res.status);

      const data = await res.json();
      currentSha = data.sha;

      songsData = JSON.parse(b64decodeUnicode(data.content));
      renderSongsTable();

      listStatus.textContent = `読み込み完了：${songsData.length} 曲`;
      listStatus.className = "status ok";
    }
    catch (err) {
      listStatus.textContent = "読み込み失敗：" + err.message;
      listStatus.className = "status err";
    }
  }


  /* テーブル描画（削除ズレ防止版） */
  function renderSongsTable() {
    songsTableBody.innerHTML = "";

    const filtered = songsData
      .map((song, index) => ({ song, index }))
      .filter(({ song }) => {
        const text = `${song.title} ${song.artist} ${song.category} ${song.memo}`.toLowerCase();
        return text.includes(tableSearchKeyword.toLowerCase());
      });

    filtered.forEach(({ song, index }) => {
      const tr = document.createElement("tr");
      tr.dataset.id = index;

      /* タイトル */
      const tdTitle = document.createElement("td");
      const inputTitle = document.createElement("input");
      inputTitle.type = "text";
      inputTitle.value = song.title;
      inputTitle.className = "small-input";
      inputTitle.oninput = () => { songsData[index].title = inputTitle.value; };
      tdTitle.appendChild(inputTitle);

      /* アーティスト */
      const tdArtist = document.createElement("td");
      const inputArtist = document.createElement("input");
      inputArtist.type = "text";
      inputArtist.value = song.artist;
      inputArtist.className = "small-input";
      inputArtist.oninput = () => { songsData[index].artist = inputArtist.value; };
      tdArtist.appendChild(inputArtist);

      /* カテゴリ */
      const tdCategory = document.createElement("td");
      const sel = document.createElement("select");
      ["jpop","anime","vocaloid","other","ng","training", "acoustic"].forEach(c=>{
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        sel.appendChild(opt);
      });
      sel.value = song.category;
      sel.className = "small-input";
      sel.onchange = () => { songsData[index].category = sel.value; };
      tdCategory.appendChild(sel);

      /* メモ */
      const tdMemo = document.createElement("td");
      const textarea = document.createElement("textarea");
      textarea.value = song.memo;
      textarea.className = "small-input";
      textarea.style.minHeight = "40px";
      textarea.oninput = () => { songsData[index].memo = textarea.value; };
      tdMemo.appendChild(textarea);

      /* 削除 */
      const tdDel = document.createElement("td");
      tdDel.className = "checkbox-center";
      const chk = document.createElement("input");
      chk.type = "checkbox";
      chk.onchange = () => {
        tr.dataset.toDelete = chk.checked ? "1" : "";
      };
      tdDel.appendChild(chk);

      tr.appendChild(tdTitle);
      tr.appendChild(tdArtist);
      tr.appendChild(tdCategory);
      tr.appendChild(tdMemo);
      tr.appendChild(tdDel);

      songsTableBody.appendChild(tr);
    });
  }


  /* 保存（削除ズレなし） */
  async function saveSongsJson() {
    const { user, repo, branch, token } = getConfig();
    if (!token) {
      saveStatus.textContent = "トークンを入力してください";
      saveStatus.className = "status err";
      return;
    }

    saveStatus.textContent = "保存中...";
    saveStatus.className = "status";

    const rows = Array.from(songsTableBody.querySelectorAll("tr"));
    const newSongs = [];

    songsData.forEach((s, i) => {
      const row = rows.find(r => Number(r.dataset.id) === i);
      if (row && row.dataset.toDelete === "1") return;
      newSongs.push(s);
    });

    try {
      const contentB64 = b64encodeUnicode(JSON.stringify(newSongs, null, 2));

      const res = await fetch(
        `https://api.github.com/repos/${user}/${repo}/contents/songs.json`,
        {
          method: "PUT",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Accept": "application/vnd.github+json"
          },
          body: JSON.stringify({
            message: "Update songs.json from admin.html",
            content: contentB64,
            sha: currentSha,
            branch
          })
        }
      );

      if (!res.ok) throw new Error("HTTP " + res.status);

      const result = await res.json();
      currentSha = result.content.sha;
      songsData = newSongs;

      renderSongsTable();
      saveStatus.textContent = "保存完了！";
      saveStatus.className = "status ok";
    }
    catch (err) {
      saveStatus.textContent = "保存失敗：" + err.message;
      saveStatus.className = "status err";
    }
  }


  /* 曲追加 */
  function addSongToList() {
    const title = newTitle.value.trim();
    if (!title) {
      addStatus.textContent = "曲名は必須です";
      addStatus.className = "status err";
      return;
    }

    songsData.push({
      title,
      artist: newArtist.value.trim(),
      category: newCategory.value,
      memo: newMemo.value.trim()
    });

    newTitle.value = "";
    newArtist.value = "";
    newMemo.value = "";

    addStatus.textContent = "追加しました。保存で反映されます。";
    addStatus.className = "status ok";
    renderSongsTable();
  }


  /* イベント登録 */
  tableSearchInput.oninput = (e) => {
    tableSearchKeyword = e.target.value;
    renderSongsTable();
  };

  btnReload.onclick = fetchSongsJson;
  btnSaveAll.onclick = saveSongsJson;
  btnAdd.onclick = addSongToList;

  fetchSongsJson();
</script>

</body>
</html>
