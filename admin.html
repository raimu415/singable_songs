<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚‰ã„ã‚€ç®¡ç†ç”»é¢ - æ­Œãˆã‚‹æ›²ãƒªã‚¹ãƒˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }

    h1 {
      font-size: 1.5rem;
      margin: 0 0 8px;
    }

    .note {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 12px;
    }

    .card {
      background: #0b1120;
      border-radius: 12px;
      padding: 12px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      margin-bottom: 16px;
    }

    label {
      font-size: 0.8rem;
      display: block;
      margin: 4px 0 2px;
    }

    input[type="text"],
    input[type="password"],
    select,
    textarea {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: #020617;
      color: #e5e7eb;
      font-size: 0.9rem;
      box-sizing: border-box;
    }

    textarea {
      min-height: 50px;
      resize: vertical;
    }

    button {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: #111827;
      color: #e5e7eb;
      font-size: 0.85rem;
      cursor: pointer;
    }

    button.primary {
      background: linear-gradient(135deg,#4f46e5,#0ea5e9);
      border-color: #22d3ee;
      color: #f9fafb;
    }

    button.danger {
      background: #7f1d1d;
      border-color: #f97373;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .row > div {
      flex: 1;
      min-width: 120px;
    }

    .token-warning {
      font-size: 0.78rem;
      color: #f97373;
      margin-top: 4px;
    }

    .status {
      font-size: 0.8rem;
      margin-top: 6px;
    }

    .status.ok {
      color: #22c55e;
    }

    .status.err {
      color: #f97373;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      margin-top: 8px;
    }

    th, td {
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      padding: 4px 6px;
      vertical-align: top;
    }

    th {
      background: #020617;
      position: sticky;
      top: 0;
      z-index: 5;
    }

    .small-input {
      width: 100%;
      font-size: 0.8rem;
      padding: 3px 5px;
    }

    .badge {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: #111827;
      border: 1px solid rgba(148, 163, 184, 0.7);
    }

    .badge.ng {
      border-color: #f97373;
      color: #fecaca;
    }

    .badge.training {
      border-color: #38bdf8;
      color: #bae6fd;
    }

    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .nowrap {
      white-space: nowrap;
    }

    .checkbox-center {
      text-align: center;
    }

    @media (max-width: 700px) {
      table {
        font-size: 0.78rem;
      }
      th, td {
        padding: 3px 4px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ã‚‰ã„ã‚€ç®¡ç†ç”»é¢ï¼ˆsongs.json ç·¨é›†ï¼‰</h1>
    <div class="note">
      âœ… GitHub ã® <code>songs.json</code> ã‚’ç›´æ¥èª­ã¿è¾¼ã‚“ã§ç·¨é›†ãƒ»ä¿å­˜ã—ã¾ã™ã€‚<br>
      âœ… ã€Œãƒˆãƒ¼ã‚¯ãƒ³ã€ã¯ã“ã®ãƒšãƒ¼ã‚¸ã§ã—ã‹ä½¿ã‚ãšã€ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã—ã¾ã›ã‚“ã€‚
    </div>

    <!-- GitHubè¨­å®š -->
    <div class="card">
      <h2 style="font-size:1rem;margin:0 0 6px;">1. GitHubè¨­å®š</h2>
      <div class="row">
        <div>
          <label>GitHubãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
          <input type="text" id="ghUser" value="raimu415" />
        </div>
        <div>
          <label>ãƒªãƒã‚¸ãƒˆãƒªå</label>
          <input type="text" id="ghRepo" value="singable_songs" />
        </div>
        <div>
          <label>ãƒ–ãƒ©ãƒ³ãƒ</label>
          <input type="text" id="ghBranch" value="main" />
        </div>
      </div>
      <div style="margin-top:8px;">
        <label>Personal Access Tokenï¼ˆPATï¼‰</label>
        <input type="password" id="ghToken" placeholder="ghp_ ã‹ã‚‰å§‹ã¾ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³" />
        <div class="token-warning">
          â€» ã“ã®ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ã‚‹ã¨ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±ã¯æ®‹ã‚Šã¾ã›ã‚“ã€‚<br>
          â€» æ¨©é™ã¯ã€ŒContents: Read and writeã€ã ã‘ã§OKã€‚
        </div>
      </div>
    </div>

    <!-- æ›²è¿½åŠ  -->
    <div class="card">
      <h2 style="font-size:1rem;margin:0 0 6px;">2. æ›²ã‚’è¿½åŠ </h2>
      <div class="row">
        <div>
          <label>æ›²åï¼ˆtitleï¼‰</label>
          <input type="text" id="newTitle" />
        </div>
        <div>
          <label>ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆï¼ˆartistï¼‰</label>
          <input type="text" id="newArtist" />
        </div>
        <div>
          <label>ã‚«ãƒ†ã‚´ãƒªï¼ˆcategoryï¼‰</label>
          <select id="newCategory">
            <option value="jpop">J-POP / ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ</option>
            <option value="anime">ã‚¢ãƒ‹ã‚½ãƒ³ / ã‚²ãƒ¼ã‚½ãƒ³</option>
            <option value="vocaloid">ãƒœã‚«ãƒ­</option>
            <option value="other">ãã®ä»–</option>
            <option value="ng">NGï¼ˆæ­Œã„ãŸããªã„ï¼‰</option>
            <option value="training">ç·´ç¿’ä¸­</option>
          </select>
        </div>
      </div>
      <div style="margin-top:8px;">
        <label>ãƒ¡ãƒ¢ï¼ˆmemoï¼‰</label>
        <textarea id="newMemo" placeholder="ã‚­ãƒ¼ã€çŠ¶æ…‹ï¼ˆç·´ç¿’ä¸­ / äºŒåº¦ã¨æ­Œã„ãŸããªã„ ãªã©ï¼‰"></textarea>
      </div>
      <div style="margin-top:8px;">
        <button class="primary" id="btnAdd">æ›²ã‚’è¿½åŠ ï¼ˆæœ«å°¾ã«è¿½åŠ ï¼‰</button>
        <span id="addStatus" class="status"></span>
      </div>
    </div>

    <!-- æ›²ä¸€è¦§ãƒ»ç·¨é›† -->
    <div class="card">
      <div class="flex-between">
        <h2 style="font-size:1rem;margin:0;">3. æ›²ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ & ç·¨é›†</h2>
        <button id="btnReload">songs.json ã‚’å†èª­ã¿è¾¼ã¿</button>
        <!-- æ›²ä¸€è¦§æ¤œç´¢ -->
        <div style="margin:10px 0;">
        <label style="font-size:0.8rem;">æ›²ä¸€è¦§æ¤œç´¢ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰</label>
        <input
            type="text"
            id="tableSearch"
            placeholder="ä¾‹ï¼šAdo / ç·´ç¿’ä¸­ / ãƒœã‚«ãƒ­ / -2 ãªã©"
            style="
            width:100%;
            padding:6px 8px;
            border-radius:8px;
            border:1px solid rgba(148,163,184,0.7);
            background:#020617;
            color:#e5e7eb;
            font-size:0.88rem;
            margin-top:4px;
            "
        />
        </div>

      </div>
      <div id="listStatus" class="status"></div>
      <div style="margin-top:8px;overflow:auto;max-height:60vh;">
        <table id="songsTable">
          <thead>
            <tr>
              <th style="min-width:140px;">æ›²å</th>
              <th style="min-width:120px;">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ</th>
              <th style="min-width:100px;">ã‚«ãƒ†ã‚´ãƒª</th>
              <th style="min-width:180px;">ãƒ¡ãƒ¢</th>
              <th class="nowrap">å‰Šé™¤</th>
            </tr>
          </thead>
          <tbody>
            <!-- JSã§åŸ‹ã‚ã‚‹ -->
          </tbody>
        </table>
      </div>
      <div style="margin-top:10px;" class="flex-between">
        <span style="font-size:0.8rem;">ç·¨é›†å¾Œã¯å¿…ãšã€Œå¤‰æ›´ã‚’ä¿å­˜ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</span>
        <button class="primary" id="btnSaveAll">å¤‰æ›´ã‚’ä¿å­˜ï¼ˆsongs.json ä¸Šæ›¸ãï¼‰</button>
      </div>
      <div id="saveStatus" class="status"></div>
    </div>
  </div>

  <script>
    const ghUserInput = document.getElementById("ghUser");
    const ghRepoInput = document.getElementById("ghRepo");
    const ghBranchInput = document.getElementById("ghBranch");
    const ghTokenInput = document.getElementById("ghToken");

    const btnReload = document.getElementById("btnReload");
    const btnSaveAll = document.getElementById("btnSaveAll");
    const btnAdd = document.getElementById("btnAdd");

    const songsTableBody = document.querySelector("#songsTable tbody");
    const listStatus = document.getElementById("listStatus");
    const saveStatus = document.getElementById("saveStatus");
    const addStatus = document.getElementById("addStatus");

    const newTitle = document.getElementById("newTitle");
    const newArtist = document.getElementById("newArtist");
    const newCategory = document.getElementById("newCategory");
    const newMemo = document.getElementById("newMemo");

    let songsData = [];
    let currentSha = null;
    let tableSearchKeyword = "";

    function getConfig() {
      return {
        user: ghUserInput.value.trim(),
        repo: ghRepoInput.value.trim(),
        branch: ghBranchInput.value.trim(),
        token: ghTokenInput.value.trim()
      };
    }

    function setListStatus(msg, ok = false) {
      listStatus.textContent = msg;
      listStatus.className = "status " + (ok ? "ok" : "err");
    }

    function setSaveStatus(msg, ok = false) {
      saveStatus.textContent = msg;
      saveStatus.className = "status " + (ok ? "ok" : "err");
    }

    function setAddStatus(msg, ok = false) {
      addStatus.textContent = msg;
      addStatus.className = "status " + (ok ? "ok" : "err");
    }

    function b64encodeUnicode(str) {
      return btoa(unescape(encodeURIComponent(str)));
    }

    function b64decodeUnicode(str) {
      return decodeURIComponent(escape(atob(str)));
    }

    async function fetchSongsJson() {
      const { user, repo, branch } = getConfig();
      setListStatus("èª­ã¿è¾¼ã¿ä¸­...", false);
      songsTableBody.innerHTML = "";
      try {
        const res = await fetch(
          `https://api.github.com/repos/${user}/${repo}/contents/songs.json?ref=${branch}`
        );
        if (!res.ok) {
          throw new Error("APIã‚¨ãƒ©ãƒ¼: " + res.status);
        }
        const data = await res.json();
        currentSha = data.sha;
        const jsonText = b64decodeUnicode(data.content);
        const arr = JSON.parse(jsonText);
        if (!Array.isArray(arr)) {
          throw new Error("songs.json ãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“");
        }
        songsData = arr;
        renderSongsTable();
        setListStatus(`èª­ã¿è¾¼ã¿å®Œäº†: ${songsData.length} æ›²`, true);
      } catch (err) {
        console.error(err);
        setListStatus("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message, false);
      }
    }

    function renderSongsTable() {
  songsTableBody.innerHTML = "";

  // ğŸ” æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨
  const filtered = songsData.filter(s => {
    const text = `${s.title||""} ${s.artist||""} ${s.category||""} ${s.memo||""}`.toLowerCase();
    return text.includes(tableSearchKeyword.toLowerCase());
  });

  filtered.forEach((song, index) => {
        const tr = document.createElement("tr");

        const tdTitle = document.createElement("td");
        const inTitle = document.createElement("input");
        inTitle.type = "text";
        inTitle.value = song.title || "";
        inTitle.className = "small-input";
        inTitle.addEventListener("input", () => {
        song.title = inTitle.value;
        });
        tdTitle.appendChild(inTitle);

        const tdArtist = document.createElement("td");
        const inArtist = document.createElement("input");
        inArtist.type = "text";
        inArtist.value = song.artist || "";
        inArtist.className = "small-input";
        inArtist.addEventListener("input", () => {
        song.artist = inArtist.value;
        });
        tdArtist.appendChild(inArtist);

        const tdCat = document.createElement("td");
        const selCat = document.createElement("select");
        ["jpop","anime","vocaloid","other","ng","training"].forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        selCat.appendChild(opt);
        });
        selCat.value = song.category || "other";
        selCat.className = "small-input";
        selCat.addEventListener("change", () => {
        song.category = selCat.value;
        });
        tdCat.appendChild(selCat);

        const tdMemo = document.createElement("td");
        const inMemo = document.createElement("textarea");
        inMemo.value = song.memo || "";
        inMemo.className = "small-input";
        inMemo.style.minHeight = "40px";
        inMemo.addEventListener("input", () => {
        song.memo = inMemo.value;
        });
        tdMemo.appendChild(inMemo);

        const tdDel = document.createElement("td");
        tdDel.className = "checkbox-center";
        const chk = document.createElement("input");
        chk.type = "checkbox";
        chk.title = "å‰Šé™¤ãƒ•ãƒ©ã‚°";
        chk.addEventListener("change", () => {
        tr.dataset.toDelete = chk.checked ? "1" : "";
        });
        tdDel.appendChild(chk);

        tr.appendChild(tdTitle);
        tr.appendChild(tdArtist);
        tr.appendChild(tdCat);
        tr.appendChild(tdMemo);
        tr.appendChild(tdDel);

        songsTableBody.appendChild(tr);
    });
    }

    async function saveSongsJson() {
      const { user, repo, branch, token } = getConfig();
      if (!token) {
        setSaveStatus("ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", false);
        return;
      }

      const rows = Array.from(songsTableBody.querySelectorAll("tr"));
      const newSongs = [];
      rows.forEach((tr, i) => {
        if (tr.dataset.toDelete === "1") return;
        const s = songsData[i];
        if (!s) return;
        if (!s.title && !s.artist && !s.memo) return;
        newSongs.push(s);
      });

      const jsonText = JSON.stringify(newSongs, null, 2);
      const contentB64 = b64encodeUnicode(jsonText);

      setSaveStatus("ä¿å­˜ä¸­...", false);
      try {
        const res = await fetch(
          `https://api.github.com/repos/${user}/${repo}/contents/songs.json`,
          {
            method: "PUT",
            headers: {
              "Authorization": `Bearer ${token}`,
              "Accept": "application/vnd.github+json"
            },
            body: JSON.stringify({
              message: "Update songs.json from admin.html",
              content: contentB64,
              sha: currentSha,
              branch: branch
            })
          }
        );
        if (!res.ok) {
          const errData = await res.json().catch(() => ({}));
          console.error("save error:", errData);
          throw new Error("ä¿å­˜ã«å¤±æ•—: " + res.status);
        }
        const result = await res.json();
        currentSha = result.content.sha;
        songsData = newSongs;
        renderSongsTable();
        setSaveStatus("ä¿å­˜å®Œäº†ï¼ GitHub Pages ã«ã‚‚å°‘ã—æ™‚é–“å·®ã§åæ˜ ã•ã‚Œã¾ã™ã€‚", true);
      } catch (err) {
        console.error(err);
        setSaveStatus("ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + err.message, false);
      }
    }

    function addSongToList() {
      const title = newTitle.value.trim();
      const artist = newArtist.value.trim();
      const category = newCategory.value;
      const memo = newMemo.value.trim();

      if (!title) {
        setAddStatus("æ›²åã¯å¿…é ˆã§ã™ã€‚", false);
        return;
      }

      songsData.push({ title, artist, category, memo });
      renderSongsTable();
      newTitle.value = "";
      newArtist.value = "";
      newMemo.value = "";
      setAddStatus("ãƒ­ãƒ¼ã‚«ãƒ«ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸã€‚ã€Œå¤‰æ›´ã‚’ä¿å­˜ã€ã§GitHubã¸åæ˜ ã•ã‚Œã¾ã™ã€‚", true);
    }
    const tableSearchInput = document.getElementById("tableSearch");
    tableSearchInput.addEventListener("input", (e) => {
        tableSearchKeyword = e.target.value;
        renderSongsTable();
        });
    btnReload.addEventListener("click", fetchSongsJson);
    btnSaveAll.addEventListener("click", saveSongsJson);
    btnAdd.addEventListener("click", addSongToList);

    // ãƒšãƒ¼ã‚¸è¡¨ç¤ºæ™‚ã«è‡ªå‹•ã§ä¸€åº¦èª­ã¿è¾¼ã‚€
    fetchSongsJson();
  </script>
</body>
</html>
