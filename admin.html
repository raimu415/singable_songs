<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚‰ã„ã‚€ç®¡ç†ç”»é¢ - æ­Œãˆã‚‹æ›²ãƒªã‚¹ãƒˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
    }

    .container {
      max-width: 1200px; /* æ¨ªå¹…ã‚’å°‘ã—åºƒã’ã¾ã—ãŸ */
      margin: 0 auto;
      padding: 16px;
    }

    h1 { font-size: 1.5rem; margin: 0 0 8px; color: #60a5fa; }
    .note { font-size: 0.8rem; color: #9ca3af; margin-bottom: 12px; }

    .card {
      background: #0b1120;
      border-radius: 12px;
      padding: 16px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      margin-bottom: 16px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    label { font-size: 0.75rem; display: block; margin: 0 0 4px; color: #94a3b8; }

    input[type="text"], input[type="password"], select, textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #334155;
      background: #1e293b;
      color: #f1f5f9;
      font-size: 0.9rem;
      box-sizing: border-box;
      transition: border-color 0.2s;
    }
    input:focus, select:focus, textarea:focus {
      outline: none; border-color: #60a5fa; background: #0f172a;
    }

    textarea { min-height: 60px; resize: vertical; }

    button {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      background: #334155;
      color: #e5e7eb;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover { background: #475569; }

    button.primary {
      background: linear-gradient(135deg,#3b82f6,#06b6d4);
      color: white;
    }
    button.primary:hover { opacity: 0.9; }

    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; }
    .row > div { flex: 1; min-width: 140px; }

    .status { font-size: 0.85rem; margin-top: 8px; font-weight: bold; min-height: 1.2em;}
    .status.ok { color: #4ade80; }
    .status.err { color: #f87171; }

    /* ãƒ†ãƒ¼ãƒ–ãƒ«ã¾ã‚ã‚Š */
    .table-wrap {
      margin-top: 10px;
      overflow-x: auto; /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
      border: 1px solid #334155;
      border-radius: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      min-width: 800px; /* ã‚¹ãƒãƒ›ã§ã‚‚å´©ã‚Œãªã„ã‚ˆã†ã«æœ€å°å¹…ã‚’è¨­å®š */
    }
    th, td {
      border-bottom: 1px solid #1e293b;
      padding: 8px;
      vertical-align: top;
    }
    th {
      background: #0f172a;
      position: sticky;
      top: 0;
      z-index: 5;
      color: #94a3b8;
      font-weight: 600;
      text-align: left;
    }
    /* å¶æ•°è¡Œã®è‰²ã‚’å¤‰ãˆã‚‹ */
    tbody tr:nth-child(even) { background: rgba(30, 41, 59, 0.3); }
    tbody tr:hover { background: rgba(59, 130, 246, 0.1); }

    .small-input {
      background: transparent;
      border: 1px solid transparent;
      padding: 4px;
      font-size: 0.85rem;
    }
    .small-input:focus {
      background: #0f172a;
      border-color: #60a5fa;
    }
    
    .checkbox-center { text-align: center; vertical-align: middle; }
    input[type="checkbox"] { transform: scale(1.2); cursor: pointer; }

    .flex-between { display: flex; justify-content: space-between; align-items: center; }

  </style>
</head>
<body>

<div class="container">
  <h1>ã‚‰ã„ã‚€ç®¡ç†ç”»é¢ ğŸ§</h1>
  
  <div class="card">
    <h2 style="font-size:1rem;margin:0 0 10px; border-bottom:1px solid #334155; padding-bottom:5px;">1. GitHubè¨­å®š</h2>
    <div class="row">
      <div>
        <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
        <input type="text" id="ghUser" value="raimu415" />
      </div>
      <div>
        <label>ãƒªãƒã‚¸ãƒˆãƒªå</label>
        <input type="text" id="ghRepo" value="singable_songs" />
      </div>
      <div>
        <label>ãƒ–ãƒ©ãƒ³ãƒ</label>
        <input type="text" id="ghBranch" value="main" />
      </div>
    </div>
    <div style="margin-top:12px;">
      <label>Personal Access Token (PAT)</label>
      <input type="password" id="ghToken" placeholder="ghp_xxxxxxxxxxxx" />
      <div style="margin-top:6px;">
        <label style="display:inline-flex; align-items:center; gap:6px; cursor:pointer;">
          <input type="checkbox" id="saveTokenCheck"> ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã™ã‚‹ï¼ˆæ¬¡å›ã‹ã‚‰å…¥åŠ›ä¸è¦ï¼‰
        </label>
      </div>
    </div>
  </div>

  <div class="card">
    <h2 style="font-size:1rem;margin:0 0 10px; border-bottom:1px solid #334155; padding-bottom:5px;">2. æ–°ã—ã„æ›²ã‚’è¿½åŠ </h2>
    <div class="row">
      <div style="flex: 2;">
        <label>æ›²å <span style="color:#f87171">*</span></label>
        <input type="text" id="newTitle" placeholder="æ›²åã‚’å…¥åŠ›" />
      </div>
      <div style="flex: 2;">
        <label>ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ</label>
        <input type="text" id="newArtist" placeholder="æ­Œæ‰‹å" />
      </div>
      <div style="flex: 1;">
        <label>ã‚«ãƒ†ã‚´ãƒª</label>
        <select id="newCategory">
          <option value="jpop">J-POP</option>
          <option value="anime">ã‚¢ãƒ‹ã‚½ãƒ³/ã‚²ãƒ¼ã‚½ãƒ³</option>
          <option value="vocaloid">ãƒœã‚«ãƒ­</option>
          <option value="other">ãã®ä»–</option>
          <option value="ng">NG</option>
          <option value="training">ç·´ç¿’ä¸­</option>
          <option value="acoustic">å¼¾ãèªã‚Š</option>
        </select>
      </div>
    </div>
    
    <div style="margin-top:10px;">
      <label>YouTube URL (ä»»æ„)</label>
      <input type="text" id="newUrl" placeholder="https://www.youtube.com/watch?v=..." />
    </div>

    <div style="margin-top:10px;">
      <label>ãƒ¡ãƒ¢ (ã‚­ãƒ¼æƒ…å ±ã€ç·´ç¿’ä¸­ã€NGãªã©)</label>
      <textarea id="newMemo" placeholder="ä¾‹ï¼šã‚­ãƒ¼+2ã€ç·´ç¿’ä¸­ã€äºŒåº¦ã¨æ­Œã„ãŸããªã„"></textarea>
    </div>

    <div class="flex-between" style="margin-top:12px;">
      <div id="addStatus" class="status"></div>
      <button class="primary" id="btnAdd">ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
    </div>
  </div>


  <div class="card">
    <div class="flex-between">
      <h2 style="font-size:1rem;margin:0;">3. ç·¨é›†ãƒ»ä¿å­˜</h2>
      <button id="btnReload">å†èª­ã¿è¾¼ã¿</button>
    </div>

    <div style="margin-top:10px;">
      <input type="text" id="tableSearch" placeholder="ğŸ” ãƒªã‚¹ãƒˆå†…ã‚’æ¤œç´¢..." style="padding:10px;" />
    </div>

    <div id="listStatus" class="status"></div>

    <div class="table-wrap">
      <table id="songsTable">
        <thead>
          <tr>
            <th style="width:20%">æ›²å</th>
            <th style="width:15%">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ</th>
            <th style="width:10%">ã‚«ãƒ†ã‚´ãƒª</th>
            <th style="width:20%">URL (YouTube)</th>
            <th style="width:25%">ãƒ¡ãƒ¢</th>
            <th style="width:5%;text-align:center;">å‰Šé™¤</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="flex-between" style="margin-top:16px; padding-top:10px; border-top:1px solid #334155;">
      <div id="saveStatus" class="status"></div>
      <button class="primary" id="btnSaveAll" style="padding:10px 24px; font-size:1rem;">å¤‰æ›´ã‚’GitHubã«ä¿å­˜</button>
    </div>
  </div>
</div>


<script>
  // ==========================================
  //  å¾¹åº•ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ (Diagnosis Version)
  // ==========================================

  // è¦ç´ å–å¾—
  const els = {
    ghUser: document.getElementById("ghUser"),
    ghRepo: document.getElementById("ghRepo"),
    ghBranch: document.getElementById("ghBranch"),
    ghToken: document.getElementById("ghToken"),
    saveTokenCheck: document.getElementById("saveTokenCheck"),
    
    newTitle: document.getElementById("newTitle"),
    newArtist: document.getElementById("newArtist"),
    newCategory: document.getElementById("newCategory"),
    newUrl: document.getElementById("newUrl"),
    newMemo: document.getElementById("newMemo"),
    btnAdd: document.getElementById("btnAdd"),
    
    tableSearch: document.getElementById("tableSearch"),
    tableBody: document.querySelector("#songsTable tbody"),
    btnReload: document.getElementById("btnReload"),
    btnSaveAll: document.getElementById("btnSaveAll"),
    
    listStatus: document.getElementById("listStatus"),
    addStatus: document.getElementById("addStatus"),
    saveStatus: document.getElementById("saveStatus"),
  };

  let songsData = [];
  let currentSha = null;
  let tableSearchKeyword = "";

  // ãƒ­ã‚°å‡ºåŠ›ãƒ˜ãƒ«ãƒ‘ãƒ¼
  function log(msg, isError = false) {
    console.log(msg);
    if (els.listStatus) {
      els.listStatus.textContent = msg;
      els.listStatus.className = isError ? "status err" : "status";
      els.listStatus.style.color = isError ? "red" : "#4ade80";
    }
    if (isError) alert("ã€ã‚¨ãƒ©ãƒ¼æ¤œå‡ºã€‘\n" + msg);
  }

  // åˆæœŸåŒ–
  window.addEventListener("DOMContentLoaded", () => {
    console.log("ç”»é¢èª­ã¿è¾¼ã¿å®Œäº†");
    const savedToken = localStorage.getItem("ghToken_admin");
    if (savedToken) {
      els.ghToken.value = savedToken;
      els.saveTokenCheck.checked = true;
      log("ä¿å­˜ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚è‡ªå‹•æ¥ç¶šã‚’è©¦ã¿ã¾ã™...");
      setTimeout(fetchSongsJson, 500);
    } else {
      log("ãƒˆãƒ¼ã‚¯ãƒ³ãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    }
  });

  function getConfig() {
    return {
      user: els.ghUser.value.trim(),
      repo: els.ghRepo.value.trim(),
      branch: els.ghBranch.value.trim(),
      token: els.ghToken.value.trim()
    };
  }

  function b64encodeUnicode(str) { return btoa(unescape(encodeURIComponent(str))); }
  function b64decodeUnicode(str) { return decodeURIComponent(escape(atob(str))); }

  // â–  æ›²ãƒªã‚¹ãƒˆå–å¾—ï¼ˆãƒ‡ãƒãƒƒã‚°ç‰ˆï¼‰
  async function fetchSongsJson() {
    console.log("--- èª­ã¿è¾¼ã¿é–‹å§‹ ---");
    const { user, repo, branch, token } = getConfig();
    
    // 1. è¨­å®šãƒã‚§ãƒƒã‚¯
    if (!user || !repo || !branch) {
      log("ã‚¨ãƒ©ãƒ¼: ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ãƒªãƒã‚¸ãƒˆãƒªåã€ãƒ–ãƒ©ãƒ³ãƒã®ã„ãšã‚Œã‹ãŒç©ºã§ã™", true);
      return;
    }
    if (!token) {
      log("ã‚¨ãƒ©ãƒ¼: ãƒˆãƒ¼ã‚¯ãƒ³(ghp_...)ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“", true);
      return;
    }
    if (!token.startsWith("ghp_") && !token.startsWith("github_pat_")) {
      // æœ€è¿‘ã®ãƒˆãƒ¼ã‚¯ãƒ³ã¯ ghp_ ã˜ã‚ƒãªã„å ´åˆã‚‚ã‚ã‚‹ã®ã§è­¦å‘Šã®ã¿
      console.warn("è­¦å‘Š: ãƒˆãƒ¼ã‚¯ãƒ³ã®å½¢å¼ãŒä¸€èˆ¬çš„ã§ã¯ã‚ã‚Šã¾ã›ã‚“");
    }

    log(`GitHubã¸æ¥ç¶šä¸­... (${user}/${repo})`);
    els.tableBody.innerHTML = "";

    try {
      const url = `https://api.github.com/repos/${user}/${repo}/contents/songs.json?ref=${branch}&_t=${Date.now()}`;
      console.log("Accessing URL:", url);

      // 2. Fetchå®Ÿè¡Œ
      const res = await fetch(url, {
        headers: { 
          "Authorization": `Bearer ${token}`,
          "Accept": "application/vnd.github+json"
        }
      });

      console.log("Response Status:", res.status);

      // 3. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
      if (!res.ok) {
        if (res.status === 404) throw new Error("404 Not Found: ãƒªãƒã‚¸ãƒˆãƒªåã‹ãƒ•ã‚¡ã‚¤ãƒ«å(songs.json)ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚");
        if (res.status === 401) throw new Error("401 Unauthorized: ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã§ã™ã€‚æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã‚‹ã‹ã€é–“é•ã£ã¦ã„ã¾ã™ã€‚");
        if (res.status === 403) throw new Error("403 Forbidden: ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ã®æ¨©é™ä¸è¶³ï¼‰ã€‚");
        throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${res.status}`);
      }

      // 4. ãƒ‡ãƒ¼ã‚¿è§£æ
      const data = await res.json();
      if (!data.content) throw new Error("ãƒ‡ãƒ¼ã‚¿ã¯å–å¾—ã§ãã¾ã—ãŸãŒã€contentãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒç©ºã§ã™ã€‚");
      
      currentSha = data.sha;
      const rawContent = b64decodeUnicode(data.content);
      console.log("Raw JSON Content:", rawContent.substring(0, 100) + "..."); // æœ€åˆã®100æ–‡å­—ã ã‘ãƒ­ã‚°

      try {
        songsData = JSON.parse(rawContent);
      } catch (jsonErr) {
        throw new Error("JSONã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚songs.jsonã®è¨˜è¿°ãƒŸã‚¹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚\n" + jsonErr.message);
      }

      if (!Array.isArray(songsData)) {
        throw new Error("JSONã¯æœ‰åŠ¹ã§ã™ãŒã€é…åˆ—(ãƒªã‚¹ãƒˆ)å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
      }

      // ãƒ‡ãƒ¼ã‚¿è£œå®Œ
      songsData = songsData.map(s => ({ 
        title: s.title || "",
        artist: s.artist || "",
        category: s.category || "other",
        url: s.url || "",
        memo: s.memo || ""
      }));

      renderSongsTable();
      log(`âœ… æˆåŠŸï¼ ${songsData.length} ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`);

    } catch (err) {
      console.error(err);
      log(err.message, true); // ç”»é¢ã«ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‡ºã™
    }
  }

  // â–  ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
  function renderSongsTable() {
    els.tableBody.innerHTML = "";
    if(!songsData.length) {
      log("ãƒ‡ãƒ¼ã‚¿ã¯èª­ã¿è¾¼ã‚ã¾ã—ãŸãŒã€ä¸­èº«ãŒ0ä»¶ã§ã™ã€‚");
      return;
    }

    const filtered = songsData.map((song, index) => ({ song, index })).filter(({ song }) => {
      const text = `${song.title} ${song.artist} ${song.category} ${song.memo}`.toLowerCase();
      return text.includes(tableSearchKeyword.toLowerCase());
    });

    filtered.forEach(({ song, index }) => {
      const tr = document.createElement("tr");
      tr.dataset.id = index;
      
      const createInput = (key) => {
        const td = document.createElement("td");
        const input = document.createElement("input");
        input.type = "text"; input.value = song[key] || ""; input.className = "small-input";
        input.oninput = () => { songsData[index][key] = input.value; };
        td.appendChild(input); return td;
      };

      tr.appendChild(createInput("title"));
      tr.appendChild(createInput("artist"));

      const tdCat = document.createElement("td");
      const sel = document.createElement("select");
      sel.className = "small-input";
      ["jpop","anime","vocaloid","other","ng","training","acoustic"].forEach(c => {
        const opt = document.createElement("option"); opt.value = c; opt.textContent = c;
        if(song.category === c) opt.selected = true; sel.appendChild(opt);
      });
      sel.onchange = () => { songsData[index].category = sel.value; };
      tdCat.appendChild(sel); tr.appendChild(tdCat);

      tr.appendChild(createInput("url"));

      const tdMemo = document.createElement("td");
      const area = document.createElement("textarea");
      area.value = song.memo || ""; area.className = "small-input"; area.style.height = "34px"; 
      area.onfocus = () => area.style.height = "80px"; area.onblur = () => area.style.height = "34px";
      area.oninput = () => { songsData[index].memo = area.value; };
      tdMemo.appendChild(area); tr.appendChild(tdMemo);

      const tdDel = document.createElement("td"); tdDel.className = "checkbox-center";
      const chk = document.createElement("input"); chk.type = "checkbox";
      chk.onchange = () => {
        tr.style.opacity = chk.checked ? "0.3" : "1";
        tr.style.background = chk.checked ? "#450a0a" : "";
        tr.dataset.toDelete = chk.checked ? "1" : "";
      };
      tdDel.appendChild(chk); tr.appendChild(tdDel);

      els.tableBody.appendChild(tr);
    });
  }

  // â–  GitHubã¸ä¿å­˜
  async function saveSongsJson() {
    const { user, repo, branch, token } = getConfig();
    if (els.saveTokenCheck.checked) localStorage.setItem("ghToken_admin", token);
    else localStorage.removeItem("ghToken_admin");

    if (!token) return log("ãƒˆãƒ¼ã‚¯ãƒ³æœªå…¥åŠ›ã®ãŸã‚ä¿å­˜ã§ãã¾ã›ã‚“", true);

    els.saveStatus.textContent = "ä¿å­˜ä¸­...";
    els.saveStatus.className = "status";

    const newSongs = [];
    const rows = Array.from(els.tableBody.querySelectorAll("tr"));
    songsData.forEach((s, i) => {
      const row = rows.find(r => Number(r.dataset.id) === i);
      if (row && row.dataset.toDelete === "1") return;
      newSongs.push(s);
    });

    try {
      const contentB64 = b64encodeUnicode(JSON.stringify(newSongs, null, 2));
      const res = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/songs.json`, {
        method: "PUT",
        headers: { "Authorization": `Bearer ${token}`, "Accept": "application/vnd.github+json" },
        body: JSON.stringify({
          message: "Update via Admin Panel",
          content: contentB64,
          sha: currentSha,
          branch
        })
      });

      if (!res.ok) throw new Error("ä¿å­˜å¤±æ•—: " + res.status);
      const result = await res.json();
      currentSha = result.content.sha;
      songsData = newSongs;
      renderSongsTable();
      els.saveStatus.textContent = "âœ… ä¿å­˜æˆåŠŸï¼";
      els.saveStatus.className = "status ok";
      alert("ä¿å­˜ã—ã¾ã—ãŸï¼");
    } catch (err) {
      els.saveStatus.textContent = err.message;
      els.saveStatus.className = "status err";
      alert("ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + err.message);
    }
  }

  // â–  è¿½åŠ 
  function addSongToList() {
    const title = els.newTitle.value.trim();
    if (!title) return alert("æ›²åã‚’å…¥ã‚Œã¦ãã ã•ã„");
    songsData.push({
      title, artist: els.newArtist.value.trim(), category: els.newCategory.value,
      url: els.newUrl.value.trim(), memo: els.newMemo.value.trim()
    });
    els.newTitle.value = ""; els.newArtist.value = ""; els.newUrl.value = ""; els.newMemo.value = ""; els.newTitle.focus();
    renderSongsTable();
    els.addStatus.textContent = "ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸ(æœªä¿å­˜)";
    setTimeout(() => {
        const tableWrap = document.querySelector(".table-wrap");
        if(tableWrap) tableWrap.scrollTop = tableWrap.scrollHeight;
    }, 100);
  }

  els.tableSearch.oninput = (e) => { tableSearchKeyword = e.target.value; renderSongsTable(); };
  els.btnReload.onclick = fetchSongsJson;
  els.btnSaveAll.onclick = saveSongsJson;
  els.btnAdd.onclick = addSongToList;

</script>

</body>
</html>