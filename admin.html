<script>
  // 要素取得
  const els = {
    ghUser: document.getElementById("ghUser"),
    ghRepo: document.getElementById("ghRepo"),
    ghBranch: document.getElementById("ghBranch"),
    ghToken: document.getElementById("ghToken"),
    saveTokenCheck: document.getElementById("saveTokenCheck"),
    
    newTitle: document.getElementById("newTitle"),
    newArtist: document.getElementById("newArtist"),
    newCategory: document.getElementById("newCategory"),
    newUrl: document.getElementById("newUrl"),
    newMemo: document.getElementById("newMemo"),
    btnAdd: document.getElementById("btnAdd"),
    
    tableSearch: document.getElementById("tableSearch"),
    tableBody: document.querySelector("#songsTable tbody"),
    btnReload: document.getElementById("btnReload"),
    btnSaveAll: document.getElementById("btnSaveAll"),
    
    listStatus: document.getElementById("listStatus"),
    addStatus: document.getElementById("addStatus"),
    saveStatus: document.getElementById("saveStatus"),
  };

  let songsData = [];
  let currentSha = null;
  let tableSearchKeyword = "";

  // ■ 初期化：トークンの読み込み
  window.addEventListener("DOMContentLoaded", () => {
    const savedToken = localStorage.getItem("ghToken_admin");
    if (savedToken) {
      els.ghToken.value = savedToken;
      els.saveTokenCheck.checked = true;
      // トークンがある場合のみ自動読み込みを試みる
      setTimeout(fetchSongsJson, 500);
    }
  });

  // 設定取得
  function getConfig() {
    return {
      user: els.ghUser.value.trim(),
      repo: els.ghRepo.value.trim(),
      branch: els.ghBranch.value.trim(),
      token: els.ghToken.value.trim()
    };
  }

  // 文字コード処理
  function b64encodeUnicode(str) { return btoa(unescape(encodeURIComponent(str))); }
  function b64decodeUnicode(str) { return decodeURIComponent(escape(atob(str))); }

  // ■ 曲リスト取得
  async function fetchSongsJson() {
    const { user, repo, branch, token } = getConfig();
    
    // トークンがない場合は警告
    if(!token) {
        els.listStatus.textContent = "トークンを入力してください";
        els.listStatus.className = "status err";
        return;
    }

    els.listStatus.textContent = "GitHubから読み込み中...";
    els.listStatus.className = "status";
    els.tableBody.innerHTML = "";

    try {
      // キャッシュを回避するためにタイムスタンプをつける
      const url = `https://api.github.com/repos/${user}/${repo}/contents/songs.json?ref=${branch}&_=${new Date().getTime()}`;
      
      const res = await fetch(url, {
          headers: { 
              "Authorization": `Bearer ${token}`,
              "Accept": "application/vnd.github+json"
          }
      });

      if (!res.ok) {
          if(res.status === 404) throw new Error("ファイルが見つかりません (404)。リポジトリ名を確認してください。");
          if(res.status === 401) throw new Error("認証失敗 (401)。トークンが間違っています。");
          throw new Error("読込エラー: " + res.status);
      }

      const data = await res.json();
      currentSha = data.sha;
      
      const jsonContent = b64decodeUnicode(data.content);
      songsData = JSON.parse(jsonContent);
      
      // データが配列でない場合の対策
      if(!Array.isArray(songsData)) songsData = [];

      // データにURLがない古い形式の場合に備えて補完
      songsData = songsData.map(s => ({ 
          title: s.title || "",
          artist: s.artist || "",
          category: s.category || "other",
          url: s.url || "",
          memo: s.memo || ""
      }));

      renderSongsTable();
      els.listStatus.textContent = `読み込み完了：${songsData.length} 曲`;
      els.listStatus.className = "status ok";

    } catch (err) {
      console.error(err);
      els.listStatus.textContent = "エラー: " + err.message;
      els.listStatus.className = "status err";
    }
  }

  // ■ テーブル描画
  function renderSongsTable() {
    els.tableBody.innerHTML = "";

    if(!songsData || songsData.length === 0) {
        els.listStatus.textContent = "データが0件、または読み込めていません";
        return;
    }

    // 検索フィルタ
    const filtered = songsData.map((song, index) => ({ song, index })).filter(({ song }) => {
      const text = `${song.title} ${song.artist} ${song.category} ${song.memo}`.toLowerCase();
      return text.includes(tableSearchKeyword.toLowerCase());
    });

    // リストの生成
    filtered.forEach(({ song, index }) => {
      const tr = document.createElement("tr");
      tr.dataset.id = index; // 元の配列のインデックスを保持

      // セル生成ヘルパー
      const createInput = (key) => {
        const td = document.createElement("td");
        const input = document.createElement("input");
        input.type = "text";
        input.value = song[key] || "";
        input.className = "small-input";
        input.oninput = () => { songsData[index][key] = input.value; };
        td.appendChild(input);
        return td;
      };

      // タイトル・アーティスト
      tr.appendChild(createInput("title"));
      tr.appendChild(createInput("artist"));

      // カテゴリ
      const tdCat = document.createElement("td");
      const sel = document.createElement("select");
      sel.className = "small-input";
      ["jpop","anime","vocaloid","other","ng","training","acoustic"].forEach(c => {
        const opt = document.createElement("option");
        opt.value = c; opt.textContent = c;
        if(song.category === c) opt.selected = true;
        sel.appendChild(opt);
      });
      sel.onchange = () => { songsData[index].category = sel.value; };
      tdCat.appendChild(sel);
      tr.appendChild(tdCat);

      // URL (追加！)
      tr.appendChild(createInput("url"));

      // メモ
      const tdMemo = document.createElement("td");
      const area = document.createElement("textarea");
      area.value = song.memo || "";
      area.className = "small-input";
      area.style.height = "34px"; 
      area.onfocus = () => area.style.height = "80px"; 
      area.onblur = () => area.style.height = "34px";
      area.oninput = () => { songsData[index].memo = area.value; };
      tdMemo.appendChild(area);
      tr.appendChild(tdMemo);

      // 削除
      const tdDel = document.createElement("td");
      tdDel.className = "checkbox-center";
      const chk = document.createElement("input");
      chk.type = "checkbox";
      chk.onchange = () => {
        tr.style.opacity = chk.checked ? "0.3" : "1";
        tr.style.background = chk.checked ? "#450a0a" : "";
        tr.dataset.toDelete = chk.checked ? "1" : "";
      };
      tdDel.appendChild(chk);
      tr.appendChild(tdDel);

      els.tableBody.appendChild(tr);
    });
  }

  // ■ GitHubへ保存
  async function saveSongsJson() {
    const { user, repo, branch, token } = getConfig();
    
    // トークン保存処理
    if (els.saveTokenCheck.checked) {
      localStorage.setItem("ghToken_admin", token);
    } else {
      localStorage.removeItem("ghToken_admin");
    }

    if (!token) {
      els.saveStatus.textContent = "トークンが入力されていません！";
      els.saveStatus.className = "status err";
      return;
    }

    els.saveStatus.textContent = "GitHubに書き込み中...";
    els.saveStatus.className = "status";

    // 削除フラグがついているものを除外
    const rows = Array.from(els.tableBody.querySelectorAll("tr"));
    const newSongs = [];
    songsData.forEach((s, i) => {
      const row = rows.find(r => Number(r.dataset.id) === i);
      if (row && row.dataset.toDelete === "1") return; // 削除対象ならスキップ
      newSongs.push(s);
    });

    try {
      const contentB64 = b64encodeUnicode(JSON.stringify(newSongs, null, 2));
      const res = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/songs.json`, {
        method: "PUT",
        headers: { "Authorization": `Bearer ${token}`, "Accept": "application/vnd.github+json" },
        body: JSON.stringify({
          message: "Update songs list (via admin)",
          content: contentB64,
          sha: currentSha,
          branch
        })
      });

      if (!res.ok) throw new Error("保存エラー: " + res.status);
      
      const result = await res.json();
      currentSha = result.content.sha;
      songsData = newSongs;
      renderSongsTable();

      els.saveStatus.textContent = "✅ 保存成功！サイトに反映されました。";
      els.saveStatus.className = "status ok";
    } catch (err) {
      els.saveStatus.textContent = "保存失敗: " + err.message;
      els.saveStatus.className = "status err";
    }
  }

  // ■ リストに追加
  function addSongToList() {
    const title = els.newTitle.value.trim();
    if (!title) {
      els.addStatus.textContent = "曲名は必須です";
      els.addStatus.className = "status err";
      return;
    }

    songsData.push({
      title,
      artist: els.newArtist.value.trim(),
      category: els.newCategory.value,
      url: els.newUrl.value.trim(),
      memo: els.newMemo.value.trim()
    });

    // フォームをリセット
    els.newTitle.value = "";
    els.newArtist.value = "";
    els.newUrl.value = "";
    els.newMemo.value = "";
    els.newTitle.focus();

    els.addStatus.textContent = `「${title}」を追加しました。（保存ボタンで確定）`;
    els.addStatus.className = "status ok";
    renderSongsTable();
    
    els.tableSearch.value = "";
    tableSearchKeyword = "";
    setTimeout(() => {
        const tableWrap = document.querySelector(".table-wrap");
        if(tableWrap) tableWrap.scrollTop = tableWrap.scrollHeight;
    }, 100);
  }

  // ■ イベントリスナー
  els.tableSearch.oninput = (e) => { tableSearchKeyword = e.target.value; renderSongsTable(); };
  els.btnReload.onclick = fetchSongsJson;
  els.btnSaveAll.onclick = saveSongsJson;
  els.btnAdd.onclick = addSongToList;

</script>