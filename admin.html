<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>らいむの曲リスト管理画面</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0;
            padding: 0;
            background: #0f172a;
            color: #e5e7eb;
        }
        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 16px;
        }
        h1 {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }
        .tagline {
            font-size: 0.9rem;
            color: #9ca3af;
            margin-bottom: 16px;
        }
        section {
            margin-top: 20px;
            padding: 12px 14px;
            border-radius: 12px;
            background: #111827;
            box-shadow: 0 2px 4px rgba(15,23,42,0.5);
        }
        h2 {
            font-size: 1.05rem;
            margin-top: 0;
            margin-bottom: 8px;
        }
        label {
            display: block;
            font-size: 0.85rem;
            margin-bottom: 4px;
        }
        input[type="text"],
        input[type="password"],
        select,
        textarea {
            width: 100%;
            padding: 8px 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1px solid #4b5563;
            background: #020617;
            color: #e5e7eb;
            box-sizing: border-box;
        }
        textarea {
            min-height: 60px;
            resize: vertical;
        }
        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 1px rgba(99,102,241,0.5);
        }
        button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 14px;
            border-radius: 999px;
            border: none;
            background: #4f46e5;
            color: #e5e7eb;
            font-size: 0.9rem;
            cursor: pointer;
        }
        button:disabled {
            opacity: 0.6;
            cursor: default;
        }
        .small-btn {
            padding: 6px 10px;
            font-size: 0.8rem;
        }
        .row {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .row > * {
            flex: 1;
        }
        .row label {
            margin-bottom: 0;
        }

        .status {
            margin-top: 8px;
            font-size: 0.85rem;
            color: #9ca3af;
        }
        .status.ok {
            color: #22c55e;
        }
        .status.error {
            color: #f97373;
        }

        .token-status-text {
            font-size: 0.8rem;
            color: #9ca3af;
        }
        .hint {
            font-size: 0.75rem;
            color: #9ca3af;
        }
        .danger {
            color: #f97373;
        }

        footer {
            margin-top: 24px;
            text-align: center;
            font-size: 0.75rem;
            color: #6b7280;
        }

        @media (max-width: 640px) {
            .row {
                flex-direction: column;
                align-items: stretch;
            }
            h1 {
                font-size: 1.3rem;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>らいむ曲リスト 管理画面（ひみつ）</h1>
        <div class="tagline">
            GitHub の <code>songs.json</code> を直接編集して、曲を追加できます。<br>
            ※ このページのURLは配信画面には絶対映さないようにしてね！
        </div>
    </header>

    <!-- GitHubトークン設定 -->
    <section>
        <h2>① GitHub トークン設定</h2>
        <p class="hint">
            ここで入力したトークンは <strong>このブラウザのローカルストレージにだけ保存</strong> されます。<br>
            サイトのHTMLやGitHubには埋め込まれないので、他の人には見えません。
        </p>

        <label for="tokenInput">GitHub Personal Access Token（PAT）</label>
        <input type="password" id="tokenInput" placeholder="github_pat_... みたいなやつ">

        <div class="row">
            <button id="saveTokenBtn" class="small-btn">トークンを保存</button>
            <button id="clearTokenBtn" class="small-btn" type="button">トークン削除</button>
            <span class="token-status-text" id="tokenStatusText"></span>
        </div>

        <div class="hint">
            ・権限は「Contents: Read and write」＋ リポジトリ <code>singable_songs</code> だけでOK。<br>
            ・トークンは誰にも見せないこと！配信画面にも映さない！！
        </div>
    </section>

    <!-- 曲追加フォーム -->
    <section>
        <h2>② 曲を追加する</h2>

        <form id="songForm">
            <label for="titleInput">曲名 <span class="danger">*</span></label>
            <input type="text" id="titleInput" required placeholder="例：シャルル">

            <label for="artistInput">アーティスト / ボカロP <span class="danger">*</span></label>
            <input type="text" id="artistInput" required placeholder="例：バルーン / Ado / Kanaria など">

            <label for="memoInput">メモ（キー / 備考など）</label>
            <textarea id="memoInput" placeholder="例：0/83 / 原キー / 練習中 など"></textarea>

            <label for="categorySelect">カテゴリ</label>
            <select id="categorySelect">
                <option value="vocaloid">ボカロ</option>
                <option value="jpop">J-POP / アニソン</option>
                <option value="anime">アニメソング</option>
                <option value="training">練習中</option>
                <option value="ng">二度と歌いたくないやつ</option>
                <option value="other">その他</option>
            </select>

            <button type="submit" id="submitBtn">曲を追加する</button>
        </form>

        <div class="status" id="formStatus">準備OK。トークンを設定してから追加してください。</div>
    </section>

    <footer>
        GitHub: <code>raimu415/singable_songs</code><br>
        ※ このページのURLは本当に信用できる端末からだけ開いてください。
    </footer>
</div>

<script>
    // ==========================
    // 設定
    // ==========================
    const OWNER = "raimu415";
    const REPO  = "singable_songs";
    const FILE_PATH = "songs.json";
    const GITHUB_API_BASE = "https://api.github.com";

    // このタブの中だけで使うトークン（localStorageは使わない）
    let tokenCache = "";

    const TOKEN_STATUS_TEXT_DEFAULT = "トークン未設定（このタブ内でのみ保持）";

    const tokenInput      = document.getElementById("tokenInput");
    const saveTokenBtn    = document.getElementById("saveTokenBtn");
    const clearTokenBtn   = document.getElementById("clearTokenBtn");
    const tokenStatusText = document.getElementById("tokenStatusText");

    const songForm   = document.getElementById("songForm");
    const formStatus = document.getElementById("formStatus");
    const submitBtn  = document.getElementById("submitBtn");

    // ==========================
    // トークンの管理（このタブ内のみ）
    // ==========================
    function getToken() {
        return tokenCache || "";
    }

    function updateTokenStatusText() {
        if (tokenCache) {
            tokenStatusText.textContent = "このタブでトークン設定済み";
        } else {
            tokenStatusText.textContent = TOKEN_STATUS_TEXT_DEFAULT;
        }
    }

    saveTokenBtn.addEventListener("click", (e) => {
        e.preventDefault();
        const token = tokenInput.value.trim();
        if (!token) {
            alert("トークンが空です。GitHubで発行したトークンを貼り付けてください。");
            return;
        }
        tokenCache = token;        // このタブのメモリにだけ保存
        tokenInput.value = "";     // 入力欄は消す
        updateTokenStatusText();
        alert("トークンをこのタブ内に保存しました。このタブを閉じると消えます。");
    });

    clearTokenBtn.addEventListener("click", () => {
        if (confirm("このタブで保持しているトークンを削除しますか？")) {
            tokenCache = "";
            updateTokenStatusText();
            alert("トークンを削除しました。");
        }
    });

    // 初期表示
    updateTokenStatusText();

    // ==========================
    // GitHub API 呼び出し
    // ==========================
    async function githubRequest(path, options = {}) {
        const token = getToken();
        if (!token) {
            throw new Error("トークンが設定されていません。上の欄でトークンを保存してください。");
        }

        const headers = options.headers || {};
        headers["Authorization"] = `Bearer ${token}`;
        headers["Accept"] = "application/vnd.github+json";
        headers["X-GitHub-Api-Version"] = "2022-11-28";

        const res = await fetch(`${GITHUB_API_BASE}${path}`, {
            ...options,
            headers
        });

        if (!res.ok) {
            const text = await res.text();
            throw new Error(`GitHub API エラー: ${res.status} ${res.statusText} / ${text}`);
        }
        return res.json();
    }

    // songs.json の現在内容を取得
    async function fetchSongsFile() {
        return githubRequest(`/repos/${OWNER}/${REPO}/contents/${encodeURIComponent(FILE_PATH)}`, {
            method: "GET"
        });
    }

    // songs.json を更新
    async function updateSongsFile(newContentJson, prevSha, commitMessage) {
        const encoded = btoa(unescape(encodeURIComponent(newContentJson)));

        return githubRequest(`/repos/${OWNER}/${REPO}/contents/${encodeURIComponent(FILE_PATH)}`, {
            method: "PUT",
            body: JSON.stringify({
                message: commitMessage,
                content: encoded,
                sha: prevSha
            })
        });
    }

    // ==========================
    // 曲追加フロー
    // ==========================
    songForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const title  = document.getElementById("titleInput").value.trim();
        const artist = document.getElementById("artistInput").value.trim();
        const memo   = document.getElementById("memoInput").value.trim();
        const category = document.getElementById("categorySelect").value;

        if (!title || !artist) {
            alert("曲名とアーティストは必須です。");
            return;
        }

        if (!getToken()) {
            alert("トークンが設定されていません。先にトークンを保存してください。");
            return;
        }

        submitBtn.disabled = true;
        formStatus.textContent = "GitHub から songs.json を取得中...";
        formStatus.className = "status";

        try {
            // 1. 現在のファイル取得
            const fileData = await fetchSongsFile();

            const sha = fileData.sha;
            const contentBase64 = (fileData.content || "").replace(/\n/g, "");
            const contentStr = decodeURIComponent(escape(atob(contentBase64) || "[]"));

            let songs;
            try {
                songs = JSON.parse(contentStr);
                if (!Array.isArray(songs)) {
                    songs = [];
                }
            } catch (err) {
                songs = [];
            }

            // 2. 新しい曲を追加
            const newSong = {
                title,
                artist,
                memo,
                category
            };
            songs.push(newSong);

            // 3. JSON をきれいに整形
            const newJsonStr = JSON.stringify(songs, null, 2);

            formStatus.textContent = "songs.json を更新中...";
            // 4. GitHub に PUT
            await updateSongsFile(newJsonStr, sha, `add song: ${title}`);

            formStatus.textContent = "追加完了！サイトを再読み込みすると反映されます。";
            formStatus.className = "status ok";

            // フォームをクリア
            songForm.reset();
        } catch (err) {
            console.error(err);
            formStatus.textContent = "エラーが発生しました: " + err.message;
            formStatus.className = "status error";
            alert("エラー: " + err.message);
        } finally {
            submitBtn.disabled = false;
        }
    });
</script>

</body>
</html>
