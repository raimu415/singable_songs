<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>らいむ管理画面 - 歌える曲リスト</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }

    h1 {
      font-size: 1.5rem;
      margin: 0 0 8px;
    }

    .note {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 12px;
    }

    .card {
      background: #0b1120;
      border-radius: 12px;
      padding: 12px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      margin-bottom: 16px;
    }

    label {
      font-size: 0.8rem;
      display: block;
      margin: 4px 0 2px;
    }

    input[type="text"],
    input[type="password"],
    select,
    textarea {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: #020617;
      color: #e5e7eb;
      font-size: 0.9rem;
      box-sizing: border-box;
    }

    textarea {
      min-height: 50px;
      resize: vertical;
    }

    button {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: #111827;
      color: #e5e7eb;
      font-size: 0.85rem;
      cursor: pointer;
    }

    button.primary {
      background: linear-gradient(135deg,#4f46e5,#0ea5e9);
      border-color: #22d3ee;
      color: #f9fafb;
    }

    button.danger {
      background: #7f1d1d;
      border-color: #f97373;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .row > div {
      flex: 1;
      min-width: 120px;
    }

    .token-warning {
      font-size: 0.78rem;
      color: #f97373;
      margin-top: 4px;
    }

    .status {
      font-size: 0.8rem;
      margin-top: 6px;
    }

    .status.ok {
      color: #22c55e;
    }

    .status.err {
      color: #f97373;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      margin-top: 8px;
    }

    th, td {
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      padding: 4px 6px;
      vertical-align: top;
    }

    th {
      background: #020617;
      position: sticky;
      top: 0;
      z-index: 5;
    }

    .small-input {
      width: 100%;
      font-size: 0.8rem;
      padding: 3px 5px;
    }

    .badge {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: #111827;
      border: 1px solid rgba(148, 163, 184, 0.7);
    }

    .badge.ng {
      border-color: #f97373;
      color: #fecaca;
    }

    .badge.training {
      border-color: #38bdf8;
      color: #bae6fd;
    }

    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .nowrap {
      white-space: nowrap;
    }

    .checkbox-center {
      text-align: center;
    }

    @media (max-width: 700px) {
      table {
        font-size: 0.78rem;
      }
      th, td {
        padding: 3px 4px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>らいむ管理画面（songs.json 編集）</h1>
    <div class="note">
      ✅ GitHub の <code>songs.json</code> を直接読み込んで編集・保存します。<br>
      ✅ 「トークン」はこのページでしか使わず、ブラウザに保存しません。
    </div>

    <!-- GitHub設定 -->
    <div class="card">
      <h2 style="font-size:1rem;margin:0 0 6px;">1. GitHub設定</h2>
      <div class="row">
        <div>
          <label>GitHubユーザー名</label>
          <input type="text" id="ghUser" value="raimu415" />
        </div>
        <div>
          <label>リポジトリ名</label>
          <input type="text" id="ghRepo" value="singable_songs" />
        </div>
        <div>
          <label>ブランチ</label>
          <input type="text" id="ghBranch" value="main" />
        </div>
      </div>
      <div style="margin-top:8px;">
        <label>Personal Access Token（PAT）</label>
        <input type="password" id="ghToken" placeholder="ghp_ から始まるトークン" />
        <div class="token-warning">
          ※ このページを閉じるとトークン情報は残りません。<br>
          ※ 権限は「Contents: Read and write」だけでOK。
        </div>
      </div>
    </div>

    <!-- 曲追加 -->
    <div class="card">
      <h2 style="font-size:1rem;margin:0 0 6px;">2. 曲を追加</h2>
      <div class="row">
        <div>
          <label>曲名（title）</label>
          <input type="text" id="newTitle" />
        </div>
        <div>
          <label>アーティスト（artist）</label>
          <input type="text" id="newArtist" />
        </div>
        <div>
          <label>カテゴリ（category）</label>
          <select id="newCategory">
            <option value="jpop">J-POP / アーティスト</option>
            <option value="anime">アニソン / ゲーソン</option>
            <option value="vocaloid">ボカロ</option>
            <option value="other">その他</option>
            <option value="ng">NG（歌いたくない）</option>
            <option value="training">練習中</option>
          </select>
        </div>
      </div>
      <div style="margin-top:8px;">
        <label>メモ（memo）</label>
        <textarea id="newMemo" placeholder="キー、状態（練習中 / 二度と歌いたくない など）"></textarea>
      </div>
      <div style="margin-top:8px;">
        <button class="primary" id="btnAdd">曲を追加（末尾に追加）</button>
        <span id="addStatus" class="status"></span>
      </div>
    </div>

    <!-- 曲一覧・編集 -->
    <div class="card">
      <div class="flex-between">
        <h2 style="font-size:1rem;margin:0;">3. 曲一覧を読み込み & 編集</h2>
        <button id="btnReload">songs.json を再読み込み</button>
        <!-- 曲一覧検索 -->
        <div style="margin:10px 0;">
        <label style="font-size:0.8rem;">曲一覧検索（リアルタイム）</label>
        <input
            type="text"
            id="tableSearch"
            placeholder="例：Ado / 練習中 / ボカロ / -2 など"
            style="
            width:100%;
            padding:6px 8px;
            border-radius:8px;
            border:1px solid rgba(148,163,184,0.7);
            background:#020617;
            color:#e5e7eb;
            font-size:0.88rem;
            margin-top:4px;
            "
        />
        </div>

      </div>
      <div id="listStatus" class="status"></div>
      <div style="margin-top:8px;overflow:auto;max-height:60vh;">
        <table id="songsTable">
          <thead>
            <tr>
              <th style="min-width:140px;">曲名</th>
              <th style="min-width:120px;">アーティスト</th>
              <th style="min-width:100px;">カテゴリ</th>
              <th style="min-width:180px;">メモ</th>
              <th class="nowrap">削除</th>
            </tr>
          </thead>
          <tbody>
            <!-- JSで埋める -->
          </tbody>
        </table>
      </div>
      <div style="margin-top:10px;" class="flex-between">
        <span style="font-size:0.8rem;">編集後は必ず「変更を保存」を押してください。</span>
        <button class="primary" id="btnSaveAll">変更を保存（songs.json 上書き）</button>
      </div>
      <div id="saveStatus" class="status"></div>
    </div>
  </div>

  <script>
    const ghUserInput = document.getElementById("ghUser");
    const ghRepoInput = document.getElementById("ghRepo");
    const ghBranchInput = document.getElementById("ghBranch");
    const ghTokenInput = document.getElementById("ghToken");

    const btnReload = document.getElementById("btnReload");
    const btnSaveAll = document.getElementById("btnSaveAll");
    const btnAdd = document.getElementById("btnAdd");

    const songsTableBody = document.querySelector("#songsTable tbody");
    const listStatus = document.getElementById("listStatus");
    const saveStatus = document.getElementById("saveStatus");
    const addStatus = document.getElementById("addStatus");

    const newTitle = document.getElementById("newTitle");
    const newArtist = document.getElementById("newArtist");
    const newCategory = document.getElementById("newCategory");
    const newMemo = document.getElementById("newMemo");

    let songsData = [];
    let currentSha = null;
    let tableSearchKeyword = "";

    function getConfig() {
      return {
        user: ghUserInput.value.trim(),
        repo: ghRepoInput.value.trim(),
        branch: ghBranchInput.value.trim(),
        token: ghTokenInput.value.trim()
      };
    }

    function setListStatus(msg, ok = false) {
      listStatus.textContent = msg;
      listStatus.className = "status " + (ok ? "ok" : "err");
    }

    function setSaveStatus(msg, ok = false) {
      saveStatus.textContent = msg;
      saveStatus.className = "status " + (ok ? "ok" : "err");
    }

    function setAddStatus(msg, ok = false) {
      addStatus.textContent = msg;
      addStatus.className = "status " + (ok ? "ok" : "err");
    }

    function b64encodeUnicode(str) {
      return btoa(unescape(encodeURIComponent(str)));
    }

    function b64decodeUnicode(str) {
      return decodeURIComponent(escape(atob(str)));
    }

    async function fetchSongsJson() {
      const { user, repo, branch } = getConfig();
      setListStatus("読み込み中...", false);
      songsTableBody.innerHTML = "";
      try {
        const res = await fetch(
          `https://api.github.com/repos/${user}/${repo}/contents/songs.json?ref=${branch}`
        );
        if (!res.ok) {
          throw new Error("APIエラー: " + res.status);
        }
        const data = await res.json();
        currentSha = data.sha;
        const jsonText = b64decodeUnicode(data.content);
        const arr = JSON.parse(jsonText);
        if (!Array.isArray(arr)) {
          throw new Error("songs.json が配列ではありません");
        }
        songsData = arr;
        renderSongsTable();
        setListStatus(`読み込み完了: ${songsData.length} 曲`, true);
      } catch (err) {
        console.error(err);
        setListStatus("読み込みに失敗しました: " + err.message, false);
      }
    }
    function renderSongsTable() {
    songsTableBody.innerHTML = "";

    const filtered = songsData.filter(s => {
        const text = `${s.title||""} ${s.artist||""} ${s.category||""} ${s.memo||""}`.toLowerCase();
        return text.includes(tableSearchKeyword.toLowerCase());
    });

    filtered.forEach((song, index) => {
        const tr = document.createElement("tr");

        const tdTitle = document.createElement("td");
        const inTitle = document.createElement("input");
        inTitle.type = "text";
        inTitle.value = song.title || "";
        inTitle.className = "small-input";
        inTitle.addEventListener("input", () => {
        song.title = inTitle.value;
        });
        tdTitle.appendChild(inTitle);

        const tdArtist = document.createElement("td");
        const inArtist = document.createElement("input");
        inArtist.type = "text";
        inArtist.value = song.artist || "";
        inArtist.className = "small-input";
        inArtist.addEventListener("input", () => {
        song.artist = inArtist.value;
        });
        tdArtist.appendChild(inArtist);

        const tdCat = document.createElement("td");
        const selCat = document.createElement("select");
        ["jpop","anime","vocaloid","other","ng","training"].forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        selCat.appendChild(opt);
        });
        selCat.value = song.category || "other";
        selCat.className = "small-input";
        selCat.addEventListener("change", () => {
        song.category = selCat.value;
        });
        tdCat.appendChild(selCat);

        const tdMemo = document.createElement("td");
        const inMemo = document.createElement("textarea");
        inMemo.value = song.memo || "";
        inMemo.className = "small-input";
        inMemo.style.minHeight = "40px";
        inMemo.addEventListener("input", () => {
        song.memo = inMemo.value;
        });
        tdMemo.appendChild(inMemo);

        const tdDel = document.createElement("td");
        tdDel.className = "checkbox-center";
        const chk = document.createElement("input");
        chk.type = "checkbox";
        chk.title = "削除フラグ";
        tdDel.appendChild(chk);

        tr.appendChild(tdTitle);
        tr.appendChild(tdArtist);
        tr.appendChild(tdCat);
        tr.appendChild(tdMemo);
        tr.appendChild(tdDel);

        songsTableBody.appendChild(tr);

        chk.addEventListener("change", () => {
        tr.dataset.toDelete = chk.checked ? "1" : "";
        });
    });
    }


    
    async function saveSongsJson() {
      const { user, repo, branch, token } = getConfig();
      if (!token) {
        setSaveStatus("トークンを入力してください。", false);
        return;
      }

      const rows = Array.from(songsTableBody.querySelectorAll("tr"));
      const newSongs = [];
      rows.forEach((tr, i) => {
        if (tr.dataset.toDelete === "1") return;
        const s = songsData[i];
        if (!s) return;
        if (!s.title && !s.artist && !s.memo) return;
        newSongs.push(s);
      });

      const jsonText = JSON.stringify(newSongs, null, 2);
      const contentB64 = b64encodeUnicode(jsonText);

      setSaveStatus("保存中...", false);
      try {
        const res = await fetch(
          `https://api.github.com/repos/${user}/${repo}/contents/songs.json`,
          {
            method: "PUT",
            headers: {
              "Authorization": `Bearer ${token}`,
              "Accept": "application/vnd.github+json"
            },
            body: JSON.stringify({
              message: "Update songs.json from admin.html",
              content: contentB64,
              sha: currentSha,
              branch: branch
            })
          }
        );
        if (!res.ok) {
          const errData = await res.json().catch(() => ({}));
          console.error("save error:", errData);
          throw new Error("保存に失敗: " + res.status);
        }
        const result = await res.json();
        currentSha = result.content.sha;
        songsData = newSongs;
        renderSongsTable();
        setSaveStatus("保存完了！ GitHub Pages にも少し時間差で反映されます。", true);
      } catch (err) {
        console.error(err);
        setSaveStatus("保存エラー: " + err.message, false);
      }
    }

    function addSongToList() {
      const title = newTitle.value.trim();
      const artist = newArtist.value.trim();
      const category = newCategory.value;
      const memo = newMemo.value.trim();

      if (!title) {
        setAddStatus("曲名は必須です。", false);
        return;
      }

      songsData.push({ title, artist, category, memo });
      renderSongsTable();
      newTitle.value = "";
      newArtist.value = "";
      newMemo.value = "";
      setAddStatus("ローカルリストに追加しました。「変更を保存」でGitHubへ反映されます。", true);
    }
    const tableSearchInput = document.getElementById("tableSearch");
    tableSearchInput.addEventListener("input", (e) => {
        tableSearchKeyword = e.target.value;
        renderSongsTable();
        });
    btnReload.addEventListener("click", fetchSongsJson);
    btnSaveAll.addEventListener("click", saveSongsJson);
    btnAdd.addEventListener("click", addSongToList);

    // ページ表示時に自動で一度読み込む
    fetchSongsJson();
  </script>
</body>
</html>
