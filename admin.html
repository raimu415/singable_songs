<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚‰ã„ã‚€ç®¡ç†ç”»é¢ - æ­Œãˆã‚‹æ›²ãƒªã‚¹ãƒˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      padding-top: 60px; /* ä¸Šéƒ¨ã«å›ºå®šãƒœã‚¿ãƒ³ç”¨ã®ä½™ç™½ã‚’ä½œã‚‹ */
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    h1 { font-size: 1.5rem; margin: 0 0 8px; color: #60a5fa; }
    .note { font-size: 0.8rem; color: #9ca3af; margin-bottom: 12px; }

    .card {
      background: #0b1120;
      border-radius: 12px;
      padding: 16px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      margin-bottom: 16px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    /* === â˜…å¸¸ã«å³ä¸Šã«å›ºå®šã™ã‚‹ä¿å­˜ãƒ‘ãƒãƒ« === */
    .floating-save-panel {
      position: fixed;
      top: 15px;
      right: 15px;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(15, 23, 42, 0.85); /* åŠé€æ˜ */
      padding: 10px 16px;
      border-radius: 999px;
      border: 1px solid #3b82f6;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(8px);
      transition: transform 0.2s;
    }
    .floating-save-panel:hover {
      transform: translateY(2px);
    }

    label { font-size: 0.75rem; display: block; margin: 0 0 4px; color: #94a3b8; }

    input[type="text"], input[type="password"], select, textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #334155;
      background: #1e293b;
      color: #f1f5f9;
      font-size: 0.9rem;
      box-sizing: border-box;
      transition: border-color 0.2s;
    }
    input:focus, select:focus, textarea:focus {
      outline: none; border-color: #60a5fa; background: #0f172a;
    }

    textarea { min-height: 60px; resize: vertical; }

    button {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      background: #334155;
      color: #e5e7eb;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover { background: #475569; }

    /* ä¿å­˜ãƒœã‚¿ãƒ³ï¼ˆç›®ç«‹ã¤ã‚ˆã†ã«ï¼‰ */
    button.save-btn {
      background: linear-gradient(135deg,#2563eb,#06b6d4);
      color: white;
      padding: 10px 24px;
      border-radius: 999px;
      box-shadow: 0 0 10px rgba(37, 99, 235, 0.5);
      font-size: 0.95rem;
    }
    button.save-btn:hover { opacity: 0.9; box-shadow: 0 0 15px rgba(37, 99, 235, 0.8); }

    button.primary {
      background: linear-gradient(135deg,#3b82f6,#06b6d4);
      color: white;
    }

    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; }
    .row > div { flex: 1; min-width: 140px; }

    .status { font-size: 0.85rem; font-weight: bold; }
    .status.ok { color: #4ade80; }
    .status.err { color: #f87171; }

    /* ãƒ†ãƒ¼ãƒ–ãƒ«ã¾ã‚ã‚Š */
    .table-wrap {
      margin-top: 10px;
      overflow-x: auto;
      border: 1px solid #334155;
      border-radius: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      min-width: 800px;
    }
    th, td {
      border-bottom: 1px solid #1e293b;
      padding: 8px;
      vertical-align: top;
    }
    th {
      background: #0f172a;
      position: sticky;
      top: 0;
      z-index: 5;
      color: #94a3b8;
      font-weight: 600;
      text-align: left;
    }
    tbody tr:nth-child(even) { background: rgba(30, 41, 59, 0.3); }
    tbody tr:hover { background: rgba(59, 130, 246, 0.1); }

    .small-input {
      background: transparent;
      border: 1px solid transparent;
      padding: 4px;
      font-size: 0.85rem;
    }
    .small-input:focus {
      background: #0f172a;
      border-color: #60a5fa;
    }
    
    .checkbox-center { text-align: center; vertical-align: middle; }
    input[type="checkbox"] { transform: scale(1.2); cursor: pointer; }

    .flex-between { display: flex; justify-content: space-between; align-items: center; }

    /* ã‚¹ãƒãƒ›å¯¾å¿œ */
    @media screen and (max-width: 768px) {
      .floating-save-panel {
        top: auto; bottom: 20px; right: 20px; /* ã‚¹ãƒãƒ›ãªã‚‰å³ä¸‹ã®æ–¹ãŒæŠ¼ã—ã‚„ã™ã„ã‹ã‚‚ï¼Ÿä¸€æ—¦å³ä¸Šç¶­æŒãªã‚‰ã“ã“ã¯ã„ã‚‰ãªã„ */
      }
    }

  </style>
</head>
<body>

<div class="floating-save-panel">
  <div id="saveStatus" class="status"></div>
  <button class="save-btn" id="btnSaveAll">ğŸ’¾ å¤‰æ›´ã‚’GitHubã«ä¿å­˜</button>
</div>

<div class="container">
  <h1>ã‚‰ã„ã‚€ç®¡ç†ç”»é¢ ğŸ§</h1>
  
  <div class="card">
    <h2 style="font-size:1rem;margin:0 0 10px; border-bottom:1px solid #334155; padding-bottom:5px;">1. GitHubè¨­å®š</h2>
    <div class="row">
      <div>
        <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
        <input type="text" id="ghUser" value="raimu415" />
      </div>
      <div>
        <label>ãƒªãƒã‚¸ãƒˆãƒªå</label>
        <input type="text" id="ghRepo" value="singable_songs" />
      </div>
      <div>
        <label>ãƒ–ãƒ©ãƒ³ãƒ</label>
        <input type="text" id="ghBranch" value="main" />
      </div>
    </div>
    <div style="margin-top:12px;">
      <label>Personal Access Token (PAT)</label>
      <input type="password" id="ghToken" placeholder="ghp_xxxxxxxxxxxx" />
      <div style="margin-top:6px;">
        <label style="display:inline-flex; align-items:center; gap:6px; cursor:pointer;">
          <input type="checkbox" id="saveTokenCheck"> ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã™ã‚‹ï¼ˆæ¬¡å›ã‹ã‚‰å…¥åŠ›ä¸è¦ï¼‰
        </label>
      </div>
    </div>
  </div>

  <div class="card">
    <h2 style="font-size:1rem;margin:0 0 10px; border-bottom:1px solid #334155; padding-bottom:5px;">2. æ–°ã—ã„æ›²ã‚’è¿½åŠ </h2>
    <div class="row">
      <div style="flex: 2;">
        <label>æ›²å <span style="color:#f87171">*</span></label>
        <input type="text" id="newTitle" placeholder="æ›²åã‚’å…¥åŠ›" />
      </div>
      <div style="flex: 2;">
        <label>ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ</label>
        <input type="text" id="newArtist" placeholder="æ­Œæ‰‹å" />
      </div>
      <div style="flex: 1;">
        <label>ã‚«ãƒ†ã‚´ãƒª</label>
        <select id="newCategory">
          <option value="jpop">J-POP</option>
          <option value="anime">ã‚¢ãƒ‹ã‚½ãƒ³/ã‚²ãƒ¼ã‚½ãƒ³</option>
          <option value="vocaloid">ãƒœã‚«ãƒ­</option>
          <option value="other">ãã®ä»–</option>
          <option value="ng">NG</option>
          <option value="training">ç·´ç¿’ä¸­</option>
          <option value="acoustic">å¼¾ãèªã‚Š</option>
        </select>
      </div>
    </div>
    
    <div style="margin-top:10px;">
      <label>YouTube URL (ä»»æ„)</label>
      <input type="text" id="newUrl" placeholder="https://www.youtube.com/watch?v=..." />
    </div>

    <div style="margin-top:10px;">
      <label>ãƒ¡ãƒ¢ (ã‚­ãƒ¼æƒ…å ±ã€ç·´ç¿’ä¸­ã€NGãªã©)</label>
      <textarea id="newMemo" placeholder="ä¾‹ï¼šã‚­ãƒ¼+2ã€ç·´ç¿’ä¸­ã€äºŒåº¦ã¨æ­Œã„ãŸããªã„"></textarea>
    </div>

    <div class="flex-between" style="margin-top:12px;">
      <div id="addStatus" class="status"></div>
      <button class="primary" id="btnAdd">ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
    </div>
  </div>


  <div class="card">
    <div class="flex-between">
      <h2 style="font-size:1rem;margin:0;">3. ç·¨é›†ãƒªã‚¹ãƒˆ</h2>
      <button id="btnReload">å†èª­ã¿è¾¼ã¿</button>
    </div>

    <div style="margin-top:10px;">
      <input type="text" id="tableSearch" placeholder="ğŸ” ãƒªã‚¹ãƒˆå†…ã‚’æ¤œç´¢..." style="padding:10px;" />
    </div>

    <div id="listStatus" class="status"></div>

    <div class="table-wrap">
      <table id="songsTable">
        <thead>
          <tr>
            <th style="width:20%">æ›²å</th>
            <th style="width:15%">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ</th>
            <th style="width:10%">ã‚«ãƒ†ã‚´ãƒª</th>
            <th style="width:20%">URL (YouTube)</th>
            <th style="width:25%">ãƒ¡ãƒ¢</th>
            <th style="width:5%;text-align:center;">å‰Šé™¤</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>


<script>
  // ==========================================
  //  ç®¡ç†ç”»é¢ãƒ­ã‚¸ãƒƒã‚¯
  // ==========================================

  // è¦ç´ å–å¾—
  const els = {
    ghUser: document.getElementById("ghUser"),
    ghRepo: document.getElementById("ghRepo"),
    ghBranch: document.getElementById("ghBranch"),
    ghToken: document.getElementById("ghToken"),
    saveTokenCheck: document.getElementById("saveTokenCheck"),
    
    newTitle: document.getElementById("newTitle"),
    newArtist: document.getElementById("newArtist"),
    newCategory: document.getElementById("newCategory"),
    newUrl: document.getElementById("newUrl"),
    newMemo: document.getElementById("newMemo"),
    btnAdd: document.getElementById("btnAdd"),
    
    tableSearch: document.getElementById("tableSearch"),
    tableBody: document.querySelector("#songsTable tbody"),
    btnReload: document.getElementById("btnReload"),
    btnSaveAll: document.getElementById("btnSaveAll"), // å³ä¸Šãƒœã‚¿ãƒ³
    
    listStatus: document.getElementById("listStatus"),
    addStatus: document.getElementById("addStatus"),
    saveStatus: document.getElementById("saveStatus"), // å³ä¸Šã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  };

  let songsData = [];
  let currentSha = null;
  let tableSearchKeyword = "";

  // ãƒ­ã‚°å‡ºåŠ›
  function log(msg, isError = false) {
    console.log(msg);
    if (els.listStatus) {
      els.listStatus.textContent = msg;
      els.listStatus.className = isError ? "status err" : "status";
    }
  }

  // åˆæœŸåŒ–
  window.addEventListener("DOMContentLoaded", () => {
    const savedToken = localStorage.getItem("ghToken_admin");
    if (savedToken) {
      els.ghToken.value = savedToken;
      els.saveTokenCheck.checked = true;
      setTimeout(fetchSongsJson, 500);
    }
  });

  function getConfig() {
    return {
      user: els.ghUser.value.trim(),
      repo: els.ghRepo.value.trim(),
      branch: els.ghBranch.value.trim(),
      token: els.ghToken.value.trim()
    };
  }

  function b64encodeUnicode(str) { return btoa(unescape(encodeURIComponent(str))); }
  function b64decodeUnicode(str) { return decodeURIComponent(escape(atob(str))); }

  // â–  æ›²ãƒªã‚¹ãƒˆå–å¾—
  async function fetchSongsJson() {
    const { user, repo, branch, token } = getConfig();
    if (!token) return log("ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", true);

    log(`èª­ã¿è¾¼ã¿ä¸­...`);
    els.tableBody.innerHTML = "";

    try {
      const url = `https://api.github.com/repos/${user}/${repo}/contents/songs.json?ref=${branch}&_t=${Date.now()}`;
      const res = await fetch(url, {
        headers: { "Authorization": `Bearer ${token}`, "Accept": "application/vnd.github+json" }
      });

      if (!res.ok) throw new Error(`èª­è¾¼ã‚¨ãƒ©ãƒ¼: ${res.status}`);

      const data = await res.json();
      currentSha = data.sha;
      const rawContent = b64decodeUnicode(data.content);
      
      try {
        songsData = JSON.parse(rawContent);
      } catch (e) { throw new Error("JSONå½¢å¼ã‚¨ãƒ©ãƒ¼"); }

      if (!Array.isArray(songsData)) songsData = [];

      // ãƒ‡ãƒ¼ã‚¿è£œå®Œ
      songsData = songsData.map(s => ({ 
        title: s.title || "",
        artist: s.artist || "",
        category: s.category || "other",
        url: s.url || "",
        memo: s.memo || ""
      }));

      renderSongsTable();
      log(`å®Œäº†ï¼š${songsData.length} ä»¶`);
      els.listStatus.className = "status ok";

    } catch (err) {
      log(err.message, true);
    }
  }

  // â–  ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
  function renderSongsTable() {
    els.tableBody.innerHTML = "";

    const filtered = songsData.map((song, index) => ({ song, index })).filter(({ song }) => {
      const text = `${song.title} ${song.artist} ${song.category} ${song.memo}`.toLowerCase();
      return text.includes(tableSearchKeyword.toLowerCase());
    });

    filtered.forEach(({ song, index }) => {
      const tr = document.createElement("tr");
      tr.dataset.id = index;
      
      const createInput = (key) => {
        const td = document.createElement("td");
        const input = document.createElement("input");
        input.type = "text"; input.value = song[key] || ""; input.className = "small-input";
        input.oninput = () => { songsData[index][key] = input.value; };
        td.appendChild(input); return td;
      };

      tr.appendChild(createInput("title"));
      tr.appendChild(createInput("artist"));

      const tdCat = document.createElement("td");
      const sel = document.createElement("select");
      sel.className = "small-input";
      ["jpop","anime","vocaloid","other","ng","training","acoustic"].forEach(c => {
        const opt = document.createElement("option"); opt.value = c; opt.textContent = c;
        if(song.category === c) opt.selected = true; sel.appendChild(opt);
      });
      sel.onchange = () => { songsData[index].category = sel.value; };
      tdCat.appendChild(sel); tr.appendChild(tdCat);

      tr.appendChild(createInput("url"));

      const tdMemo = document.createElement("td");
      const area = document.createElement("textarea");
      area.value = song.memo || ""; area.className = "small-input"; area.style.height = "34px"; 
      area.onfocus = () => area.style.height = "80px"; area.onblur = () => area.style.height = "34px";
      area.oninput = () => { songsData[index].memo = area.value; };
      tdMemo.appendChild(area); tr.appendChild(tdMemo);

      const tdDel = document.createElement("td"); tdDel.className = "checkbox-center";
      const chk = document.createElement("input"); chk.type = "checkbox";
      chk.onchange = () => {
        tr.style.opacity = chk.checked ? "0.3" : "1";
        tr.style.background = chk.checked ? "#450a0a" : "";
        tr.dataset.toDelete = chk.checked ? "1" : "";
      };
      tdDel.appendChild(chk); tr.appendChild(tdDel);

      els.tableBody.appendChild(tr);
    });
  }

  // â–  GitHubã¸ä¿å­˜
  async function saveSongsJson() {
    const { user, repo, branch, token } = getConfig();
    if (els.saveTokenCheck.checked) localStorage.setItem("ghToken_admin", token);
    else localStorage.removeItem("ghToken_admin");

    if (!token) return alert("ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“");

    els.saveStatus.textContent = "ä¿å­˜ä¸­...";
    els.saveStatus.className = "status";
    els.saveStatus.style.color = "#fff";

    const newSongs = [];
    const rows = Array.from(els.tableBody.querySelectorAll("tr"));
    songsData.forEach((s, i) => {
      const row = rows.find(r => Number(r.dataset.id) === i);
      if (row && row.dataset.toDelete === "1") return;
      newSongs.push(s);
    });

    try {
      const contentB64 = b64encodeUnicode(JSON.stringify(newSongs, null, 2));
      const res = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/songs.json`, {
        method: "PUT",
        headers: { "Authorization": `Bearer ${token}`, "Accept": "application/vnd.github+json" },
        body: JSON.stringify({
          message: "Update via Admin Panel",
          content: contentB64,
          sha: currentSha,
          branch
        })
      });

      if (!res.ok) throw new Error(`ä¿å­˜å¤±æ•—: ${res.status}`);
      const result = await res.json();
      currentSha = result.content.sha;
      songsData = newSongs;
      renderSongsTable();
      
      els.saveStatus.textContent = "ä¿å­˜ã—ã¾ã—ãŸï¼";
      els.saveStatus.className = "status ok";
      setTimeout(() => els.saveStatus.textContent = "", 3000); // 3ç§’å¾Œã«æ¶ˆã™

    } catch (err) {
      els.saveStatus.textContent = "ã‚¨ãƒ©ãƒ¼ï¼";
      els.saveStatus.className = "status err";
      alert(err.message);
    }
  }

  // â–  è¿½åŠ 
  function addSongToList() {
    const title = els.newTitle.value.trim();
    if (!title) return alert("æ›²åã‚’å…¥ã‚Œã¦ãã ã•ã„");
    songsData.push({
      title, artist: els.newArtist.value.trim(), category: els.newCategory.value,
      url: els.newUrl.value.trim(), memo: els.newMemo.value.trim()
    });
    els.newTitle.value = ""; els.newArtist.value = ""; els.newUrl.value = ""; els.newMemo.value = ""; els.newTitle.focus();
    renderSongsTable();
    
    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    els.addStatus.textContent = "ãƒªã‚¹ãƒˆã«è¿½åŠ (æœªä¿å­˜)";
    setTimeout(() => {
        const tableWrap = document.querySelector(".table-wrap");
        if(tableWrap) tableWrap.scrollTop = tableWrap.scrollHeight;
    }, 100);
  }

  els.tableSearch.oninput = (e) => { tableSearchKeyword = e.target.value; renderSongsTable(); };
  els.btnReload.onclick = fetchSongsJson;
  els.btnSaveAll.onclick = saveSongsJson;
  els.btnAdd.onclick = addSongToList;

</script>

</body>
</html>